


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/log/log-03-2018/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.2">
    
    
      
        <title>March 2018 - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a2408e81.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CCourier+Prime&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Courier Prime",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#march-2018" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Yizhou Shan's Home Page
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              March 2018
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/source_code/summary/" class="md-tabs__link">
          Code Study
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/hardware_pl/" class="md-tabs__link">
          Tech Note
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/paper_fpga/" class="md-tabs__link">
          About FPGA
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../blog/20200404-on-read-once/" class="md-tabs__link">
          Random
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../kernel/boot/" class="md-tabs__link">
          LegoOS
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Code Study
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Code Study" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Code Study
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Guideline & Advice" class="md-nav__link">
      Guideline & Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/os/" title="OS" class="md-nav__link">
      OS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/virt/" title="Virtualization" class="md-nav__link">
      Virtualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/rdma/" title="RDMA/DPDK" class="md-nav__link">
      RDMA/DPDK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/20200501-on-graphic-softwares/" title="Graphics" class="md-nav__link">
      Graphics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/firmware-softwares/" title="BootLoader/Firmware" class="md-nav__link">
      BootLoader/Firmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/gpu/" title="GPU" class="md-nav__link">
      GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/fpga/" title="FPGA" class="md-nav__link">
      FPGA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/dotconfigs/" title="Dot Configs" class="md-nav__link">
      Dot Configs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/misc/" title="Misc" class="md-nav__link">
      Misc
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tech Note
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tech Note" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tech Note
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/hardware_pl/" title="Hardware-Design-Languages" class="md-nav__link">
      Hardware-Design-Languages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="FPGA-Paper-Reading" class="md-nav__link">
      FPGA-Paper-Reading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="x86-Ring-Switch-Overhead" class="md-nav__link">
      x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux-Trace-and-Profile" class="md-nav__link">
      Linux-Trace-and-Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux-Reverse-Map(rmap)" class="md-nav__link">
      Linux-Reverse-Map(rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux-Userfaultfd" class="md-nav__link">
      Linux-Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux-Cgroup-and-Swap" class="md-nav__link">
      Linux-Cgroup-and-Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux-Special-Files" class="md-nav__link">
      Linux-Special-Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-resource/" title="Linux-Resource" class="md-nav__link">
      Linux-Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux-KVM" class="md-nav__link">
      Linux-KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      About FPGA
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="About FPGA" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        About FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="FPGA-Paper-Reading" class="md-nav__link">
      FPGA-Paper-Reading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/language/" title="Language" class="md-nav__link">
      Language
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous Partial Reconfiguration" class="md-nav__link">
      Morphous Partial Reconfiguration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Notes" class="md-nav__link">
      Vivado Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/setup_hold/" title="Setup and Hold Time" class="md-nav__link">
      Setup and Hold Time
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Random
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Random" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Random
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      LegoOS
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="LegoOS" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      Kernel
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Kernel" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      Syscall
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Syscall" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3">
    
    <label class="md-nav__link" for="nav-6-3">
      Pcache
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Pcache" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-4" type="checkbox" id="nav-6-4">
    
    <label class="md-nav__link" for="nav-6-4">
      Driver
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Driver" data-md-level="2">
      <label class="md-nav__title" for="nav-6-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-5" type="checkbox" id="nav-6-5">
    
    <label class="md-nav__link" for="nav-6-5">
      Paper
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Paper" data-md-level="2">
      <label class="md-nav__title" for="nav-6-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0331-sat" class="md-nav__link">
    03/31 Sat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0330-fri" class="md-nav__link">
    03/30 Fri
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0326-mon" class="md-nav__link">
    03/26 Mon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0322-thur" class="md-nav__link">
    03/22 Thur
  </a>
  
    <nav class="md-nav" aria-label="03/22 Thur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clear-registers-for-execve" class="md-nav__link">
    Clear Registers for execve()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0321-wed" class="md-nav__link">
    03/21 Wed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0320-tue" class="md-nav__link">
    03/20 Tue
  </a>
  
    <nav class="md-nav" aria-label="03/20 Tue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ib-bug-again" class="md-nav__link">
    IB Bug again
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0319-mon" class="md-nav__link">
    03/19 Mon
  </a>
  
    <nav class="md-nav" aria-label="03/19 Mon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#random-ib-bug" class="md-nav__link">
    Random IB Bug
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0318-sun" class="md-nav__link">
    03/18 Sun
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0317-sat" class="md-nav__link">
    03/17 Sat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0316-friday" class="md-nav__link">
    03/16 Friday
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0315-thur" class="md-nav__link">
    03/15 Thur
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0313-wed" class="md-nav__link">
    03/13 Wed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0312-tue" class="md-nav__link">
    03/12 Tue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0311-mon" class="md-nav__link">
    03/11 Mon
  </a>
  
    <nav class="md-nav" aria-label="03/11 Mon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#debug-victim-cache" class="md-nav__link">
    Debug victim cache
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0310-sun" class="md-nav__link">
    03/10 Sun
  </a>
  
    <nav class="md-nav" aria-label="03/10 Sun">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fix-bug-from-__unhash_procees" class="md-nav__link">
    Fix bug from __unhash_procees()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#victim-report-error" class="md-nav__link">
    victim report error
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0310-sat" class="md-nav__link">
    03/10 Sat
  </a>
  
    <nav class="md-nav" aria-label="03/10 Sat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#put_pcache-in-pcache_zap_pte" class="md-nav__link">
    put_pcache in pcache_zap_pte
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python-hello-world-run-to-end" class="md-nav__link">
    python hello world run to end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trying-phoenix-pthread-again" class="md-nav__link">
    Trying phoenix pthread again
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0309-fri" class="md-nav__link">
    03/09 Fri
  </a>
  
    <nav class="md-nav" aria-label="03/09 Fri">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-bug-in-kmalloc" class="md-nav__link">
    Find bug in kmalloc
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0308-thur" class="md-nav__link">
    03/08 Thur
  </a>
  
    <nav class="md-nav" aria-label="03/08 Thur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    python
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0302-fri" class="md-nav__link">
    03/02 Fri
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0301-thur" class="md-nav__link">
    03/01 Thur
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="march-2018">March 2018<a class="headerlink" href="#march-2018" title="Permanent link">&para;</a></h1>
<h2 id="0331-sat">03/31 Sat<a class="headerlink" href="#0331-sat" title="Permanent link">&para;</a></h2>
<p>Stay humble. Be real.</p>
<h2 id="0330-fri">03/30 Fri<a class="headerlink" href="#0330-fri" title="Permanent link">&para;</a></h2>
<p>Our scheduling, or IB do have issues. I must revisit this.</p>
<p>The case is: in P, we boot only 12 cores, and three of them are used by flush, sweep, and IB. So there are 9 cores left for user. Phoenix create 24 threads. During the run, a lot ib timeout will happen. If we have a good scheduling, this should never happen. I probably need to check more on this.</p>
<p>Anyway. Today I reorganized the opcode things. And now I&rsquo;m adding the final large piece of Lego: replication. It should be much simpler than the pcache part. I will first write down what code I need to add, e.g., opcode, handler, buffer mgmt etc.</p>
<p>End of day. Want to write down some simple thoughts on building system. Building system is fun, but you have to know that devil is in the details. And, you may end up debugging for many many hours on a very very little issue. But that is how it is. Building system does not mean you are always working on fantastic beautiful ideas. It is always about those little bugs, little things, trivial fixes, that make your system robust and usable. For example, the patch Yilun sent me today is about handling special cases of stat and lseek. The patch does not improve any performance or adding fancy features, it is a minor fix to make user progam run. But this enable us to run TF. I think it is a great patch and it stands for 90% of building systems in middle or late stage.</p>
<p>Of course, there are other trivial things on building systems: 1) initialize every possible used variables, can be local variables, malloced buffers. 2) have decent cleanup, which is a counterpart of your initialization, like dequeue list, decrease counter etc. 3) Clear coding style, write code for others, for yourself when you read the code two weeks later. This one is hard, need experience. But can be learned. I think Yilun and Yutong both improved a lot during this project. Me? I learned this from NVM emulator protect. It is a painful one, but also a valuable one. 4) Decent protect source file organization. 5) Remember, draw, the connections between subsystems. By adding this new feature to this subsystem A, will it broke subsystem B, which is using subsystem A. Something like this. 6) clear mind on lock usage, multithread issue. This is the most difficult one. I would say I learned this by coding pcache, or mm. I would say, mm is the most difficult multithread issue one can encounter.</p>
<h2 id="0326-mon">03/26 Mon<a class="headerlink" href="#0326-mon" title="Permanent link">&para;</a></h2>
<p>Spent several days on replication design. Now I&rsquo;m back on coding and debuging track.</p>
<p>Fixed a bug introduced by per-pte lock. A one hided by previous one big giant page table lock.</p>
<p>Also add an option to boot socket 0 only if Processor is configured. This is because pcache is normally registered at socket 0, if we schedule user threads to sockets other than socket 0, that will have bad performance.</p>
<h2 id="0322-thur">03/22 Thur<a class="headerlink" href="#0322-thur" title="Permanent link">&para;</a></h2>
<h3 id="clear-registers-for-execve">Clear Registers for execve()<a class="headerlink" href="#clear-registers-for-execve" title="Permanent link">&para;</a></h3>
<p>Want to figure out execve problem today.</p>
<ol>
<li>Check if pcache is clean after process_exit.</li>
<li>Check if pgtable is clean.</li>
</ol>
<p>Well. Checked, both are clean.</p>
<p>The bug looks like the return of main, evevntually does not go to library&rsquo;s exit. Is it because library pages are not loaded properly? Since the number of pgfault equals to normal setting, I guess it may originate from Memory side.</p>
<p>TLB is also flushed, so TLB should not be a hidden issue.</p>
<p>Going to check checsum. Well, checsum is okay too.</p>
<p>Syscall execve will change ip, sp, flags registers. So it will use <code>iretq</code> instead of <code>sysexit</code> to return to userspace.</p>
<p>Got an insteresting IB bug after execve. The CPU5 seems fail to return to userspace, and the CPU0 has the IB bug followed:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1201.940681</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">seq</span><span class="p">.</span><span class="n">o</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">609</span>
<span class="p">[</span> <span class="mf">1202.006200</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0033</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="mo">0000000000401</span><span class="n">d1d</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="mo">0000000000401</span><span class="n">d1d</span><span class="o">&gt;</span><span class="p">]</span> <span class="mh">0x401d1d</span>
<span class="p">[</span> <span class="mf">1202.087320</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">002</span><span class="nl">b</span><span class="p">:</span><span class="mf">00007ff</span><span class="n">fffffedb0</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00000200</span>
<span class="p">[</span> <span class="mf">1202.150760</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="mf">00000000004002e0</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">000000000043</span><span class="n">b2c7</span>
<span class="p">[</span> <span class="mf">1202.236041</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fffffedc8</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fffffeb40</span> <span class="nl">RDI</span><span class="p">:</span> <span class="mf">000000000048f9f</span><span class="mi">0</span>
<span class="p">[</span> <span class="mf">1202.321320</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fffffeb60</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">00000000006</span><span class="n">ba4a0</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">00000000006</span><span class="n">bc880</span>
<span class="p">[</span> <span class="mf">1202.406601</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mf">000000000000000f</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000246</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1202.491881</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="mo">0000000000401</span><span class="mi">930</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">0000000000401</span><span class="mi">9</span><span class="n">c0</span> <span class="nl">R15</span><span class="p">:</span> <span class="mo">0000000000000006</span>
<span class="p">[</span> <span class="mf">1202.577161</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88207fc40000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1202.673880</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span> <span class="mf">1202.742521</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">000000000042</span><span class="n">c9a0</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mf">000000207f</span><span class="n">c2f000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>

<span class="p">[</span> <span class="mf">1220.465601</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000020</span>
<span class="p">[</span> <span class="mf">1220.557225</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810591ef</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0x6f</span><span class="o">/</span><span class="mh">0x7c0</span>
<span class="p">[</span> <span class="mf">1220.638344</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1220.662265</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span> <span class="mf">1220.710105</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">27</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">ib_mad_completi</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">609</span>
<span class="p">[</span> <span class="mf">1220.786025</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810591ef</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810591ef</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0x6f</span><span class="o">/</span><span class="mh">0x7c0</span>
<span class="p">[</span> <span class="mf">1220.896265</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88103eea7e30</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010246</span>
<span class="p">[</span> <span class="mf">1220.959704</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88103eeac728</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000001</span>
<span class="p">[</span> <span class="mf">1221.044985</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">000000002</span><span class="mi">8000000</span> <span class="nl">RSI</span><span class="p">:</span> <span class="n">ffff88103ee8f000</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffff88107ff841d8</span>
<span class="p">[</span> <span class="mf">1221.130265</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88103eea7ec0</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="n">ffff88103eea03c0</span>
<span class="p">[</span> <span class="mf">1221.215545</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="n">ffff88103eea7ea0</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000001</span> <span class="nl">R12</span><span class="p">:</span> <span class="n">ffff88103ee8c3f0</span>
<span class="p">[</span> <span class="mf">1221.300825</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88103ee8c4e8</span> <span class="nl">R14</span><span class="p">:</span> <span class="n">ffff88103eeac620</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88103eeac5f8</span>
<span class="p">[</span> <span class="mf">1221.386106</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc00000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1221.482825</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span> <span class="mf">1221.551466</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000020</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">b0</span>
<span class="p">[</span> <span class="mf">1221.636746</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1221.660666</span><span class="p">]</span> <span class="n">ffff88103eeaac10</span> <span class="n">ffff881000000001</span> <span class="n">ffff88103eeaac10</span> <span class="n">ffff88103eeaab50</span>
<span class="p">[</span> <span class="mf">1221.748026</span><span class="p">]</span> <span class="n">ffff88107fc05d80</span> <span class="n">ffff88103eea0000</span> <span class="n">ffff88103eeac728</span> <span class="mo">000000</span><span class="mi">8000000000</span>
<span class="p">[</span> <span class="mf">1221.835386</span><span class="p">]</span> <span class="mo">0000012</span><span class="mi">83</span><span class="n">eea7ea8</span> <span class="n">ffff88103ee8c9a8</span> <span class="mf">000000007f</span><span class="n">cf2000</span> <span class="n">ffff000000000000</span>
<span class="p">[</span> <span class="mf">1221.922746</span><span class="p">]</span> <span class="n">ffff88107fcf0000</span> <span class="n">ffff88207ff6cbd8</span> <span class="n">ffff88107fcf76e8</span> <span class="n">ffff88103ee8c3f0</span>
<span class="p">[</span> <span class="mf">1222.010106</span><span class="p">]</span> <span class="n">ffffffff81059180</span> <span class="mo">0000000000000000</span> <span class="n">ffff88103eea7f48</span> <span class="n">ffffffff81020866</span>
<span class="p">[</span> <span class="mf">1222.097466</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1222.126586</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1222.149466</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81059180</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">ib_mad_send_done_handler</span><span class="p">.</span><span class="n">isra</span><span class="mf">.21</span><span class="o">+</span><span class="mh">0x1d0</span><span class="o">/</span><span class="mh">0x1d0</span>
<span class="p">[</span> <span class="mf">1222.236826</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020866</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span> <span class="mf">1222.295066</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020770</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1222.363707</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4b2</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="nl">wuklab12</span><span class="p">:</span> <span class="n">LegoOS</span> <span class="nl">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)]</span> <span class="err">$</span> <span class="n">addr2line</span> <span class="o">-</span><span class="n">e</span> <span class="n">vmImage</span>  <span class="o">-</span><span class="n">i</span> <span class="n">ffffffff810591ef</span>
<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">infiniband</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">mad</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">1899</span>
<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">infiniband</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">mad</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">2324</span>

<span class="n">It</span> <span class="n">is</span> <span class="n">ib_mad_recv_done_handler</span><span class="p">()</span>
</code></pre></div>

<p>Well&hellip;</p>
<p>Eventually, at 22:09, I figured out..</p>
<p>After I cleaned up all registers (except IP, SP, CS, SS, FLAGS) within start_thread, the execve&rsquo;ed program can run to end successfully.</p>
<p>I did not clear the registers because linux does not clear it. I thought this is fine. Glibc should clear it anyway, right?</p>
<p>But anyway, this works.</p>
<h2 id="0321-wed">03/21 Wed<a class="headerlink" href="#0321-wed" title="Permanent link">&para;</a></h2>
<ul>
<li>Task 1: add some checking in ib, flush, sweep thread. 1) If cpu changed, 2) if nr_threads on this core &gt; 1.</li>
</ul>
<p>Had an issue while testing: execve(). I ran a exec.o first, then do execve to run seq.o:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0321</span><span class="o">-</span><span class="mi">10</span>
<span class="p">[</span>  <span class="mf">970.380252</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">uname</span><span class="p">()</span><span class="o">:</span>

<span class="o">---</span>
<span class="p">[</span>  <span class="mf">970.431212</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x44605d</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">1101.862429</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span> <span class="mf">1101.915570</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1101.969649</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span> <span class="mf">1102.029968</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1102.084046</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1102.138125</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1102.192203</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1054</span>
<span class="p">[</span> <span class="mf">1102.256681</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1055</span>
<span class="p">[</span> <span class="mf">1102.321160</span><span class="p">]</span> <span class="nl">csum</span><span class="p">:</span> <span class="mi">442</span><span class="n">a97c0</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="nl">csum</span><span class="p">:</span> <span class="mi">2</span><span class="n">d352c33</span>
<span class="p">[</span> <span class="mf">1102.377319</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span> <span class="mf">1102.444916</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff880180011180</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">1</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff880100446000</span>
<span class="p">[</span> <span class="mf">1102.558273</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1056</span>
<span class="p">[</span> <span class="mf">1102.622751</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">csum</span> <span class="n">mismatch</span>
<span class="p">[</span> <span class="mf">1102.677871</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">1102.749627</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">1102.804746</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1057</span>
<span class="p">[</span> <span class="mf">1102.869225</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">fault</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">237</span><span class="o">/</span><span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1102.968022</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">1103.039780</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1103.090739</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">seq</span><span class="p">.</span><span class="n">o</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">599</span>
<span class="p">[</span> <span class="mf">1103.156256</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1103.180177</span><span class="p">]</span> <span class="n">ffff88103e85be18</span> <span class="n">ffffffff8102676c</span> <span class="n">ffffffff00000008</span> <span class="n">ffff88103e85be28</span>
<span class="p">[</span> <span class="mf">1103.267533</span><span class="p">]</span> <span class="n">ffff88103e85bde0</span> <span class="mo">0000000021475542</span> <span class="mo">00000000000002</span><span class="mi">96</span> <span class="n">ffff88103e85ba10</span>
<span class="p">[</span> <span class="mf">1103.354892</span><span class="p">]</span> <span class="n">ffffffff810195c5</span> <span class="n">ffff88207fc44980</span> <span class="mo">0000000000000005</span> <span class="n">ffff88103e85ba28</span>
<span class="p">[</span> <span class="mf">1103.442249</span><span class="p">]</span> <span class="n">ffffffff81016c75</span> <span class="n">ffff88103e85ba40</span> <span class="n">ffff88103e85ba50</span> <span class="n">ffffffff810065d4</span>
<span class="p">[</span> <span class="mf">1103.529607</span><span class="p">]</span> <span class="n">ffffffff811d36e0</span> <span class="mo">000000000000003</span><span class="mi">9</span> <span class="n">ffffffff81081718</span> <span class="n">ffff88103e85bb80</span>
<span class="p">[</span> <span class="mf">1103.616964</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
</code></pre></div></p>
<h2 id="0320-tue">03/20 Tue<a class="headerlink" href="#0320-tue" title="Permanent link">&para;</a></h2>
<ul>
<li>Task 1: calculate failure numbers</li>
<li>Task 2: read 0319-4 Log</li>
<li>Task 3: opt pte lock</li>
</ul>
<p>Hmm, I finished the per-pte per-pmd lock patch. I think it works.
But I do found an issue. When I run MT+2GB, it will create 24 threads. Since I marked 3 CPUs inactive, so all new 24 threads will be scheduled to other cores (I may need to check this!). At some point, Lego P either stuck, or a lot ibapi_send_reply timeout.</p>
<p>When I change the cpu_online to may <code>0-6</code>, it finished. When I change it to <code>0-18</code>, also succeed. I really doubt if actually those pinned threads are not pinned. Need to check.</p>
<h3 id="ib-bug-again">IB Bug again<a class="headerlink" href="#ib-bug-again" title="Permanent link">&para;</a></h3>
<p>Running MT-phoenix, 2GB, somehow crashed in the middle:
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mf">60095.857381</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">CPU6</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">33</span> <span class="p">[</span><span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">stat</span><span class="p">]</span>

<span class="p">[</span><span class="mf">60286.127359</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span><span class="mf">60286.180503</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.234582</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span><span class="mf">60286.294903</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.348981</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.403062</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.457141</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.511221</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.570500</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1056</span>
<span class="p">[</span><span class="mf">60286.634980</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.689059</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1057</span>
<span class="p">[</span><span class="mf">60286.753539</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.812819</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1058</span>
<span class="p">[</span><span class="mf">60286.877298</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60286.931378</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1059</span>
<span class="p">[</span><span class="mf">60286.995857</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.055138</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.109217</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.163297</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.217376</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.271456</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.325536</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.384815</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1060</span>
<span class="p">[</span><span class="mf">60287.449294</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.503375</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span><span class="mf">60287.596973</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81063ffd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4dd</span><span class="o">/</span><span class="mh">0x530</span>
<span class="p">[</span><span class="mf">60287.664574</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.723853</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">60287.747772</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.801852</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">PREEMPT</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span><span class="mf">60287.858013</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60287.917292</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">2</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">29</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">569</span>
<span class="p">[</span><span class="mf">60287.988010</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81063ffd</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81063ffd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4dd</span><span class="o">/</span><span class="mh">0x530</span>
<span class="p">[</span><span class="mf">60288.084731</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88103e84fd88</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010206</span>
<span class="p">[</span><span class="mf">60288.148170</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">000000000000100</span><span class="mi">8</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88103e848438</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000014</span>
<span class="p">[</span><span class="mf">60288.233450</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RSI</span><span class="p">:</span> <span class="n">ffffffff811d36e0</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffffffff811dac08</span>
<span class="p">[</span><span class="mf">60288.318728</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88103e84fea8</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span><span class="mf">60288.404008</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mo">0000000000000002</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span><span class="mf">60288.489288</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88207fd6e008</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88103e84fda0</span>
<span class="p">[</span><span class="mf">60288.574568</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60288.628647</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc20000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span><span class="mf">60288.725367</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span><span class="mf">60288.794006</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span><span class="mf">60288.879285</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60288.938565</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span><span class="mf">60288.962484</span><span class="p">]</span> <span class="n">ffffffff810031d9</span> <span class="mo">000</span><span class="mi">801</span><span class="n">d43e84fda0</span> <span class="mo">0000000000000007</span> <span class="mo">0000000000000424</span>
<span class="p">[</span><span class="mf">60289.049844</span><span class="p">]</span> <span class="mo">000000</span><span class="mi">8100000005</span> <span class="mf">00001008000000f</span><span class="mi">9</span> <span class="n">ffff88103e848868</span> <span class="mf">00616e6440000014</span>
<span class="p">[</span><span class="mf">60289.137204</span><span class="p">]</span> <span class="mo">0020004000000002</span> <span class="n">ffff88207fc00000</span> <span class="mo">0000000000000425</span> <span class="mo">000000</span><span class="mi">8100000005</span>
<span class="p">[</span><span class="mf">60289.224563</span><span class="p">]</span> <span class="mf">00001008000000f</span><span class="mi">9</span> <span class="n">ffff88103e848868</span> <span class="mo">007370654000000</span><span class="n">d</span> <span class="mo">0010004000000002</span>
<span class="p">[</span><span class="mf">60289.311922</span><span class="p">]</span> <span class="n">ffffffff81010000</span> <span class="mo">0000000000000426</span> <span class="mo">000000</span><span class="mi">8100000005</span> <span class="mf">00001008000000f</span><span class="mi">9</span>
<span class="p">[</span><span class="mf">60289.399282</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span><span class="mf">60289.428402</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60289.482482</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span><span class="mf">60289.505361</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810031d9</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">native_smp_send_reschedule</span><span class="o">+</span><span class="mh">0x39</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span><span class="mf">60289.584400</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60289.643680</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81010000</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__ioremap_caller</span><span class="o">+</span><span class="mh">0x170</span><span class="o">/</span><span class="mh">0x570</span>
<span class="p">[</span><span class="mf">60289.714400</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81060000</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">cm_work_handler</span><span class="o">+</span><span class="mh">0x270</span><span class="o">/</span><span class="mh">0x1450</span>
<span class="p">[</span><span class="mf">60289.785119</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064050</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x530</span><span class="o">/</span><span class="mh">0x530</span>
<span class="p">[</span><span class="mf">60289.850639</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064064</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq_pass</span><span class="o">+</span><span class="mh">0x14</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span><span class="mf">60289.917198</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020c06</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span><span class="mf">60289.975438</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">60290.029518</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020b10</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span><span class="mf">60290.098157</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e722</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
</code></pre></div></p>
<p>Uuh:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1002.803051</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1002.855153</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1002.909232</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1002.963310</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">1003.017390</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">512</span>
<span class="p">[</span> <span class="mf">1003.080829</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000200</span>
<span class="p">[</span> <span class="mf">1003.174425</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105d499</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x179</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span> <span class="mf">1003.242024</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1003.265943</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">MEMORY</span>
<span class="p">[</span> <span class="mf">1003.310661</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">2</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">29</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">149</span>
<span class="p">[</span> <span class="mf">1003.381380</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105d499</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105d499</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x179</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span> <span class="mf">1003.478098</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88104e84fd88</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010246</span>
<span class="p">[</span> <span class="mf">1003.541537</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="n">ffff880000000000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88104e848008</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">00000000000000</span><span class="mi">80</span>
<span class="p">[</span> <span class="mf">1003.626814</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">0000000000000200</span> <span class="nl">RSI</span><span class="p">:</span> <span class="n">ffffffff811c76e0</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffffffff811d0988</span>
<span class="p">[</span> <span class="mf">1003.712092</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88104e84fea8</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1003.797369</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mo">0000000000000002</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1003.882648</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88207ff75008</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88104e84fda0</span>
<span class="p">[</span> <span class="mf">1003.967925</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc20000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1004.064644</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span> <span class="mf">1004.133282</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000200</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">0000000001131000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span> <span class="mf">1004.218559</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1004.242479</span><span class="p">]</span> <span class="n">ffffffff810031a9</span> <span class="n">ffff88104e84fda0</span> <span class="n">ffffffff81018ef4</span> <span class="mo">0000000000000200</span>
<span class="p">[</span> <span class="mf">1004.329837</span><span class="p">]</span> <span class="mo">000000</span><span class="mi">8000000001</span> <span class="mo">0000004</span><span class="mi">8000000</span><span class="n">d7</span> <span class="n">ffff88104e848c98</span> <span class="mo">00000000</span><span class="mi">81019302</span>
<span class="p">[</span> <span class="mf">1004.417194</span><span class="p">]</span> <span class="mo">0014000000000000</span> <span class="n">ffff88207fc00000</span> <span class="mo">0000000000000201</span> <span class="n">ffffffff00000005</span>
<span class="p">[</span> <span class="mf">1004.504552</span><span class="p">]</span> <span class="n">ffff8810000000f9</span> <span class="n">ffff88104e848c98</span> <span class="mo">0000000000000000</span> <span class="n">ffff88104e84fe38</span>
<span class="p">[</span> <span class="mf">1004.591910</span><span class="p">]</span> <span class="n">ffffffff810195a4</span> <span class="mo">0000000000000202</span> <span class="n">ffff881000000005</span> <span class="n">ffff8810000000f9</span>
<span class="p">[</span> <span class="mf">1004.679268</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1004.708388</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1004.731267</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810031a9</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">native_smp_send_reschedule</span><span class="o">+</span><span class="mh">0x39</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span> <span class="mf">1004.810305</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81018ef4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">resched_curr</span><span class="o">+</span><span class="mh">0x34</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">1004.874783</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810195a4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">try_to_wake_up</span><span class="o">+</span><span class="mh">0xe4</span><span class="o">/</span><span class="mh">0x1f0</span>
<span class="p">[</span> <span class="mf">1004.942382</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105f458</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__schedule</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">/</span><span class="mh">0x1e0</span>
<span class="p">[</span> <span class="mf">1005.005820</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105d830</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x510</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span> <span class="mf">1005.071338</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105d844</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq_pass</span><span class="o">+</span><span class="mh">0x14</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">1005.137897</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101fdc6</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span> <span class="mf">1005.196135</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101fcd0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1005.264773</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e472</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
</code></pre></div></p>
<h2 id="0319-mon">03/19 Mon<a class="headerlink" href="#0319-mon" title="Permanent link">&para;</a></h2>
<p>Not too many days left!!! Got to design full replication mechanism and algorithm today.</p>
<p>Merged pull request for <code>pipe</code>, <code>pipe2</code> and <code>/dev/null</code> from Yilun. Our simple file op mgmt concerns me. I left a note at kernel/fork.c.</p>
<p>Got a bug report from Yilun, syscall execv failed. To be honest, I&rsquo;ve never tried this syscall, always call it directly within kernel.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">943.650712</span><span class="p">]</span> <span class="n">CPU6</span> <span class="n">PID17</span> <span class="n">sys_execve</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span>  <span class="mf">943.701899</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="n">paging</span> <span class="n">request</span> <span class="n">at</span> <span class="mo">00000000004</span><span class="mi">90523</span>
<span class="p">[</span>  <span class="mf">943.702776</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103db86</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">strrchr</span><span class="o">+</span><span class="mh">0x6</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span>  <span class="mf">943.711501</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">943.711911</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span>  <span class="mf">943.712433</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">6</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="err">#</span><span class="mi">64</span>
<span class="p">[</span>  <span class="mf">943.713126</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103db86</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103db86</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">strrchr</span><span class="o">+</span><span class="mh">0x6</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span>  <span class="mf">943.714090</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">001</span><span class="mi">8</span><span class="o">:</span><span class="n">ffff88083e4bfe98</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010246</span>
<span class="p">[</span>  <span class="mf">943.714724</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88083e4b3780</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">943.715511</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mf">00000000ff</span><span class="n">ffffff</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mf">000000000000002f</span> <span class="nl">RDI</span><span class="p">:</span> <span class="mo">00000000004</span><span class="mi">90523</span>
<span class="p">[</span>  <span class="mf">943.716297</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88083e4bfe98</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000160000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="n">ffff88083e4b8400</span>
<span class="p">[</span>  <span class="mf">943.717085</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="n">ffff880000000000</span> <span class="nl">R11</span><span class="p">:</span> <span class="mi">6</span><span class="n">db6db6db6db6db7</span> <span class="nl">R12</span><span class="p">:</span> <span class="n">ffff88083e4b8000</span>
<span class="p">[</span>  <span class="mf">943.717871</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88083e4e6290</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">00000000004</span><span class="mi">90523</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88083e4b3920</span>
<span class="p">[</span>  <span class="mf">943.718683</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88083fd80000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">943.719650</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span>  <span class="mf">943.720319</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">00000000004</span><span class="mi">90523</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mf">000000083e4</span><span class="n">e7000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span>  <span class="mf">943.721106</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">943.721459</span><span class="p">]</span> <span class="n">ffff88083e4bff18</span> <span class="n">ffffffff8102c6bf</span> <span class="n">ffff880800000000</span> <span class="mf">0000000000000e10</span>
<span class="p">[</span>  <span class="mf">943.722541</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">fffffedb0</span> <span class="mo">0000000000400</span><span class="n">d0d</span> <span class="n">ffff88083e4c0000</span> <span class="mo">00000000004</span><span class="mi">90523</span>
<span class="p">[</span>  <span class="mf">943.723624</span><span class="p">]</span> <span class="n">ffff88083e4b9008</span> <span class="mf">00007ff</span><span class="n">fffffed30</span> <span class="mo">000000</span><span class="mi">8400000084</span> <span class="n">ffff88083e4bff58</span>
<span class="p">[</span>  <span class="mf">943.724706</span><span class="p">]</span> <span class="mo">000000000000003</span><span class="n">b</span> <span class="mo">0000000000401</span><span class="mi">9</span><span class="n">d0</span> <span class="mo">0000000000401</span><span class="n">a60</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">943.725789</span><span class="p">]</span> <span class="n">ffff88083e4bff28</span> <span class="n">ffffffff8102c989</span> <span class="n">ffff88083e4bff48</span> <span class="n">ffffffff8100e5f5</span>
<span class="p">[</span>  <span class="mf">943.726870</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">943.727260</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">943.727619</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c6bf</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_execve</span><span class="o">+</span><span class="mh">0x4af</span><span class="o">/</span><span class="mh">0x770</span>
<span class="p">[</span>  <span class="mf">943.728236</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c989</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_execve</span><span class="o">+</span><span class="mh">0x9</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span>  <span class="mf">943.728868</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e5f5</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span>  <span class="mf">943.729499</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d4ec</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
<span class="p">[</span>  <span class="mf">943.730222</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">943.730570</span><span class="p">]</span> <span class="nl">Code</span><span class="p">:</span> <span class="n">d2</span> <span class="mi">74</span> <span class="mi">18</span> <span class="mi">40</span> <span class="mi">38</span> <span class="n">f2</span> <span class="mi">89</span> <span class="n">f1</span> <span class="mi">75</span> <span class="mo">06</span> <span class="n">eb</span> <span class="mf">0f</span> <span class="mi">38</span> <span class="n">ca</span> <span class="mi">74</span> <span class="mi">0</span><span class="n">b</span> <span class="mi">48</span> <span class="mi">83</span> <span class="n">c0</span> <span class="mo">01</span> <span class="mf">0f</span> <span class="n">b6</span> <span class="mi">10</span> <span class="mi">84</span> <span class="n">d2</span> <span class="mi">75</span> <span class="n">f1</span> <span class="mi">5</span><span class="n">d</span> <span class="n">c3</span> <span class="mf">0f</span> <span class="mf">1f</span> <span class="mi">84</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">55</span> <span class="mi">31</span> <span class="n">c0</span> <span class="mi">48</span> <span class="mi">89</span> <span class="n">e5</span> <span class="o">&lt;</span><span class="mf">0f</span><span class="o">&gt;</span> <span class="n">b6</span> <span class="mi">17</span> <span class="mi">40</span> <span class="mi">38</span> <span class="n">f2</span> <span class="mi">48</span> <span class="mf">0f</span> <span class="mi">44</span> <span class="n">c7</span> <span class="mi">48</span> <span class="mi">83</span> <span class="n">c7</span> <span class="mo">01</span> <span class="mi">84</span> <span class="n">d2</span> <span class="mi">75</span> <span class="n">ee</span> <span class="mi">5</span><span class="n">d</span> <span class="n">c3</span> <span class="mi">66</span>
<span class="p">[</span>  <span class="mf">943.735455</span><span class="p">]</span> <span class="n">RIP</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103db86</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">strrchr</span><span class="o">+</span><span class="mh">0x6</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span>  <span class="mf">943.736120</span><span class="p">]</span>  <span class="n">RSP</span> <span class="o">&lt;</span><span class="n">ffff88083e4bfe98</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">943.736598</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">00000000004</span><span class="mi">90523</span>
</code></pre></div></p>
<p>It is <code>setup_new_exec() -&gt; set_task_comm()</code>. I passed the user pointer to <code>set_task_comm()</code>, which I should pass a kernel pointer.</p>
<p>And I actually found we missed a function: <code>do_close_on_exec()</code>. I also add a note above.</p>
<h3 id="random-ib-bug">Random IB Bug<a class="headerlink" href="#random-ib-bug" title="Permanent link">&para;</a></h3>
<p>Another weird bug after pathing loader. Actually, I tried the same setting twice, the second time it works. I guess this is some random IB bug. (Setting: 1P, 1M, 1S. Running a simple exec.c testing program, this have not reach that point yet.)
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">031</span><span class="mi">9</span><span class="o">-</span><span class="mi">2</span>
<span class="p">[</span>  <span class="mf">496.288272</span><span class="p">]</span> <span class="n">p2m_fork</span><span class="p">(</span><span class="n">cpu0</span><span class="p">)</span><span class="o">:</span> <span class="n">I</span> <span class="nl">cur</span><span class="p">:</span><span class="mi">1</span><span class="o">-</span><span class="n">kernel_init</span> <span class="nl">new</span><span class="p">:</span><span class="mi">31</span>
<span class="p">[</span>  <span class="mf">496.349624</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000004</span>
<span class="p">[</span>  <span class="mf">496.443216</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064935</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_send_reply_with_rdma_write_with_imm</span><span class="o">+</span><span class="mh">0x65</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span>  <span class="mf">496.538892</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">496.562811</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">PREEMPT</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span>  <span class="mf">496.618968</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">1</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">kernel_init</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">559</span>
<span class="p">[</span>  <span class="mf">496.689684</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064935</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064935</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_send_reply_with_rdma_write_with_imm</span><span class="o">+</span><span class="mh">0x65</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span>  <span class="mf">496.814478</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88107fcf7d00</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010202</span>
<span class="p">[</span>  <span class="mf">496.877915</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">000000000000004</span><span class="n">c</span> <span class="nl">RBX</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">000000000000002</span><span class="n">c</span>
<span class="p">[</span>  <span class="mf">496.963190</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mo">0000000000000001</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffff88207ff6d008</span>
<span class="p">[</span>  <span class="mf">497.048466</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88107fcf7d98</span> <span class="nl">R08</span><span class="p">:</span> <span class="n">ffff88107fcf7e3c</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">0000000000000004</span>
<span class="p">[</span>  <span class="mf">497.133742</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="n">ffffffff81145fe0</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">000000000000001</span><span class="n">c</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">000000000000002</span><span class="n">c</span>
<span class="p">[</span>  <span class="mf">497.219018</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="mo">0000000000000001</span> <span class="nl">R14</span><span class="p">:</span> <span class="n">ffff88107fcf7e40</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88207ff6d008</span>
<span class="p">[</span>  <span class="mf">497.304293</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc00000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">497.401009</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span>  <span class="mf">497.469645</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">b0</span>
<span class="p">[</span>  <span class="mf">497.554922</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">497.578840</span><span class="p">]</span> <span class="n">ffff88107fcf7d08</span> <span class="mo">0000000000000000</span> <span class="mo">00000000000002</span><span class="mi">82</span> <span class="n">ffffffff81077b10</span>
<span class="p">[</span>  <span class="mf">497.666195</span><span class="p">]</span> <span class="mo">000000000000003</span><span class="n">a</span> <span class="mf">000000047f</span><span class="n">cf7e18</span> <span class="n">ffff88107fcf7e3c</span> <span class="n">ffff88107fd5ed88</span>
<span class="p">[</span>  <span class="mf">497.753552</span><span class="p">]</span> <span class="mo">000000010000002</span><span class="n">c</span> <span class="n">ffffff9b00000040</span> <span class="mo">0000000000000034</span> <span class="n">ffffffff81145fe0</span>
<span class="p">[</span>  <span class="mf">497.840906</span><span class="p">]</span> <span class="n">ffff88107fcf7db0</span> <span class="mo">00000000000002</span><span class="mi">97</span> <span class="n">ffff88107fd5ed88</span> <span class="mo">000000000000002</span><span class="n">c</span>
<span class="p">[</span>  <span class="mf">497.928263</span><span class="p">]</span> <span class="n">ffff88107fcf7e3c</span> <span class="n">ffff88107fcf7e40</span> <span class="mo">000000000000003</span><span class="mi">9</span> <span class="n">ffff88107fcf7dc8</span>
<span class="p">[</span>  <span class="mf">498.015618</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">498.044736</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">498.067615</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810622ff</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ibapi_send_reply_timeout</span><span class="o">+</span><span class="mh">0x3f</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">498.142492</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103b0d4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">net_send_reply_timeout</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x132</span>
<span class="p">[</span>  <span class="mf">498.218408</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103b0d4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">net_send_reply_timeout</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x132</span>
<span class="p">[</span>  <span class="mf">498.292244</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c683</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">p2m_fork</span><span class="o">+</span><span class="mh">0xd3</span><span class="o">/</span><span class="mh">0x200</span>
<span class="p">[</span>  <span class="mf">498.351521</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101f490</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_fork</span><span class="o">+</span><span class="mh">0xf0</span><span class="o">/</span><span class="mh">0x150</span>
<span class="p">[</span>  <span class="mf">498.409758</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101f514</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kernel_thread</span><span class="o">+</span><span class="mh">0x24</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span>  <span class="mf">498.473195</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8115bf21</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">processor_manager_init</span><span class="o">+</span><span class="mh">0x21</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">498.545991</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81000354</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kernel_init</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span>  <span class="mf">498.608388</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810002c0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0xffffffff810002c0</span>
<span class="p">[</span>  <span class="mf">498.668706</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019b0a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">schedule_tail</span><span class="o">+</span><span class="mh">0xa</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span>  <span class="mf">498.733182</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810002c0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0xffffffff810002c0</span>
<span class="p">[</span>  <span class="mf">498.793499</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e762</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span>  <span class="mf">498.856936</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
</code></pre></div></p>
<h2 id="0318-sun">03/18 Sun<a class="headerlink" href="#0318-sun" title="Permanent link">&para;</a></h2>
<p>Got a bug report after enable preempt and sweep thread
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">582.545444</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff8801812cb680</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">locked</span><span class="o">|</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">valid</span><span class="o">|</span><span class="n">reclaim</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff88014b2da000</span>
<span class="p">[</span>  <span class="mf">582.678677</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">PCACHE_BUG_ON_PCM</span><span class="p">(</span><span class="n">pcache_mapped</span><span class="p">(</span><span class="n">pcm</span><span class="p">))</span>
<span class="p">[</span>  <span class="mf">582.758760</span><span class="p">]</span> <span class="nl">rmap</span><span class="p">:</span><span class="n">ffff88207e5e37e8</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x0</span> <span class="n">owner</span><span class="o">-</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">user_va</span><span class="p">:</span><span class="mh">0x7fff0b2da000</span> <span class="nl">ptep</span><span class="p">:</span><span class="n">ffff88207e4a86d0</span>
<span class="p">[</span>  <span class="mf">582.870046</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e4a86d0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x0</span> <span class="nl">flags</span><span class="p">:()</span>
<span class="p">[</span>  <span class="mf">582.926210</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span>  <span class="mf">582.981333</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">604</span><span class="o">/</span><span class="n">victim_finish_insert</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span>  <span class="mf">583.080137</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">...</span>
<span class="p">...</span>
<span class="p">[</span>  <span class="mf">588.847239</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">591101</span>
<span class="p">[</span>  <span class="mf">588.883641</span><span class="p">]</span> <span class="nl">nr_clflush</span><span class="p">:</span> <span class="mi">66176</span>
<span class="p">[</span>  <span class="mf">588.919003</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">588.953325</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">588.991806</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.032368</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.091651</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">587057</span>
<span class="p">[</span>  <span class="mf">589.144694</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">4038</span>
<span class="p">[</span>  <span class="mf">589.195656</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_triggered</span><span class="p">:</span> <span class="mi">439562</span>
<span class="p">[</span>  <span class="mf">589.250780</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain_freeable</span><span class="p">:</span> <span class="mi">373382</span>
<span class="p">[</span>  <span class="mf">589.312143</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain_concurrent</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.370386</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_failure_find</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.423429</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_failure_evict</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.477512</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_succeed</span><span class="p">:</span> <span class="mi">66176</span>
<span class="p">[</span>  <span class="mf">589.529514</span><span class="p">]</span> <span class="nl">nr_victim_eviction_triggered</span><span class="p">:</span> <span class="mi">733361</span>
<span class="p">[</span>  <span class="mf">589.584638</span><span class="p">]</span> <span class="nl">nr_victim_eviction_eagain</span><span class="p">:</span> <span class="mi">671227</span>
<span class="p">[</span>  <span class="mf">589.636640</span><span class="p">]</span> <span class="nl">nr_victim_eviction_succeed</span><span class="p">:</span> <span class="mi">62134</span>
<span class="p">[</span>  <span class="mf">589.688642</span><span class="p">]</span> <span class="nl">nr_victim_prepare_insert</span><span class="p">:</span> <span class="mi">66180</span>
<span class="p">[</span>  <span class="mf">589.738566</span><span class="p">]</span> <span class="nl">nr_victim_finish_insert</span><span class="p">:</span> <span class="mi">66176</span>
<span class="p">[</span>  <span class="mf">589.787447</span><span class="p">]</span> <span class="nl">nr_victim_flush_submitted</span><span class="p">:</span> <span class="mi">66176</span>
<span class="p">[</span>  <span class="mf">589.838411</span><span class="p">]</span> <span class="nl">nr_victim_flush_finished</span><span class="p">:</span> <span class="mi">66176</span>
<span class="p">[</span>  <span class="mf">589.888332</span><span class="p">]</span> <span class="nl">nr_victim_flush_async_run</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.935135</span><span class="p">]</span> <span class="nl">nr_victim_flush_sync</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">589.976738</span><span class="p">]</span> <span class="nl">nr_sweep_run</span><span class="p">:</span> <span class="mi">50580</span>
<span class="p">[</span>  <span class="mf">590.014179</span><span class="p">]</span> <span class="nl">nr_sweep_nr_pset</span><span class="p">:</span> <span class="mi">116770383</span>
<span class="p">[</span>  <span class="mf">590.059943</span><span class="p">]</span> <span class="nl">nr_sweep_nr_moved_pcm</span><span class="p">:</span> <span class="mi">100686435</span>
</code></pre></div></p>
<p>This is an interesting bug. Two threads, one doing munmap or mremap, one doing eviction. They are using the same pcm. munmap and mremap will use <code>pte_get_and_clear()</code> to get the pcm.  While eviction will call <code>pcache_try_to_unamp</code>, which will further call <code>rmap_get_locked_pte()</code>, in which we check if the pte is none, if it is, then we know this is under munmap or mremap, then we skip. This is absolutely wrong. When <code>pcache_try_to_unamp</code> is called by eviction, it should always unmap ALL rmap. The above case is triggered because both two threads skip the final <code>__pcache_remove_rmap</code>.</p>
<p>Hmm, looks like open/close filename is wrong. I need to check.</p>
<p>Last Log from MT+2GB, computation finished:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">031</span><span class="mi">8</span><span class="o">-</span><span class="mi">10</span>
<span class="p">[</span>  <span class="mf">627.280016</span><span class="p">]</span>
<span class="o">****</span>    <span class="nl">ERROR</span><span class="p">:</span>
<span class="o">***</span>     <span class="nl">current</span><span class="p">:</span> <span class="mi">32</span><span class="o">:</span><span class="n">kevict_sweepd</span> <span class="nl">caller</span><span class="p">:</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="o">****</span>    <span class="p">[</span><span class="n">pte</span> <span class="o">==</span> <span class="n">rmap</span><span class="o">-&gt;</span><span class="n">page_table</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">pcache_pfn</span> <span class="o">!=</span> <span class="n">pte_pfn</span><span class="p">]</span>
<span class="o">****</span>    <span class="n">rmap</span><span class="o">-&gt;</span><span class="nl">owner_process</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="nl">uva</span><span class="p">:</span> <span class="mh">0x7fff78f52000</span> <span class="nl">ptep</span><span class="p">:</span> <span class="n">ffff88107e87fa90</span><span class="p">,</span> <span class="n">rmap</span><span class="o">-&gt;</span><span class="nl">page_table</span><span class="p">:</span> <span class="n">ffff88107e87fa90</span>
<span class="o">****</span>    <span class="nl">pcache_pfn</span><span class="p">:</span> <span class="mh">0x168f52</span><span class="p">,</span> <span class="nl">pte_pfn</span><span class="p">:</span> <span class="mh">0x178f52</span>

<span class="p">[</span>  <span class="mf">627.624239</span><span class="p">]</span> <span class="nl">rmap</span><span class="p">:</span><span class="n">ffff88107dc73740</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x0</span> <span class="n">owner</span><span class="o">-</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">user_va</span><span class="p">:</span><span class="mh">0x7fff78f52000</span> <span class="nl">ptep</span><span class="p">:</span><span class="n">ffff88107e87fa90</span>
<span class="p">[</span>  <span class="mf">627.735513</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88107e87fa90</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x0</span> <span class="nl">flags</span><span class="p">:()</span>
<span class="p">[</span>  <span class="mf">627.791670</span><span class="p">]</span> <span class="n">pcache_rmap</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">Corrupted</span> <span class="n">RMAP</span>
<span class="p">[</span>  <span class="mf">627.853026</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff880181a3d480</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">locked</span><span class="o">|</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">valid</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff880168f52000</span>
<span class="p">[</span>  <span class="mf">627.979901</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">Corrupted</span> <span class="n">RMAP</span>
<span class="p">[</span>  <span class="mf">628.036057</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span>  <span class="mf">628.091175</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">rmap</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">109</span><span class="o">/</span><span class="n">report_bad_rmap</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span>  <span class="mf">628.182691</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span>  <span class="mf">628.233647</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">kevict_sweepd</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">543</span>
<span class="p">[</span>  <span class="mf">628.307483</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">628.331401</span><span class="p">]</span> <span class="n">ffff88107e85bd00</span> <span class="n">ffffffff81026d24</span> <span class="mo">000000000000000</span><span class="mi">8</span> <span class="n">ffff88107e85bd10</span>
<span class="p">[</span>  <span class="mf">628.418756</span><span class="p">]</span> <span class="n">ffff88107e85bcc8</span> <span class="mo">0000000021475542</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">628.506113</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">628.593468</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">628.680823</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">628.768179</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">628.797299</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">628.820176</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81026d30</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">panic</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0x102</span>
<span class="p">[</span>  <span class="mf">628.876334</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c6ac</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span>  <span class="mf">628.940811</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c6ac</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span>  <span class="mf">629.005288</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019bfc</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x5c</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">629.071843</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81017195</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">629.144639</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81006704</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span>  <span class="mf">629.217436</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4da</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">629.295432</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012d94</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">printk</span><span class="o">+</span><span class="mh">0x124</span><span class="o">/</span><span class="mh">0x1c0</span>
<span class="p">[</span>  <span class="mf">629.355748</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103ad1f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">report_bad_rmap</span><span class="o">+</span><span class="mh">0x144</span><span class="o">/</span><span class="mh">0x144</span>
<span class="p">[</span>  <span class="mf">629.423345</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81031046</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_referenced_trylock_one</span><span class="o">+</span><span class="mh">0x1c6</span><span class="o">/</span><span class="mh">0x2c0</span>
<span class="p">[</span>  <span class="mf">629.505500</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4da</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">629.583497</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810328a1</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">rmap_walk</span><span class="o">+</span><span class="mh">0x71</span><span class="o">/</span><span class="mh">0xe0</span>
<span class="p">[</span>  <span class="mf">629.642774</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81033329</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_referenced_trylock</span><span class="o">+</span><span class="mh">0x59</span><span class="o">/</span><span class="mh">0xd0</span>
</code></pre></div></p>
<h2 id="0317-sat">03/17 Sat<a class="headerlink" href="#0317-sat" title="Permanent link">&para;</a></h2>
<p>I&rsquo;m too tired today.</p>
<p>Coding side, I will only optimize sweep. Besides, I will book tickets for Iceland trip.</p>
<h2 id="0316-friday">03/16 Friday<a class="headerlink" href="#0316-friday" title="Permanent link">&para;</a></h2>
<p><del class="critic">Task 1</del>: Add physical memory counter. It is a per-zone based counter, even though there is also some global counters. In Linux, per-cpu counter is first accumlated, global counter is updated only when per-cpu ones overflow. Lego&rsquo;s initial version save the trouble of per-cpu counter, I only port one global counter today, because I&rsquo;m not quite confident about our percpu_alloc&hellip;</p>
<p>Anway, the info is reported in the format of <code>manager_sysinfo</code>. Do note this is different from the oirginal <code>sysinfo</code> structure, which is used by sysinfo syscall.</p>
<p><del class="critic">Task 2</del>: Patch get_random_number and /dev/urandom /dev/random. Others wrote the code, but he did not stick to the tradition of format naming. So I have to rewrite some of them. Sigh.</p>
<p><ins class="critic">Task 3</ins>: optimize sweep</p>
<h2 id="0315-thur">03/15 Thur<a class="headerlink" href="#0315-thur" title="Permanent link">&para;</a></h2>
<p>Forgot to write the log yesterday. I actually solved the major bug, the refcount and eviction one. That is really nasty. I basically used pte lock, pcache_lock, and refcount to synchronize between eviction routine and other users such as munmap, mremap, write-protected-handler.</p>
<p>I&rsquo;m really not sure if this mode can be reproduced if I have any other similar systems. But I&rsquo;m glad that I find a way to do this.</p>
<p>Today I got few tasks going on. First merge storage syscall branch, then add sched_yield syscall, add zone/node counters, and probably patch get_random_number.</p>
<p><del class="critic">Task 1</del>: Merge Yilun&rsquo;s storage pull request, has bunch syscalls. I&rsquo;m reviewing now.</p>
<ul>
<li>truncate</li>
<li>ftruncate</li>
<li>getdents</li>
<li>getcwd</li>
<li>mkdir</li>
<li>rmdir</li>
<li>creat</li>
<li>unlink</li>
<li>unlinkat</li>
<li>readlink</li>
<li>statfs</li>
<li>sync</li>
</ul>
<p><del class="critic">Task 2</del>: Add <code>sched_yield()</code>. Fairly simple.</p>
<p><ins class="critic">Task 3</ins>: Add physical memory counter. Fairly complex. The underlying is built long time ago. Need to pick up some. Well some facts:</p>
<ul>
<li>pg_data_t (and zone) is allcoated by alloc_node_data if NUMA is configured.</li>
<li>all zones are built and initliazed in memory_init() in Lego</li>
<li>stats are reset to 0 when pg_data_t allocated (DUH?). Played directly in page_alloc.c</li>
</ul>
<p>Have to continue tomorrow.</p>
<p><ins class="critic">Task 4</ins>: Patch get_random_number and /dev/urandom</p>
<h2 id="0313-wed">03/13 Wed<a class="headerlink" href="#0313-wed" title="Permanent link">&para;</a></h2>
<p>The slow victim flush issue is solved by pinning the thread to a core and remove that core from active_cpu mask.</p>
<p>Today I&rsquo;m going to solve the SMP object issue. I&rsquo;m hoping by solving this, we can have a complete working pcache and victim cache.</p>
<p>Continue yesterday&rsquo;s log:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0313</span><span class="o">-</span><span class="mi">12</span>
<span class="p">[</span> <span class="mf">1073.616269</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff880180777a80</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">locked</span><span class="o">|</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff88011ddea000</span>
<span class="p">[</span> <span class="mf">1073.734941</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span> <span class="nl">tsk</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">user_va</span><span class="p">:</span> <span class="mh">0x7fff4ddea000</span>
<span class="p">[</span> <span class="mf">1073.822304</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">evict</span><span class="o">/</span><span class="n">ref</span> <span class="n">bug</span>

<span class="p">[</span> <span class="mf">1073.987667</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">evict</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">301</span><span class="o">/</span><span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">!</span>

<span class="p">[</span> <span class="mf">1074.082308</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">rmap</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">763</span><span class="o">/</span><span class="n">pcache_zap_pte</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1074.172789</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1074.223751</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">23</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">50</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">476</span>
</code></pre></div></p>
<table>
<thead>
<tr>
<th>Time</th>
<th align="left">CPU0</th>
<th align="left">CPU1</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td align="left">pcache_evict_line()</td>
<td align="left">zap_pte_range()</td>
</tr>
<tr>
<td>1</td>
<td align="left">find @pcm to evict</td>
<td align="left">prepare to unmap pte which points to @pcm</td>
</tr>
<tr>
<td>2</td>
<td align="left">lock_pcache()</td>
<td align="left">..</td>
</tr>
<tr>
<td>3</td>
<td align="left">pcache_try_to_unmap()</td>
<td align="left">pte_offset_lock()</td>
</tr>
<tr>
<td>4</td>
<td align="left">try to lock pte</td>
<td align="left">pcache_zap_pte()</td>
</tr>
<tr>
<td>5</td>
<td align="left">..spin..</td>
<td align="left">trylock_pcache (failed)</td>
</tr>
<tr>
<td>6</td>
<td align="left">..spin..</td>
<td align="left">unlock pte</td>
</tr>
<tr>
<td>7</td>
<td align="left">lock pte</td>
<td align="left">trylock pcache</td>
</tr>
<tr>
<td>8</td>
<td align="left">clear pte</td>
<td align="left">..spin..</td>
</tr>
<tr>
<td>9</td>
<td align="left">unlock pte</td>
<td align="left">..spin..</td>
</tr>
<tr>
<td>10</td>
<td align="left">unlock pcache</td>
<td align="left">..spin..</td>
</tr>
<tr>
<td>11</td>
<td align="left">..</td>
<td align="left">lock pcache</td>
</tr>
<tr>
<td>12</td>
<td align="left">..</td>
<td align="left">lock pte</td>
</tr>
<tr>
<td>13</td>
<td align="left">..</td>
<td align="left"><mark class="critic">HERE, should check if pte changed!</mark></td>
</tr>
</tbody>
</table>
<p>Huh, patched both eviction and other code. Use refcount, pcache lock, pte lock to synchronize between all users. Make sure a going-to-be-evicted pcm will not be used by others. And others will not have a chance to use such line.</p>
<h2 id="0312-tue">03/12 Tue<a class="headerlink" href="#0312-tue" title="Permanent link">&para;</a></h2>
<p>Continue victim cache. The current conclusion is victim has a unbalanced input and output rate. That is why some cores timeout and abort.</p>
<p>Got some more clean log. The log told us that the flushd_victim is too slow at flushing content. Next I going to print the current flush queue content. Make sure that they are really not flushed. If so, I want to add code to flush sync.</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">318.193591</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d340</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">1869</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">318.330986</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>     <span class="o">--</span>
<span class="p">[</span>  <span class="mf">318.388190</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">CPU4</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="n">pid</span><span class="o">=</span><span class="mi">54</span><span class="p">,</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">32</span><span class="p">]</span> <span class="o">--</span>
<span class="p">[</span>  <span class="mf">318.456835</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span>
<span class="p">[</span>  <span class="mf">318.627406</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90748000</span>
<span class="p">[</span>  <span class="mf">318.707492</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1864</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">318.775096</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">318.792778</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span>
<span class="p">[</span>  <span class="mf">318.963349</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90749000</span>
<span class="p">[</span>  <span class="mf">319.043435</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1865</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">319.111040</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">319.128721</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span>
<span class="p">[</span>  <span class="mf">319.299292</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90746000</span>
<span class="p">[</span>  <span class="mf">319.379378</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1862</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">319.446983</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">319.464664</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span>
<span class="p">[</span>  <span class="mf">319.635237</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074a000</span>
<span class="p">[</span>  <span class="mf">319.715321</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1866</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">319.782927</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">319.800608</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span>
<span class="p">[</span>  <span class="mf">319.971179</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90745000</span>
<span class="p">[</span>  <span class="mf">320.051265</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1861</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">320.118870</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">320.136551</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span>
<span class="p">[</span>  <span class="mf">320.307123</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074c000</span>
<span class="p">[</span>  <span class="mf">320.387208</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1868</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">320.454813</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">320.472494</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span>
<span class="p">[</span>  <span class="mf">320.643066</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90747000</span>
<span class="p">[</span>  <span class="mf">320.723152</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1863</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">320.790756</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">320.808438</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span>
<span class="p">[</span>  <span class="mf">320.979009</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074b000</span>
<span class="p">[</span>  <span class="mf">321.059096</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1867</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">321.126700</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">321.144381</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>       <span class="o">--</span>
<span class="p">[</span>  <span class="mf">321.200545</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">fail</span> <span class="n">to</span> <span class="n">allocate</span> <span class="n">pcache</span> <span class="n">or</span> <span class="n">victim</span> <span class="n">cache</span> <span class="n">lines</span><span class="p">.</span>
<span class="p">[</span>  <span class="mf">321.278552</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span><span class="o">:</span> <span class="n">segfault</span> <span class="n">at</span> <span class="mh">0x74d000</span> <span class="n">ip</span> <span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span> <span class="n">sp</span> <span class="mf">00007ff</span><span class="n">f7674cd80</span> <span class="n">error</span> <span class="mi">6</span>
<span class="p">[</span>  <span class="mf">321.511925</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">551908</span>
<span class="p">[</span>  <span class="mf">321.546357</span><span class="p">]</span> <span class="nl">nr_clflush</span><span class="p">:</span> <span class="mi">33449</span>
<span class="p">[</span>  <span class="mf">321.581718</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">321.616040</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">321.654523</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">321.695087</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">321.754371</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">546067</span>
<span class="p">[</span>  <span class="mf">321.807414</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">5750</span>
<span class="p">[</span>  <span class="mf">321.858378</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_triggered</span><span class="p">:</span> <span class="mi">38689</span>
<span class="p">[</span>  <span class="mf">321.912461</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain</span><span class="p">:</span> <span class="mi">5239</span>
<span class="p">[</span>  <span class="mf">321.962385</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_succeed</span><span class="p">:</span> <span class="mi">33449</span>
<span class="p">[</span>  <span class="mf">322.014389</span><span class="p">]</span> <span class="nl">nr_victim_eviction_triggered</span><span class="p">:</span> <span class="mi">41887455</span>
<span class="p">[</span>  <span class="mf">322.071592</span><span class="p">]</span> <span class="nl">nr_victim_eviction_eagain</span><span class="p">:</span> <span class="mi">41859764</span>
<span class="p">[</span>  <span class="mf">322.125676</span><span class="p">]</span> <span class="nl">nr_victim_eviction_succeed</span><span class="p">:</span> <span class="mi">27691</span>
<span class="p">[</span>  <span class="mf">322.177680</span><span class="p">]</span> <span class="nl">nr_victim_prepare_insert</span><span class="p">:</span> <span class="mi">33450</span>
<span class="p">[</span>  <span class="mf">322.227603</span><span class="p">]</span> <span class="nl">nr_victim_finish_insert</span><span class="p">:</span> <span class="mi">33449</span>
<span class="p">[</span>  <span class="mf">322.276487</span><span class="p">]</span> <span class="nl">nr_victim_flush_submitted</span><span class="p">:</span> <span class="mi">33449</span>
<span class="p">[</span>  <span class="mf">322.327451</span><span class="p">]</span> <span class="nl">nr_victim_flush_finished</span><span class="p">:</span> <span class="mi">33449</span>
<span class="p">[</span>  <span class="mf">322.377374</span><span class="p">]</span> <span class="nl">nr_victim_flush_async_run</span><span class="p">:</span> <span class="mi">26989</span>
<span class="p">[</span>  <span class="mf">322.428338</span><span class="p">]</span> <span class="nl">nr_victim_flush_sync</span><span class="p">:</span> <span class="mi">0</span>
</code></pre></div>

<p>Yes, this victims are truly not being flushed. They are inside the flush_queue. No bug, hoo! Just some performance coding issues. But god why the flushd does not get a chance to run in 10 seconds? Hmm&hellip;
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">5520.236187</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span> <span class="nl">tsk</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">user_va</span><span class="p">:</span> <span class="mh">0x7fff464fa000</span>
<span class="p">[</span> <span class="mf">5530.404269</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d340</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">1869</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span> <span class="mf">5530.541664</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>   <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">5530.606147</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span>
<span class="p">[</span> <span class="mf">5530.789194</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90747000</span>
<span class="p">[</span> <span class="mf">5530.880717</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1863</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5530.968080</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span>
<span class="p">[</span> <span class="mf">5531.151128</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074a000</span>
<span class="p">[</span> <span class="mf">5531.242652</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1866</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5531.330015</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span>
<span class="p">[</span> <span class="mf">5531.513063</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074c000</span>
<span class="p">[</span> <span class="mf">5531.604586</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1868</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5531.691950</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span>
<span class="p">[</span> <span class="mf">5531.874997</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074b000</span>
<span class="p">[</span> <span class="mf">5531.966521</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1867</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5532.053885</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span>
<span class="p">[</span> <span class="mf">5532.236932</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90748000</span>
<span class="p">[</span> <span class="mf">5532.328456</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1864</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5532.415819</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span>
<span class="p">[</span> <span class="mf">5532.598867</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90749000</span>
<span class="p">[</span> <span class="mf">5532.690390</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1865</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5532.777753</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span>
<span class="p">[</span> <span class="mf">5532.960802</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90746000</span>
<span class="p">[</span> <span class="mf">5533.052325</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1862</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5533.139689</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span>
<span class="p">[</span> <span class="mf">5533.322736</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff90745000</span>
<span class="p">[</span> <span class="mf">5533.414259</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1861</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">5533.501623</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>   <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="p">[</span> <span class="mf">5533.566106</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>  <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Flush</span> <span class="n">Queue</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">5533.635789</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span>
<span class="p">[</span> <span class="mf">5533.818837</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span>
<span class="p">[</span> <span class="mf">5534.001884</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span>
<span class="p">[</span> <span class="mf">5534.184931</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span>
<span class="p">[</span> <span class="mf">5534.367978</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span>
<span class="p">[</span> <span class="mf">5534.551025</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span>
<span class="p">[</span> <span class="mf">5534.734074</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span>
<span class="p">[</span> <span class="mf">5534.917120</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span>
<span class="p">[</span> <span class="mf">5535.100168</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>  <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Flush</span> <span class="n">Queue</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="p">[</span> <span class="mf">5535.169851</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">fail</span> <span class="n">to</span> <span class="n">allocate</span> <span class="n">pcache</span> <span class="n">or</span> <span class="n">victim</span> <span class="n">cache</span> <span class="n">lines</span><span class="p">.</span>
<span class="p">[</span> <span class="mf">5535.247854</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span><span class="o">:</span> <span class="n">segfault</span> <span class="n">at</span> <span class="mh">0x74d000</span> <span class="n">ip</span> <span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span> <span class="n">sp</span> <span class="mf">00007ff</span><span class="n">f7674cd80</span> <span class="n">error</span> <span class="mi">6</span>
<span class="p">[</span> <span class="mf">5535.480513</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">549578</span>
<span class="p">[</span> <span class="mf">5535.514943</span><span class="p">]</span> <span class="nl">nr_clflush</span><span class="p">:</span> <span class="mi">31822</span>
<span class="p">[</span> <span class="mf">5535.550304</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">5535.584625</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">5535.623107</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">5535.663669</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">5535.722952</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">544279</span>
<span class="p">[</span> <span class="mf">5535.775993</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">5201</span>
<span class="p">[</span> <span class="mf">5535.826955</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_triggered</span><span class="p">:</span> <span class="mi">37437</span>
<span class="p">[</span> <span class="mf">5535.881038</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain</span><span class="p">:</span> <span class="mi">5614</span>
<span class="p">[</span> <span class="mf">5535.930960</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_succeed</span><span class="p">:</span> <span class="mi">31822</span>
<span class="p">[</span> <span class="mf">5535.982963</span><span class="p">]</span> <span class="nl">nr_victim_eviction_triggered</span><span class="p">:</span> <span class="mi">42000029</span>
<span class="p">[</span> <span class="mf">5536.040165</span><span class="p">]</span> <span class="nl">nr_victim_eviction_eagain</span><span class="p">:</span> <span class="mi">41973416</span>
<span class="p">[</span> <span class="mf">5536.094247</span><span class="p">]</span> <span class="nl">nr_victim_eviction_succeed</span><span class="p">:</span> <span class="mi">26613</span>
<span class="p">[</span> <span class="mf">5536.146249</span><span class="p">]</span> <span class="nl">nr_victim_prepare_insert</span><span class="p">:</span> <span class="mi">31823</span>
<span class="p">[</span> <span class="mf">5536.196171</span><span class="p">]</span> <span class="nl">nr_victim_finish_insert</span><span class="p">:</span> <span class="mi">31822</span>
<span class="p">[</span> <span class="mf">5536.245052</span><span class="p">]</span> <span class="nl">nr_victim_flush_submitted</span><span class="p">:</span> <span class="mi">31822</span>
<span class="p">[</span> <span class="mf">5536.296015</span><span class="p">]</span> <span class="nl">nr_victim_flush_finished</span><span class="p">:</span> <span class="mi">31822</span>
<span class="p">[</span> <span class="mf">5536.345937</span><span class="p">]</span> <span class="nl">nr_victim_flush_async_run</span><span class="p">:</span> <span class="mi">26718</span>
<span class="p">[</span> <span class="mf">5536.396899</span><span class="p">]</span> <span class="nl">nr_victim_flush_sync</span><span class="p">:</span> <span class="mi">0</span>
</code></pre></div></p>
<p>Hmm, got some interesting bug, which never happened before. We did a <code>unmap</code> before <code>finish_insert</code>, so the mapcount must be zero. Since we have the <code>Reclaim</code> set for the candidate. But it looks like other code does not too much about the Reclaim bit. I need to check.
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1009.676839</span><span class="p">]</span> <span class="n">victim_flush_async</span> <span class="n">CPU4</span> <span class="n">jobs</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1009.725830</span><span class="p">]</span> <span class="n">victim_flush_async</span> <span class="n">CPU4</span> <span class="n">jobs</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1009.774423</span><span class="p">]</span> <span class="n">victim_flush_async</span> <span class="n">CPU4</span> <span class="n">jobs</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1009.823147</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span> <span class="nl">tsk</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">user_va</span><span class="p">:</span> <span class="mh">0x7fff465fc000</span>
<span class="p">[</span> <span class="mf">1009.910479</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff88018098d740</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">locked</span><span class="o">|</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">valid</span><span class="o">|</span><span class="n">reclaim</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff88012635d000</span>
<span class="p">[</span> <span class="mf">1010.045652</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">PCACHE_BUG_ON_PCM</span><span class="p">(</span><span class="n">pcache_mapped</span><span class="p">(</span><span class="n">pcm</span><span class="p">))</span>
<span class="p">[</span> <span class="mf">1010.125725</span><span class="p">]</span> <span class="n">victim_flush_async</span> <span class="n">CPU4</span> <span class="n">jobs</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1010.174602</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">1010.229717</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">601</span><span class="o">/</span><span class="n">victim_finish_insert</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1010.328509</span><span class="p">]</span> <span class="n">victim_flush_async</span> <span class="n">CPU4</span> <span class="n">jobs</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1010.377385</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1010.428341</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">20</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">47</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">468</span>
<span class="p">[</span> <span class="mf">1010.505294</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1010.529212</span><span class="p">]</span> <span class="n">ffff881f2040fe08</span> <span class="n">ffffffff810259f4</span> <span class="mo">000000000000000</span><span class="mi">8</span> <span class="n">ffff881f2040fe18</span>
<span class="p">[</span> <span class="mf">1010.616565</span><span class="p">]</span> <span class="n">ffff881f2040fdd0</span> <span class="mo">0000000021475542</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1010.703918</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1010.791270</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1010.878623</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1010.965976</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1010.995095</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1011.017972</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81025a00</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">panic</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0x102</span>
<span class="p">[</span> <span class="mf">1011.074127</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81063a8a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">client_internal_poll_sendcq</span><span class="o">+</span><span class="mh">0x2a</span><span class="o">/</span><span class="mh">0x80</span>
<span class="p">[</span> <span class="mf">1011.154202</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81063c2d</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">client_send_message_with_rdma_write_with_imm_request</span><span class="o">+</span><span class="mh">0x14d</span><span class="o">/</span><span class="mh">0x360</span>
<span class="p">[</span> <span class="mf">1011.262351</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101bffc</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">1011.326827</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019755</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x55</span><span class="o">/</span><span class="mh">0x60</span>
<span class="p">[</span> <span class="mf">1011.393382</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81016e25</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1011.466175</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810066e4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">1011.538969</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4aa</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1011.616964</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012cfd</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">printk</span><span class="o">+</span><span class="mh">0x11d</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="p">[</span> <span class="mf">1011.677279</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81032a19</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">victim_finish_insert</span><span class="o">+</span><span class="mh">0x89</span><span class="o">/</span><span class="mh">0x230</span>
<span class="p">[</span> <span class="mf">1011.749032</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81031a99</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="o">+</span><span class="mh">0x79</span><span class="o">/</span><span class="mh">0x280</span>
<span class="p">[</span> <span class="mf">1011.817667</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f00a</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_alloc</span><span class="o">+</span><span class="mh">0x23a</span><span class="o">/</span><span class="mh">0x340</span>
<span class="p">[</span> <span class="mf">1011.882141</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102e4da</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">common_do_fill_page</span><span class="o">+</span><span class="mh">0x2a</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="p">[</span> <span class="mf">1011.952856</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102e160</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">pcache_meta_to_kva</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">1012.023570</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102e802</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x1a2</span><span class="o">/</span><span class="mh">0x660</span>
<span class="p">[</span> <span class="mf">1012.095324</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810102b2</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_page_fault</span><span class="o">+</span><span class="mh">0xa2</span><span class="o">/</span><span class="mh">0x1a0</span>
<span class="p">[</span> <span class="mf">1012.159799</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100dadf</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">page_fault</span><span class="o">+</span><span class="mh">0x1f</span><span class="o">/</span><span class="mh">0x30</span>
</code></pre></div></p>
<p>Interesting. Memory consistency issue? Actually, I&rsquo;m not sure if it is the <code>v-&gt;flags = 0</code> issue. Others use atomic bit operations to play with this flag, while the reset is a simple store. I checked the list operations,  all of them are protected by spinlock. So the below should never happen in theory. I&rsquo;m changing the <code>v-&gt;flags = 0</code> to <code>smp_store_mb(v-&gt;flags, 0)</code>, which is a <code>xchg</code> in x86. Same for pcache.
<div class="highlight"><pre><span></span><code>[ 1773.814490] CPU17 PID44  victim:ffff88207ff71000 index:0 refcount:1 nr_fill:0 locked:0 flags:(allocated|usable) pcm:          (null) pset:          (null)
[ 1773.979705] CPU17 PID44     hit[0] owner: [word_count-pthr][32] addr: 0x7fff95b1c000
[ 1774.072260] CPU17 PID44     rmap to pset:ffff88207f96c700 set_idx: 23324 nr_lru:8
[ 1774.161694] CPU17 PID44     victim dumped because: PCACHE_BUG_ON_VICTIM(!VictimUsable(v))
[ 1774.259451] ------------[ cut here ]------------
[ 1774.314567] BUG: failure at managers/processor/pcache/victim.c:231/find_victim_to_evict()!
[ 1774.413363] Kernel Panic - not syncing: BUG!
[ 1774.464320] CPU: 17 PID: 44 Comm: word_count-pthr 4.0.0-lego-ys+ #47
...
[ 1781.363348] nr_pcache_fill_from_victim: 2
</code></pre></div></p>
<p>Did another run. I added an explicit <code>wake_up_victim_flushd</code> if victim failed to evict any line. But this fails with IB failure..
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">2336.950087</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">20010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d340</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">1869</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span> <span class="mf">2337.087474</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>   <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">2337.151955</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span>
<span class="p">[</span> <span class="mf">2337.334999</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074a000</span>
<span class="p">[</span> <span class="mf">2337.426521</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1866</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">2337.513883</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span>
<span class="p">[</span> <span class="mf">2337.696927</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff9074b000</span>
<span class="p">[</span> <span class="mf">2337.788450</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>     <span class="n">rmap</span> <span class="n">to</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">1867</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">...</span>
<span class="p">...</span>
<span class="p">[</span> <span class="mf">2340.111861</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>  <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Flush</span> <span class="n">Queue</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">2340.181543</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d140</span>
<span class="p">[</span> <span class="mf">2340.364587</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d180</span>
<span class="p">[</span> <span class="mf">2340.547632</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d1c0</span>
<span class="p">[</span> <span class="mf">2340.730675</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d200</span>
<span class="p">[</span> <span class="mf">2340.913720</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d240</span>
<span class="p">[</span> <span class="mf">2341.096763</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d280</span>
<span class="p">[</span> <span class="mf">2341.279808</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d2c0</span>
<span class="p">[</span> <span class="mf">2341.462851</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>  <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="o">|</span><span class="n">waitflush</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f81d300</span>
<span class="p">[</span> <span class="mf">2341.645895</span><span class="p">]</span> <span class="n">CPU4</span> <span class="n">PID54</span>   <span class="o">--</span>  <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Flush</span> <span class="n">Queue</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="p">[</span> <span class="mf">2341.715577</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">fail</span> <span class="n">to</span> <span class="n">allocate</span> <span class="n">pcache</span> <span class="n">or</span> <span class="n">victim</span> <span class="n">cache</span> <span class="n">lines</span><span class="p">.</span>
<span class="p">[</span> <span class="mf">2341.793579</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span><span class="o">:</span> <span class="n">segfault</span> <span class="n">at</span> <span class="mh">0x74d000</span> <span class="n">ip</span> <span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span> <span class="n">sp</span> <span class="mf">00007ff</span><span class="n">f7674cd80</span> <span class="n">error</span> <span class="mi">6</span>
<span class="p">[</span> <span class="mf">2476.201442</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span> <span class="mf">2476.254590</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2476.308670</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span> <span class="mf">2476.368991</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2476.423073</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2476.477153</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2476.531236</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1051</span>
<span class="p">[</span> <span class="mf">2476.598837</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1052</span>
<span class="p">[</span> <span class="mf">2476.666438</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EPERM</span><span class="p">:</span><span class="n">Operation</span> <span class="n">not</span> <span class="n">permitted</span> <span class="nl">tsk</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">user_va</span><span class="p">:</span> <span class="mh">0x7fff90745000</span>
<span class="p">[</span> <span class="mf">2476.765240</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">2476.840122</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1053</span>
<span class="p">[</span> <span class="mf">2476.907724</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">2476.982605</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1054</span>
<span class="p">[</span> <span class="mf">2477.050207</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">2477.125089</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.179169</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.233251</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.287332</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.341414</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1055</span>
<span class="p">[</span> <span class="mf">2477.409016</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1056</span>
<span class="p">..</span>
<span class="p">..</span>
<span class="p">[</span> <span class="mf">2477.761583</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">4</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span> <span class="mf">2477.836464</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.890545</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.944626</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2477.998707</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span> <span class="mf">2478.052789</span><span class="p">]</span> <span class="nl">client_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1059</span>
<span class="p">[</span> <span class="mf">2478.120392</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">2478.213992</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064894</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">client_poll_cq</span><span class="o">+</span><span class="mh">0x1f4</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span> <span class="mf">2478.284714</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">2478.308635</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span> <span class="mf">2478.356476</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">2</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">29</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">473</span>
<span class="p">[</span> <span class="mf">2478.427197</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064894</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064894</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">client_poll_cq</span><span class="o">+</span><span class="mh">0x1f4</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span> <span class="mf">2478.527040</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88107e143d90</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010246</span>
<span class="p">[</span> <span class="mf">2478.590481</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88207fc6e000</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2478.675762</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">000000000000100</span><span class="mi">8</span> <span class="nl">RSI</span><span class="p">:</span> <span class="n">ffffffff811d36e0</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffffffff811dab08</span>
<span class="p">[</span> <span class="mf">2478.761044</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88107e143eb0</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2478.846327</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mo">0000000000000002</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R12</span><span class="p">:</span> <span class="n">ffff88207fd4f000</span>
<span class="p">[</span> <span class="mf">2478.931609</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R14</span><span class="p">:</span> <span class="n">ffff88107e143da8</span> <span class="nl">R15</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2479.016890</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc20000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2479.113613</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span> <span class="mf">2479.182254</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span> <span class="mf">2479.267536</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">2479.291457</span><span class="p">]</span> <span class="n">ffff88107e143da0</span> <span class="mo">001012</span><span class="mi">9</span><span class="n">c81019794</span> <span class="mo">0000000000000001</span> <span class="mo">0000000000000423</span>
<span class="p">[</span> <span class="mf">2479.378818</span><span class="p">]</span> <span class="mo">000000</span><span class="mi">8100000005</span> <span class="mf">00001008000000f</span><span class="mi">9</span> <span class="n">ffff88207fd39000</span> <span class="mo">0000000040000000</span>
<span class="p">[</span> <span class="mf">2479.466180</span><span class="p">]</span> <span class="mf">000f</span><span class="mo">004000000002</span> <span class="n">ffff88107e140000</span> <span class="mo">0000000000000424</span> <span class="n">ffff881000000005</span>
<span class="p">[</span> <span class="mf">2479.553542</span><span class="p">]</span> <span class="mf">00000000000000f</span><span class="mi">9</span> <span class="n">ffff88207fd39000</span> <span class="n">ffff88107e143e38</span> <span class="n">ffffffff81019e44</span>
<span class="p">[</span> <span class="mf">2479.640904</span><span class="p">]</span> <span class="mo">0000000000000001</span> <span class="mo">0000000000000425</span> <span class="n">ffff881000000005</span> <span class="n">ffffffff000000f9</span>
<span class="p">[</span> <span class="mf">2479.728266</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">2479.757386</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">2479.780268</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019e44</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">try_to_wake_up</span><span class="o">+</span><span class="mh">0xe4</span><span class="o">/</span><span class="mh">0x1f0</span>
<span class="p">[</span> <span class="mf">2479.847869</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81066d78</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__schedule</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">/</span><span class="mh">0x1e0</span>
<span class="p">[</span> <span class="mf">2479.911311</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064d60</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">client_poll_cq</span><span class="o">+</span><span class="mh">0x6c0</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span> <span class="mf">2479.979952</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81064d70</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">client_poll_cq_pass</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">2480.049634</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020336</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x110</span>
<span class="p">[</span> <span class="mf">2480.107875</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020240</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">2480.176516</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e732</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
</code></pre></div></p>
<p>A classical SMP bug. Lucky to find this one. Let me try to describe this. There are two CPU1. CPU0 and CPU1. CPU0 is doing eviction while CPU1 is doing munmap-&gt;pcache_zap_pte. The CPU0 slected a pcm, while this pcm happen to be zapped at the same time by CPU1. There are not enough actions to either 1) prevent CPU0 from selecting this pcm, 2) prevent CPU1 from using this pcm. Both solutions might be work. But we need as least one.</p>
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0313</span><span class="o">-</span><span class="mi">12</span>
<span class="p">[</span> <span class="mf">1073.616269</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff880180777a80</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">locked</span><span class="o">|</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="p">)</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff88011ddea000</span>
<span class="p">[</span> <span class="mf">1073.734941</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span> <span class="nl">tsk</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">user_va</span><span class="p">:</span> <span class="mh">0x7fff4ddea000</span>
<span class="p">[</span> <span class="mf">1073.822304</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">evict</span><span class="o">/</span><span class="n">ref</span> <span class="n">bug</span>

<span class="p">[</span> <span class="mf">1073.987667</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">evict</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">301</span><span class="o">/</span><span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">!</span>

<span class="p">[</span> <span class="mf">1074.082308</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">rmap</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">763</span><span class="o">/</span><span class="n">pcache_zap_pte</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1074.172789</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1074.223751</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">23</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">50</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">476</span>
</code></pre></div>

<h2 id="0311-mon">03/11 Mon<a class="headerlink" href="#0311-mon" title="Permanent link">&para;</a></h2>
<h3 id="debug-victim-cache">Debug victim cache<a class="headerlink" href="#debug-victim-cache" title="Permanent link">&para;</a></h3>
<p>Morning. Today I will continue debugging victim and clflush, running with MT phoenix+2GB, seq+4GB. Sounds good.</p>
<p>Digging into yesterday&rsquo;s 21th run log. The warning comes from <code>victim_alloc_slowpath</code>. The allocation abort after 10 seconds timeout. And interestingly, a lot threads abort. (The case is, <code>pset</code> is full, so <code>pcache_alloc</code> will try to evict one to victim cache. But victim cache is full as well. So it needs to evict one victim cache line too. Somehow this does not proceed as planned.) I guess somewhere deadlock happens.
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1682.040428</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">7</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">34</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1682.161063</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">19</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">46</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1686.602779</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">10</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">37</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1687.384837</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">3</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">53</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1687.505474</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">21</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">48</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1687.737386</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">16</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">43</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1687.859063</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">54</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1688.034819</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">6</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">56</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1688.210574</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">14</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">41</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1688.488246</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">55</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1689.598935</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">22</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">49</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1689.953565</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">51</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1691.740234</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">13</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">40</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1691.861911</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">1</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">52</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
<span class="p">[</span> <span class="mf">1791.554552</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">11</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">38</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">victim</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">447</span> <span class="n">victim_prepare_insert</span><span class="o">+</span><span class="mh">0x322</span><span class="o">/</span><span class="mh">0x4b0</span>
</code></pre></div></p>
<p>1<sup>st</sup> run. MT+2GB. Victim allocation as predicted. Somehow I already forgot how the code is designed. I need to take a detailed reread.</p>
<p>Along the testing, fixed a bug in eviction code: handle failed evict_line properly. If eviction mechanism failed, we need to clear what the algorithm part has done. This is also related to yesterday&rsquo;s big idea: always do proper cleanup. Many thanks go to pcache free checking, help me to find this bug.</p>
<p>Less is more. I printed too much useless info when pcache_alloc or victim_alloc fail. I removed all the dump_pset from the failing path. It can give me a much more clean message to debug.</p>
<p>Hmm, it is really weird. I dump all victims once alloc timeout. You can see that all victim are not Flushed, that means none of them can be evicted. Take a look at the stat. Hmm, I probabaly should not do this per-cpu counter??
<div class="highlight"><pre><span></span><code><span class="p">...</span>
<span class="p">[</span> <span class="mf">4751.460819</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>     <span class="o">--</span>
<span class="p">[</span> <span class="mf">4751.518022</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">CPU19</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="n">pid</span><span class="o">=</span><span class="mi">46</span><span class="p">,</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">32</span><span class="p">]</span> <span class="o">--</span>
<span class="p">[</span> <span class="mf">4751.587706</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800440</span>
<span class="p">[</span> <span class="mf">4751.747872</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff20011000</span>
<span class="p">[</span> <span class="mf">4751.827955</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800440</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4751.893478</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4751.911159</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f8003c0</span>
<span class="p">[</span> <span class="mf">4752.071326</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff2000f000</span>
<span class="p">[</span> <span class="mf">4752.428060</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f8003c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">15</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4752.630868</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4752.931441</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800540</span>
<span class="p">[</span> <span class="mf">4753.370339</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff20015000</span>
<span class="p">[</span> <span class="mf">4753.450422</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800540</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">21</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4753.515945</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4753.533627</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">3</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">1</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207fbdff40</span>
<span class="p">[</span> <span class="mf">4753.693792</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fffbf7fd000</span>
<span class="p">[</span> <span class="mf">4753.773875</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207fbdff40</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">63485</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span> <span class="mf">4753.842518</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4753.860199</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">3</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800500</span>
<span class="p">[</span> <span class="mf">4754.020367</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff20014000</span>
<span class="p">[</span> <span class="mf">4754.100449</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800500</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">20</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4754.165971</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4754.183653</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800480</span>
<span class="p">[</span> <span class="mf">4754.343819</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff30012000</span>
<span class="p">[</span> <span class="mf">4754.423902</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800480</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">18</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4754.489426</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4754.507106</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f8004c0</span>
<span class="p">[</span> <span class="mf">4754.808718</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff30013000</span>
<span class="p">[</span> <span class="mf">4754.888802</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f8004c0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">19</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4754.954325</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4754.972006</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800400</span>
<span class="p">[</span> <span class="mf">4755.132172</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff20010000</span>
<span class="p">[</span> <span class="mf">4755.212255</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800400</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">16</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span> <span class="mf">4755.277778</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">4755.295458</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>       <span class="o">--</span>

<span class="p">...</span>

<span class="p">[</span> <span class="mf">4757.948641</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">313898</span>
<span class="p">[</span> <span class="mf">4757.983067</span><span class="p">]</span> <span class="nl">nr_clflush</span><span class="p">:</span> <span class="mi">488</span>
<span class="p">[</span> <span class="mf">4758.016347</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">4758.050669</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">4758.089151</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">4758.129713</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">4758.188995</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">313833</span>
<span class="p">[</span> <span class="mf">4758.242038</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">54</span>
<span class="p">[</span> <span class="mf">4758.290919</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_triggered</span><span class="p">:</span> <span class="mi">243280263</span>
<span class="p">[</span> <span class="mf">4758.349161</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain</span><span class="p">:</span> <span class="mi">243279763</span>
<span class="p">[</span> <span class="mf">4758.404283</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_succeed</span><span class="p">:</span> <span class="mi">488</span>
<span class="p">[</span> <span class="mf">4758.454207</span><span class="p">]</span> <span class="nl">nr_victim_eviction</span><span class="p">:</span> <span class="mi">426</span>
<span class="p">[</span> <span class="mf">4758.495807</span><span class="p">]</span> <span class="nl">nr_victim_prepare_insert</span><span class="p">:</span> <span class="mi">500</span>
<span class="p">[</span> <span class="mf">4758.543649</span><span class="p">]</span> <span class="nl">nr_victim_finish_insert</span><span class="p">:</span> <span class="mi">488</span>
<span class="p">[</span> <span class="mf">4758.590451</span><span class="p">]</span> <span class="nl">nr_victim_flush_submitted</span><span class="p">:</span> <span class="mi">488</span>
<span class="p">[</span> <span class="mf">4758.639333</span><span class="p">]</span> <span class="nl">nr_victim_flush_finished</span><span class="p">:</span> <span class="mi">488</span>
</code></pre></div></p>
<p>I counted it wrong. Below is the log. Since <code>nr_victim_flushd_run * 8 = nr_victim_flush_finished</code>, it basically means for every run, victim_flushd needs to flush all 8 victims, which implies eviction rate is much higher than the flushd running rate. <code>nr_pcache_fill_from_victim: 21</code>, which means there are some succeed refills, but I don&rsquo;t know how it can improve performance.</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">475.468489</span><span class="p">]</span> <span class="n">CPU4</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">54</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800000</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">475.602752</span><span class="p">]</span> <span class="n">CPU3</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">53</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f900a00</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">16424</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">476.029145</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">55</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207fbdff40</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">63485</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">476.169542</span><span class="p">]</span> <span class="n">CPU9</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">36</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f900000</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">16384</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">477.360322</span><span class="p">]</span> <span class="n">CPU1</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">52</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207fbfff80</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">65534</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">479.206291</span><span class="p">]</span> <span class="n">CPU18</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">45</span> <span class="n">Abort</span> <span class="n">victim</span> <span class="n">alloc</span> <span class="p">(</span><span class="mi">10010</span><span class="n">ms</span><span class="p">)</span> <span class="nl">nr_usable_victims</span><span class="p">:</span> <span class="mi">8</span> <span class="n">req</span> <span class="n">from</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207fb00000</span><span class="p">,</span> <span class="nl">pset_idx</span><span class="p">:</span><span class="mi">49152</span><span class="p">,</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">7</span>

<span class="p">[</span>  <span class="mf">475.743150</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">Start</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>     <span class="o">--</span>
<span class="p">[</span>  <span class="mf">475.800350</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">CPU4</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="n">pid</span><span class="o">=</span><span class="mi">54</span><span class="p">,</span> <span class="n">tgid</span><span class="o">=</span><span class="mi">32</span><span class="p">]</span> <span class="o">--</span>
<span class="p">[</span>  <span class="mf">475.868989</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71000</span> <span class="nl">index</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a80</span>
<span class="p">[</span>  <span class="mf">476.309940</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff3002a000</span>
<span class="p">[</span>  <span class="mf">476.390020</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a80</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">42</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">476.455538</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">476.473218</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71048</span> <span class="nl">index</span><span class="p">:</span><span class="mi">1</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800bc0</span>
<span class="p">[</span>  <span class="mf">476.633376</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff4002f000</span>
<span class="p">[</span>  <span class="mf">476.713453</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800bc0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">47</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">476.778972</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">476.796652</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71090</span> <span class="nl">index</span><span class="p">:</span><span class="mi">2</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b80</span>
<span class="p">[</span>  <span class="mf">476.956809</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff3002e000</span>
<span class="p">[</span>  <span class="mf">477.036889</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b80</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">46</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">477.102406</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">477.120086</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff710d8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">3</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a00</span>
<span class="p">[</span>  <span class="mf">477.280245</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff30028000</span>
<span class="p">[</span>  <span class="mf">477.500721</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a00</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">40</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">477.566239</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">477.583918</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71120</span> <span class="nl">index</span><span class="p">:</span><span class="mi">4</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b40</span>
<span class="p">[</span>  <span class="mf">477.744077</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff3002d000</span>
<span class="p">[</span>  <span class="mf">477.824155</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b40</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">45</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">477.889673</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">477.907353</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff71168</span> <span class="nl">index</span><span class="p">:</span><span class="mi">5</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b00</span>
<span class="p">[</span>  <span class="mf">478.067511</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff3002c000</span>
<span class="p">[</span>  <span class="mf">478.147590</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800b00</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">44</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">478.213109</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">478.230788</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711b0</span> <span class="nl">index</span><span class="p">:</span><span class="mi">6</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a40</span>
<span class="p">[</span>  <span class="mf">478.390946</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff30029000</span>
<span class="p">[</span>  <span class="mf">478.471024</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800a40</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">41</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">478.536542</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">478.554222</span><span class="p">]</span> <span class="nl">victim</span><span class="p">:</span><span class="n">ffff88207ff711f8</span> <span class="nl">index</span><span class="p">:</span><span class="mi">7</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">2</span> <span class="nl">nr_fill</span><span class="p">:</span><span class="mi">0</span> <span class="nl">locked</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="o">|</span><span class="n">hasdata</span><span class="p">)</span> <span class="nl">pcm</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800ac0</span>
<span class="p">[</span>  <span class="mf">478.714380</span><span class="p">]</span>     <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nl">owner</span><span class="p">:</span> <span class="p">[</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7fff3002b000</span>
<span class="p">[</span>  <span class="mf">478.794458</span><span class="p">]</span>     <span class="nl">pset</span><span class="p">:</span><span class="n">ffff88207f800ac0</span> <span class="nl">set_idx</span><span class="p">:</span> <span class="mi">43</span> <span class="nl">nr_lru</span><span class="p">:</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">478.859977</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">478.877657</span><span class="p">]</span>   <span class="o">--</span>   <span class="n">End</span> <span class="n">Dump</span> <span class="n">Victim</span> <span class="n">Cache</span>       <span class="o">--</span>

<span class="p">[</span>  <span class="mf">480.324070</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">372353</span>
<span class="hll"><span class="p">[</span>  <span class="mf">480.358494</span><span class="p">]</span> <span class="nl">nr_clflush</span><span class="p">:</span> <span class="mi">336</span>
</span><span class="p">[</span>  <span class="mf">480.391774</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">480.426093</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">480.464573</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">480.505132</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">480.564410</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">372326</span>
<span class="p">[</span>  <span class="mf">480.617450</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">21</span>
<span class="p">[</span>  <span class="mf">480.666330</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_triggered</span><span class="p">:</span> <span class="mi">178320088</span>
<span class="p">[</span>  <span class="mf">480.724569</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_eagain</span><span class="p">:</span> <span class="mi">178319746</span>
<span class="hll"><span class="p">[</span>  <span class="mf">480.779687</span><span class="p">]</span> <span class="nl">nr_pcache_eviction_succeed</span><span class="p">:</span> <span class="mi">336</span>
</span><span class="p">[</span>  <span class="mf">480.829606</span><span class="p">]</span> <span class="nl">nr_victim_eviction_triggered</span><span class="p">:</span> <span class="mi">20589049</span>
<span class="p">[</span>  <span class="mf">480.886805</span><span class="p">]</span> <span class="nl">nr_victim_eviction_eagain</span><span class="p">:</span> <span class="mi">20588741</span>
<span class="p">[</span>  <span class="mf">480.940885</span><span class="p">]</span> <span class="nl">nr_victim_eviction_succeed</span><span class="p">:</span> <span class="mi">308</span>
<span class="hll"><span class="p">[</span>  <span class="mf">480.990804</span><span class="p">]</span> <span class="nl">nr_victim_prepare_insert</span><span class="p">:</span> <span class="mi">342</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">481.038643</span><span class="p">]</span> <span class="nl">nr_victim_finish_insert</span><span class="p">:</span> <span class="mi">336</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">481.085442</span><span class="p">]</span> <span class="nl">nr_victim_flush_submitted</span><span class="p">:</span> <span class="mi">336</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">481.134321</span><span class="p">]</span> <span class="nl">nr_victim_flush_finished</span><span class="p">:</span> <span class="mi">336</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">481.182161</span><span class="p">]</span> <span class="nl">nr_victim_flushd_run</span><span class="p">:</span> <span class="mi">42</span>
</span></code></pre></div>

<h2 id="0310-sun">03/10 Sun<a class="headerlink" href="#0310-sun" title="Permanent link">&para;</a></h2>
<h3 id="fix-bug-from-__unhash_procees">Fix bug from <code>__unhash_procees()</code><a class="headerlink" href="#fix-bug-from-__unhash_procees" title="Permanent link">&para;</a></h3>
<p>[Summary]: a bug cause by laziness. When fork happens, the new thread is added into parent&rsquo;s thread_group list. However, we forgot to remove it when the new thread exit. Thus, the field in parent&rsquo;s thread_group will point to a freed page. To make it worse, the freed page got allocated again. In our case, the page was used by pgtable. So, when the parent tries to use that field, it simply corrupts pgtable. This bug is fixed by this commit: 64d43fc.</p>
<p>Got something going on. Huh.</p>
<p>Anyway, pick up what left last night.</p>
<p>8<sup>th</sup> run,
<div class="highlight"><pre><span></span><code>[  426.595911] SYSC_mmap(cpu5): ret_addr:0x7ffefbeac000

pte page got allocated
[  426.653216]     pmd is none index 0x1e3 line 567 from_addr 0x7ffefc6acd90
[  426.734334] __pte_alloc(): for addr: 0x7ffefc6acd90 pte_index: ac
[  426.807132]     pte is none index 0x38 line 574 from_addr 0x7ffefc6acd90
[  427.304148]     pte is none index 0x38 line 576 from_addr 0x7ffefc6acd90

this addr seems fine
[  427.382251]     pte is none index 0x38 line 567 from_addr 0x7ffefc6abe78
[  427.462329]     pte is none index 0x38 line 574 from_addr 0x7ffefc6abe78
[  427.644439]     pte is none index 0x38 line 576 from_addr 0x7ffefc6abe78

Something happen in between corrupted pgtable
[  427.722547] pte:ffff88207e8b51c0 pfn:0x8207e8c3 flags:(dirty|large|global|softw4|pkey0|pkey1|pkey2|pkey3|nx|0x3ff800000000000)
[  427.858779] line: 567 from_addr: 0x6fc6d8 pte.cont: 0xffff88207e8c31c0

[  427.938858] pte:ffff88207e8b51c0 pfn:0x8207e8c3 flags:(dirty|large|global|softw4|pkey0|pkey1|pkey2|pkey3|nx|0x3ff800000000000)
[  428.075095] line: 574 from_addr: 0x6fc6d8 pte.cont: 0xffff88207e8c31c0
</code></pre></div></p>
<p>9<sup>th</sup> run, found actually it created another thread. And it exit. And it corrupted aftet the pid33 exit. Bang, it should be something wrong in exit().
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0311</span><span class="o">-</span><span class="mi">4</span>
<span class="hll"><span class="p">[</span>  <span class="mf">813.127325</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">586</span> <span class="n">from_addr</span> <span class="mh">0x4b0db0</span>
</span><span class="p">[</span>  <span class="mf">813.214683</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">593</span> <span class="n">from_addr</span> <span class="mh">0x6f4768</span>
<span class="hll"><span class="p">[</span>  <span class="mf">813.302042</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">593</span> <span class="n">from_addr</span> <span class="mh">0x4b0db0</span>
</span><span class="p">[</span>  <span class="mf">813.397836</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">595</span> <span class="n">from_addr</span> <span class="mh">0x6f4768</span>
<span class="hll"><span class="p">[</span>  <span class="mf">813.593364</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">595</span> <span class="n">from_addr</span> <span class="mh">0x4b0db0</span>
</span>
<span class="hll"><span class="p">[</span>  <span class="mf">813.678751</span><span class="p">]</span> <span class="n">do_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">code</span><span class="p">:</span><span class="mh">0x0</span>
</span>
<span class="p">[</span>  <span class="mf">814.474321</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">567</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">814.567918</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">575</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">814.661516</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">583</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">814.755115</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">586</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">814.848714</span><span class="p">]</span> <span class="n">__pte_alloc</span><span class="p">()</span><span class="o">:</span> <span class="k">for</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffefc6acd90</span> <span class="nl">pte_index</span><span class="p">:</span> <span class="n">ac</span>
<span class="p">[</span>  <span class="mf">814.921511</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">593</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">815.125249</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">595</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">815.215833</span><span class="p">]</span> <span class="n">After</span> <span class="n">pcache_handle_fault</span>
<span class="p">[</span>  <span class="mf">815.259511</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">726</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>

<span class="p">[</span>  <span class="mf">815.352071</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">567</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">815.444627</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">575</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">815.537186</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">583</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">815.629744</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">586</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">815.722303</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">593</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">815.916890</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">595</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">816.007471</span><span class="p">]</span> <span class="n">After</span> <span class="n">pcache_handle_fault</span>
<span class="p">[</span>  <span class="mf">816.051151</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span>     <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">726</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>

<span class="p">[</span>  <span class="mf">816.143715</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">816.279946</span><span class="p">]</span> <span class="n">do_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">code</span><span class="p">:</span><span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">816.331945</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">567</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x6fc6d8</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>
</code></pre></div></p>
<p>10<sup>th</sup> run, actually 2 threads are created. When pid 33 exit, everything stays okay. But after fork of pid 34. It went wrong:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0311</span><span class="o">-</span><span class="mi">8</span>
<span class="hll"><span class="p">[</span>  <span class="mf">609.490893</span><span class="p">]</span> <span class="n">do_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">code</span><span class="p">:</span><span class="mh">0x0</span>
</span>
<span class="p">[</span>  <span class="mf">609.542894</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">401</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">609.640661</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">443</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">609.738429</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">465</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">609.836197</span><span class="p">]</span> <span class="nl">exit_mm</span><span class="p">:</span><span class="mi">378</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">users</span> <span class="mi">2</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">count</span> <span class="mi">1</span>
<span class="p">[</span>  <span class="mf">609.891320</span><span class="p">]</span> <span class="nl">exit_mm</span><span class="p">:</span><span class="mi">380</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">users</span> <span class="mi">1</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">count</span> <span class="mi">1</span>
<span class="p">[</span>  <span class="mf">609.946445</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">468</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">610.044212</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">471</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span>  <span class="mf">610.141979</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">474</span> <span class="n">from_addr</span> <span class="mh">0x0</span>

<span class="p">[</span>  <span class="mf">610.239747</span><span class="p">]</span> <span class="n">SYSC_mmap</span><span class="p">(</span><span class="n">cpu5</span><span class="p">)</span><span class="o">:</span> <span class="nl">ret_addr</span><span class="p">:</span><span class="mh">0x7ffefbeac000</span>
<span class="hll"><span class="p">[</span>  <span class="mf">610.299031</span><span class="p">]</span> <span class="n">CPU6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">33</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_exit</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">482</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
</span><span class="p">[</span>  <span class="mf">610.396798</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">568</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">610.518489</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">576</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">610.640178</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">584</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">610.761866</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pmd</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x1e3</span> <span class="n">line</span> <span class="mi">587</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">610.883557</span><span class="p">]</span> <span class="n">__pte_alloc</span><span class="p">()</span><span class="o">:</span> <span class="k">for</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffefc6acd90</span> <span class="nl">pte_index</span><span class="p">:</span> <span class="n">ac</span>
<span class="p">[</span>  <span class="mf">610.956362</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">594</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">611.179051</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">596</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">611.297723</span><span class="p">]</span> <span class="n">After</span> <span class="n">pcache_handle_fault</span>
<span class="p">[</span>  <span class="mf">611.341406</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_page_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">726</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6acd90</span>
<span class="p">[</span>  <span class="mf">611.455816</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">568</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">611.576464</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">576</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">611.697113</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">584</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">611.817762</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">587</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">611.938412</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">594</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">612.161103</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">pcache_handle_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">596</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>
<span class="p">[</span>  <span class="mf">612.279778</span><span class="p">]</span> <span class="n">After</span> <span class="n">pcache_handle_fault</span>
<span class="p">[</span>  <span class="mf">612.323461</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_page_fault</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">726</span> <span class="n">from_addr</span> <span class="mh">0x7ffefc6abe78</span>

<span class="hll"><span class="p">[</span>  <span class="mf">612.437875</span><span class="p">]</span> <span class="nl">do_fork</span><span class="p">:</span> <span class="nl">current</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">new</span><span class="p">:</span> <span class="mi">34</span>
</span><span class="hll">
</span><span class="hll"><span class="p">[</span>  <span class="mf">612.484676</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">612.620924</span><span class="p">]</span> <span class="n">do_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">code</span><span class="p">:</span><span class="mh">0x0</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">612.672928</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="nl">pcache_handle_faultline</span><span class="p">:</span> <span class="mi">568</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x6fc6d8</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>
</span>
<span class="p">[</span>  <span class="mf">612.793577</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">612.929828</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">613.066078</span><span class="p">]</span> <span class="n">CPU7</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">34</span> <span class="nl">caller</span><span class="p">:</span> <span class="nl">do_exitline</span><span class="p">:</span> <span class="mi">401</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x0</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>
</code></pre></div></p>
<p>11<sup>th</sup> run, found it orignate from <code>copy_process()</code>. Good.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">869.591729</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_fork</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">886</span> <span class="n">from_addr</span> <span class="mh">0x0</span>

<span class="p">[</span>  <span class="mf">869.688449</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">869.824681</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">do_fork</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">894</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x0</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>
</code></pre></div></p>
<p>12<sup>th</sup> run, found the opeation that corrupt pgtable:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1099.974106</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">copy_process</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">897</span> <span class="n">from_addr</span> <span class="mh">0x0</span>
<span class="p">[</span> <span class="mf">1100.076032</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">1100.212282</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">copy_process</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">902</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x0</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>

<span class="mi">896</span>         <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
<span class="mi">897</span>                 <span class="n">jasmine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="mi">898</span>
<span class="hll"><span class="mi">899</span>                         <span class="nf">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">thread_group</span><span class="p">,</span>
</span><span class="hll"><span class="mi">900</span>                                           <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">thread_group</span><span class="p">);</span>
</span><span class="mi">901</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tgid</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
<span class="mi">902</span>                 <span class="n">jasmine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</code></pre></div></p>
<p>13<sup>th</sup> run, interesting, the list_add_tail write to the pgtable. <code>pte.cont = 0xffff88207e8c31c0, p-&gt;thread_group: 0xffff88207e8c31c0</code>.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">916.269942</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">copy_process</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">898</span> <span class="n">from_addr</span> <span class="mh">0x0</span>

<span class="p">[</span>  <span class="mf">916.371863</span><span class="p">]</span> <span class="nl">p</span><span class="p">:</span> <span class="n">ffff88207e8c3000</span> <span class="n">p</span><span class="o">-&gt;</span><span class="nl">group_leader</span><span class="p">:</span> <span class="n">ffff88107e190000</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="nl">thread_group</span><span class="p">:</span> <span class="n">ffff88207e8c31c0</span> <span class="n">leader</span><span class="o">-&gt;</span><span class="nl">thread_grou</span><span class="p">:</span> <span class="n">ffff88107e1901c0</span>

<span class="p">[</span>  <span class="mf">916.523705</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">916.659947</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">copy_process</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">906</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x0</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>

<span class="p">[</span>  <span class="mf">916.769148</span><span class="p">]</span> <span class="nl">p</span><span class="p">:</span> <span class="n">ffff88207e8c3000</span> <span class="n">p</span><span class="o">-&gt;</span><span class="nl">group_leader</span><span class="p">:</span> <span class="n">ffff88107e190000</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="nl">thread_group</span><span class="p">:</span> <span class="n">ffff88207e8c31c0</span> <span class="n">leader</span><span class="o">-&gt;</span><span class="nl">thread_grou</span><span class="p">:</span> <span class="n">ffff88107e1901c0</span>
</code></pre></div></p>
<p>14<sup>th</sup> run, got an log like this. Clearly, the pte is written the value  of p-&gt;thread_group. But the leader&rsquo;s pointer is correct. Weird, going to dig deeper.
<div class="highlight"><pre><span></span><code>                p: ffff88207e8c3000 p-&gt;group_leader: ffff88107e189000(32)

                p-&gt;thread_group:        ffff88207e8c31c0
                leader-&gt;thread_group:   ffff88107e1891c0

                pte page:               ffff88207e8b5000
                pte:                    ffff88207e8b51c0

                pte.cont:               ffff88207e8c31c0
</code></pre></div></p>
<p>15<sup>th</sup> run, found the bug.
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0311</span><span class="o">-</span><span class="mi">15</span>
<span class="hll"><span class="p">[</span> <span class="mf">1474.477687</span><span class="p">]</span> <span class="n">dup_task_struct</span><span class="p">()</span><span class="o">:</span> <span class="nl">current</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">new</span><span class="p">:</span> <span class="n">ffff88207e8b5000</span>
</span><span class="p">..</span>
<span class="k">while</span> <span class="n">pid</span> <span class="mi">33</span> <span class="n">exit</span>
<span class="n">so</span> <span class="n">the</span> <span class="n">ffff88207e8b5000</span> <span class="n">is</span> <span class="n">freed</span>

<span class="n">but</span> <span class="n">allocated</span> <span class="n">again</span> <span class="n">by</span> <span class="n">pte_alloc</span>
<span class="hll"><span class="p">[</span> <span class="mf">1481.420200</span><span class="p">]</span> <span class="n">__pte_alloc</span><span class="p">()</span><span class="o">:</span><span class="n">CPU5</span> <span class="k">for</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffefc6acd90</span> <span class="nl">pte_index</span><span class="p">:</span> <span class="n">ac</span> <span class="n">new</span> <span class="n">pte</span> <span class="nl">page</span><span class="p">:</span> <span class="n">ffff88207e8b5000</span>
</span>
<span class="n">However</span><span class="p">,</span> <span class="n">we</span> <span class="n">forgot</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">it</span> <span class="n">from</span> <span class="n">group_leader</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">thread_group</span>

<span class="p">[</span> <span class="mf">1485.895938</span><span class="p">]</span>
                <span class="nl">p</span><span class="p">:</span> <span class="n">ffff88207e8c3000</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="nl">group_leader</span><span class="p">:</span> <span class="n">ffff88107e19b000</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

                <span class="n">p</span><span class="o">-&gt;</span><span class="nl">thread_group</span><span class="p">:</span>        <span class="n">ffff88207e8c31c0</span>
                <span class="n">leader</span><span class="o">-&gt;</span><span class="nl">thread_group</span><span class="p">:</span>   <span class="n">ffff88107e19b1c0</span>

<span class="p">[</span> <span class="mf">1486.047784</span><span class="p">]</span>
                <span class="n">tg</span><span class="o">-&gt;</span><span class="nl">next</span><span class="p">:</span>               <span class="n">ffff88207e8c31c8</span>
                <span class="n">tg</span><span class="o">-&gt;</span><span class="nl">prev</span><span class="p">:</span>               <span class="n">ffff88207e8c31c0</span>
                <span class="n">leader</span><span class="o">-&gt;</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">next</span>        <span class="n">ffff88107e19b1c8</span>
                <span class="n">leader</span><span class="o">-&gt;</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">prev</span>        <span class="n">ffff88107e19b1c0</span>

<span class="p">[</span> <span class="mf">1486.191311</span><span class="p">]</span>  <span class="n">next</span>                    <span class="n">ffff88107e19b1c0</span>
<span class="hll">                <span class="n">prev</span>                    <span class="n">ffff88207e8b51c0</span>
</span>                <span class="n">next</span>                    <span class="n">ffff88107e19b1c0</span>

<span class="p">[</span> <span class="mf">1486.276594</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__list_add</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">61</span> <span class="n">from_addr</span> <span class="mh">0x0</span> <span class="nl">page</span><span class="p">:</span> <span class="mh">0xffff88207e8b5000</span>
<span class="p">[</span> <span class="mf">1486.401399</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__list_add</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">65</span> <span class="n">from_addr</span> <span class="mh">0x0</span> <span class="nl">page</span><span class="p">:</span> <span class="mh">0xffff88207e8b5000</span>
<span class="p">[</span> <span class="mf">1486.526203</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__list_add</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">69</span> <span class="n">from_addr</span> <span class="mh">0x0</span> <span class="nl">page</span><span class="p">:</span> <span class="mh">0xffff88207e8b5000</span>
<span class="p">[</span> <span class="mf">1486.651010</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__list_add</span>    <span class="n">pte</span> <span class="n">is</span> <span class="n">none</span> <span class="n">index</span> <span class="mh">0x38</span> <span class="n">line</span> <span class="mi">73</span> <span class="n">from_addr</span> <span class="mh">0x0</span> <span class="nl">page</span><span class="p">:</span> <span class="mh">0xffff88207e8b5000</span>

<span class="p">[</span> <span class="mf">1486.775814</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88207e8b51c0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e8c3</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">1486.912060</span><span class="p">]</span> <span class="n">CPU5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__list_add</span> <span class="nl">line</span><span class="p">:</span> <span class="mi">77</span> <span class="nl">from_addr</span><span class="p">:</span> <span class="mh">0x0</span> <span class="n">pte</span><span class="p">.</span><span class="nl">cont</span><span class="p">:</span> <span class="mh">0xffff88207e8c31c0</span>
</code></pre></div></p>
<p>16<sup>th</sup> run, damn, after patching <code>__unhash_process()</code>, it finally works. Going to workout, see you tonight.</p>
<h3 id="victim-report-error">victim report error<a class="headerlink" href="#victim-report-error" title="Permanent link">&para;</a></h3>
<p>17<sup>th</sup> run. The phoenix program has bug itself, it is not able to run with 4GB dataset. So try it with 2GB dataset. Uuh, the log is too long. <code>__put_vicim</code> report a victim that has wrong flags. Going to disable the evict log and try again.</p>
<p>18<sup>th</sup> run. Happen to run seq with 100MB&hellip; It actually half finished. But the printf of phoenix has funny chars. I guess memory is corrupted. The log shows it is ib_mad_completion.
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">2244.018806</span><span class="p">]</span> <span class="nl">Processor</span><span class="p">:</span> <span class="n">Processor</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>
<span class="p">[</span> <span class="mf">2246.394568</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">HOME</span><span class="o">=/</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2246.447719</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">TERM</span><span class="o">=</span><span class="n">linux</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2246.507003</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">seq</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2246.618289</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_100MB</span><span class="p">.</span><span class="n">txt</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2258.805633</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">Word</span><span class="o">-</span><span class="n">Count</span><span class="o">-</span><span class="nl">Seq</span><span class="p">:</span> <span class="n">Computation</span> <span class="n">Completed</span> <span class="mf">12.46633</span> <span class="n">sec</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2258.923180</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">2258.995743</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">Use</span> <span class="n">len</span> <span class="n">is</span> <span class="mi">123748</span>
<span class="p">[</span> <span class="mf">2263.484774</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">THE</span><span class="p">:</span> <span class="mi">1115050</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2263.666785</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">OF</span><span class="p">:</span> <span class="mi">615296</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2266.103660</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">AND</span><span class="p">:</span> <span class="mi">545303</span> <span class="p">(</span><span class="n">a</span> <span class="n">lot</span> <span class="n">funny</span> <span class="n">chars</span><span class="p">,</span> <span class="n">deleted</span><span class="p">.)</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2267.016837</span><span class="p">]</span> <span class="nl">Code</span><span class="p">:</span> <span class="p">[</span> <span class="mf">2267.038680</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">TO</span><span class="p">:</span> <span class="mi">475179</span>
<span class="o">+&gt;</span><span class="err"></span><span class="o">^</span><span class="n">G</span><span class="err"></span><span class="o">&lt;</span><span class="mi">87</span><span class="o">&gt;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">80</span><span class="o">&gt;</span><span class="n">z</span><span class="o">^</span><span class="n">T</span><span class="o">&lt;</span><span class="mi">86</span><span class="o">&gt;</span><span class="n">ruJ</span><span class="err"></span><span class="o">&lt;</span><span class="mi">9</span><span class="n">e</span><span class="o">&gt;</span><span class="err"></span><span class="n">r</span><span class="o">^</span><span class="n">W</span><span class="o">^</span><span class="n">W</span><span class="o">*^</span><span class="n">_</span><span class="p">{(</span><span class="err"></span><span class="o">?</span><span class="n">Ra</span><span class="err"></span><span class="mi">8</span><span class="err"></span><span class="o">&lt;</span><span class="mi">91</span><span class="o">&gt;</span><span class="err"></span><span class="o">&lt;</span><span class="mf">8f</span><span class="o">&gt;</span><span class="err"></span><span class="n">i</span><span class="o">^?</span><span class="err"></span><span class="mi">4</span><span class="o">&lt;</span><span class="mi">94</span><span class="o">&gt;</span><span class="err"></span><span class="o">^</span><span class="n">V</span><span class="err"></span><span class="n">P</span><span class="p">]</span><span class="err"></span><span class="n">h</span><span class="o">^</span><span class="n">G</span><span class="o">&lt;</span><span class="mi">98</span><span class="o">&gt;^</span><span class="n">T</span><span class="err"></span><span class="n">QpO</span><span class="err"></span><span class="o">^</span><span class="err">\</span><span class="o">^?^</span><span class="n">A</span><span class="o">&lt;</span><span class="mi">91</span><span class="o">&gt;</span><span class="err"></span><span class="n">vBy</span><span class="o">^</span><span class="n">_iwP</span><span class="o">^</span><span class="n">r</span><span class="o">&lt;</span><span class="mi">97</span><span class="o">&gt;</span><span class="err"></span><span class="p">]</span><span class="err"></span><span class="o">&lt;</span><span class="mi">98</span><span class="o">&gt;&lt;</span><span class="mi">81</span><span class="o">&gt;</span><span class="err"></span><span class="o">&lt;</span><span class="mi">85</span><span class="o">&gt;</span><span class="err"></span><span class="n">Ey</span><span class="o">^</span><span class="n">Y</span><span class="o">^?</span><span class="n">V</span><span class="o">^</span><span class="n">Y</span><span class="p">]</span><span class="n">r5</span><span class="o">^^</span><span class="err">&#39;</span><span class="o">&lt;</span><span class="mi">92</span><span class="o">&gt;</span><span class="err"></span><span class="p">]</span><span class="o">^</span><span class="p">]</span><span class="n">P</span><span class="o">^</span><span class="err"></span><span class="n">i</span><span class="err"></span><span class="nl">z</span><span class="p">:</span><span class="err"></span><span class="o">^</span><span class="n">S</span>
<span class="err"></span><span class="n">e</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">a</span><span class="o">&gt;+</span><span class="err">\</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">a</span><span class="o">&gt;</span><span class="err"></span><span class="n">E</span><span class="p">,</span><span class="err"></span><span class="mi">3</span><span class="err"></span><span class="n">_</span><span class="o">^</span><span class="n">P_</span><span class="o">^</span><span class="n">H</span><span class="o">^</span><span class="p">[</span><span class="o">|</span><span class="err"></span><span class="n">sF</span><span class="err"></span><span class="n">m</span><span class="o">&lt;</span><span class="mi">95</span><span class="o">&gt;&lt;</span><span class="mi">9</span><span class="n">d</span><span class="o">&gt;?&lt;</span><span class="mi">82</span><span class="o">&gt;</span><span class="err"></span><span class="o">:</span><span class="err"></span><span class="mi">3</span><span class="err"></span><span class="n">T</span><span class="err"></span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">2263.339165</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="n">paging</span> <span class="n">request</span> <span class="n">at</span> <span class="n">ffffffffffff8100</span>
<span class="p">[</span> <span class="mf">2263.422369</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffffffff8100</span><span class="o">&gt;</span><span class="p">]</span> <span class="mh">0xffffffffffff8100</span>
<span class="p">[</span> <span class="mf">2263.570058</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">1140067</span> <span class="n">PUD</span> <span class="mi">1142067</span> <span class="n">PMD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">2263.618942</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0010</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span> <span class="mf">2264.705811</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">27</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">ib_mad_completi</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">408</span>
<span class="p">[</span> <span class="mf">2264.781736</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffffffff8100</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffffffff8100</span><span class="o">&gt;</span><span class="p">]</span> <span class="mh">0xffffffffffff8100</span>
<span class="p">[</span> <span class="mf">2264.873262</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88107efabc90</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010046</span>
<span class="p">[</span> <span class="mf">2264.936705</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mi">5636000000000098</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">db5affffffffffff</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000001</span>
<span class="p">[</span> <span class="mf">2265.021990</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="n">ffff88107efabd38</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RDI</span><span class="p">:</span> <span class="mf">4460ff</span><span class="n">ffffff8114</span>
<span class="p">[</span> <span class="mf">2265.107277</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88107efabce0</span> <span class="nl">R08</span><span class="p">:</span> <span class="mf">000000000000001f</span> <span class="nl">R09</span><span class="p">:</span> <span class="n">ffff88107efa43c0</span>
<span class="p">[</span> <span class="mf">2265.192561</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="n">ffff88107efabe68</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000001</span> <span class="nl">R12</span><span class="p">:</span> <span class="n">ac02000004ecbdbd</span>
<span class="p">[</span> <span class="mf">2265.277847</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R14</span><span class="p">:</span> <span class="n">ffff88107efa4228</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88107e1ab000</span>
<span class="p">[</span> <span class="mf">2265.363133</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc00000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2265.459858</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span> <span class="mf">2265.528503</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="n">ffffffffffff8100</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">b0</span>
<span class="p">[</span> <span class="mf">2265.613789</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">2265.637710</span><span class="p">]</span> <span class="n">ffffffff810151a7</span> <span class="mo">00000000000000</span><span class="mi">82</span> <span class="n">ffff88107fc04980</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2265.725075</span><span class="p">]</span> <span class="n">ffff88107efabcc8</span> <span class="n">ffff88107fc04980</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">2265.812441</span><span class="p">]</span> <span class="n">ffff88107efa4228</span> <span class="n">ffff88107e1ab000</span> <span class="n">ffff88107efabcf8</span> <span class="n">ffffffff81016e17</span>
<span class="p">[</span> <span class="mf">2265.899806</span><span class="p">]</span> <span class="mo">000000007</span><span class="n">efabe20</span> <span class="n">ffff88107efabd20</span> <span class="n">ffffffff810066f4</span> <span class="n">ffffffff81072f20</span>
<span class="p">[</span> <span class="mf">2265.987172</span><span class="p">]</span> <span class="n">ffff88107fc05e00</span> <span class="n">ffff88107efa4000</span> <span class="n">ffff88107efabe08</span> <span class="n">ffffffff8100e4aa</span>
<span class="p">[</span> <span class="mf">2266.074538</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">2266.206626</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">2266.229507</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810151a7</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">update_wall_time</span><span class="o">+</span><span class="mh">0x47</span><span class="o">/</span><span class="mh">0x6b0</span>
<span class="p">[</span> <span class="mf">2266.299192</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81016e17</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x67</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">2266.369916</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810066f4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">2266.440641</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4aa</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">2266.516565</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810663b8</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__schedule</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">/</span><span class="mh">0x1e0</span>
<span class="p">[</span> <span class="mf">2266.580010</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810664b3</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">schedule</span><span class="o">+</span><span class="mh">0x13</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">2266.638254</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81058c97</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0x2b7</span><span class="o">/</span><span class="mh">0x860</span>
<span class="p">[</span> <span class="mf">2266.716258</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810589e0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">ib_mad_send_done_handler</span><span class="p">.</span><span class="n">isra</span><span class="mf">.22</span><span class="o">+</span><span class="mh">0x1d0</span><span class="o">/</span><span class="mh">0x1d0</span>
<span class="p">[</span> <span class="mf">2266.803624</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020376</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x110</span>
<span class="p">[</span> <span class="mf">2266.861867</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020280</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">2266.930512</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e732</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">2266.993955</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
</code></pre></div></p>
<p>19<sup>th</sup>, try seq+100MB again. Well succeed. I guess I start S too later. So that thread has issues. We run 12.3 sec, while linux run 9.7 sec.</p>
<p>20<sup>th</sup>, try seq+4GB data. Linux runs <code>314.4 sec</code>. Lego runs <code>403 sec</code>. But Lego has some clflush error messages. I don&rsquo;t know why actually.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">794.604628</span><span class="p">]</span> <span class="nl">Processor</span><span class="p">:</span> <span class="n">Processor</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>
<span class="p">[</span>  <span class="mf">796.884884</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">HOME</span><span class="o">=/</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">796.938032</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">TERM</span><span class="o">=</span><span class="n">linux</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">796.997312</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">seq</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">797.108596</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_4GB</span><span class="p">.</span><span class="n">txt</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">980.640200</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.692315</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.746397</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.800478</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.854559</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.908642</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">980.962723</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.016804</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.070886</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.124968</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.179048</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.233129</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.287211</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.341293</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.395375</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.449456</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.503538</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.557619</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.611702</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.665782</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.719863</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.773945</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.828026</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.882108</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.936188</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">981.990271</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">982.044352</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">982.098434</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">982.152515</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span>  <span class="mf">982.206596</span><span class="p">]</span> <span class="n">__clflush_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">EFAULT</span><span class="p">:</span><span class="n">bad</span> <span class="n">address</span>
<span class="p">[</span> <span class="mf">1200.759741</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">Word</span><span class="o">-</span><span class="n">Count</span><span class="o">-</span><span class="nl">Seq</span><span class="p">:</span> <span class="n">Computation</span> <span class="n">Completed</span> <span class="mf">403.519401</span> <span class="n">sec</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">...</span>
<span class="p">[</span> <span class="mf">1200.989480</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">THE</span><span class="p">:</span> <span class="mi">44602000</span>
<span class="p">...</span>
<span class="p">[</span> <span class="mf">1201.755779</span><span class="p">]</span> <span class="n">do_group_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">exit_code</span><span class="p">:</span><span class="mh">0x0</span>
<span class="p">[</span> <span class="mf">1201.819136</span><span class="p">]</span> <span class="n">do_exit</span><span class="p">()</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">code</span><span class="p">:</span><span class="mh">0x0</span>
<span class="p">[</span> <span class="mf">1201.872451</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">1049525</span>
<span class="p">[</span> <span class="mf">1201.908579</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1201.942899</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1201.981380</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1202.021941</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1202.081223</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">1045393</span>
<span class="p">[</span> <span class="mf">1202.135304</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">4132</span>
<span class="p">[</span> <span class="mf">1202.186265</span><span class="p">]</span> <span class="nl">nr_pcache_eviction</span><span class="p">:</span> <span class="mi">525230</span>
<span class="p">[</span> <span class="mf">1202.230987</span><span class="p">]</span> <span class="nl">nr_victim_eviction</span><span class="p">:</span> <span class="mi">521090</span>
</code></pre></div></p>
<p>21th run. Do not have time and energy to debug the clflush issue. I just want to run MT+2GB again. Well victim has issues! Some warning are triggered. Log is <code>wuklab13:~/ys/0311-22</code>. Continue tomorrow! Good night world. (Such a lonly phd.)</p>
<h2 id="0310-sat">03/10 Sat<a class="headerlink" href="#0310-sat" title="Permanent link">&para;</a></h2>
<p>Running python hello world. Tried to make kmalloc use buddy directly.</p>
<h3 id="put_pcache-in-pcache_zap_pte">put_pcache in pcache_zap_pte<a class="headerlink" href="#put_pcache-in-pcache_zap_pte" title="Permanent link">&para;</a></h3>
<p>So this time, python keep running for a long time. But P crashed when the first time eviction was triggered.</p>
<p>Below is log from S side, those libraries do not exist, so these log are fine:
<div class="highlight"><pre><span></span><code>S:
[Mar10 10:39] handle_access_request /etc/ld.so.preload 4, -2
[Mar10 10:44] local_file_open : Cannot open required file [/usr/lib64/python2.7/site.so].
[  +0.352839] local_file_open : Cannot open required file [/usr/lib64/python2.7/sitemodule.so].
[ +22.254465] local_file_open : Cannot open required file [/usr/lib64/python2.7/os.so].
[  +0.350759] local_file_open : Cannot open required file [/usr/lib64/python2.7/osmodule.so].
[Mar10 10:45] local_file_open : Cannot open required file [/usr/lib64/python2.7/posixpath.so].
[  +0.358045] local_file_open : Cannot open required file [/usr/lib64/python2.7/posixpathmodule.so].
[ +13.421033] local_file_open : Cannot open required file [/usr/lib64/python2.7/stat.so].
[  +0.352838] local_file_open : Cannot open required file [/usr/lib64/python2.7/statmodule.so].
[Mar10 10:46] local_file_open : Cannot open required file [/usr/lib64/python2.7/genericpath.so].
[  +0.360126] local_file_open : Cannot open required file [/usr/lib64/python2.7/genericpathmodule.so].
[ +11.582165] local_file_open : Cannot open required file [/usr/lib64/python2.7/warnings.so].
[  +0.357003] local_file_open : Cannot open required file [/usr/lib64/python2.7/warningsmodule.so].
[ +11.989828] local_file_open : Cannot open required file [/usr/lib64/python2.7/linecache.so].
[  +0.358043] local_file_open : Cannot open required file [/usr/lib64/python2.7/linecachemodule.so].
[Mar10 10:47] local_file_open : Cannot open required file [/usr/lib64/python2.7/types.so].
[  +0.353879] local_file_open : Cannot open required file [/usr/lib64/python2.7/typesmodule.so].
</code></pre></div></p>
<p>Weird P&rsquo;s bug, seems like the pcm returned by evict_find_line has issue. Well, I&rsquo;m trying to debug what is going with this set.
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0310</span><span class="o">-</span><span class="mi">2</span>
<span class="p">[</span> <span class="mf">1046.880649</span><span class="p">]</span> <span class="n">SYSC_read</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff6e117e0</span>
<span class="p">[</span> <span class="mf">1046.959692</span><span class="p">]</span>     <span class="nl">fd</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nl">buf</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff7ffb000</span><span class="p">,</span> <span class="nl">count</span><span class="p">:</span> <span class="mi">4096</span>
<span class="p">[</span> <span class="mf">1048.726624</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">:</span> <span class="nl">pset</span><span class="p">:</span> <span class="n">ffff88207f9ffec0</span><span class="p">,</span> <span class="k">for</span> <span class="nl">uva</span><span class="p">:</span> <span class="mh">0x7ffff7ffb000</span>
<span class="p">[</span> <span class="mf">1048.813053</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">1048.868174</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">284</span><span class="o">/</span><span class="n">pcache_meta_to_pcache_set</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1048.965937</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">1049.016898</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">python</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">347</span>
<span class="p">[</span> <span class="mf">1049.083460</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1049.107380</span><span class="p">]</span> <span class="n">ffff88107e18fca8</span> <span class="n">ffffffff81026f1c</span> <span class="mo">000000000000000</span><span class="mi">8</span> <span class="n">ffff88107e18fcb8</span>
<span class="p">[</span> <span class="mf">1049.194743</span><span class="p">]</span> <span class="n">ffff88107e18fc70</span> <span class="mo">0000000021475542</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1049.282107</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1049.369468</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1049.456832</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">1049.544193</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1049.573315</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1049.596195</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81026f28</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">panic</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0xeb</span>
<span class="p">[</span> <span class="mf">1049.651318</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c3fc</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">1049.715799</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019a65</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x55</span><span class="o">/</span><span class="mh">0x60</span>
<span class="p">[</span> <span class="mf">1049.782360</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81017035</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1049.855163</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81006764</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">1049.927966</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c3fc</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">1049.992447</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019a65</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x55</span><span class="o">/</span><span class="mh">0x60</span>
<span class="p">[</span> <span class="mf">1050.059009</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81017035</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1050.131812</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103c41a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">put_dec</span><span class="o">+</span><span class="mh">0x1a</span><span class="o">/</span><span class="mh">0x80</span>
<span class="p">[</span> <span class="mf">1050.191093</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81006764</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">1050.263895</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e56a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">1050.341897</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012ded</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">printk</span><span class="o">+</span><span class="mh">0x11d</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="hll"><span class="p">[</span> <span class="mf">1050.402219</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810340c5</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">dump_pcache_meta</span><span class="o">+</span><span class="mh">0xc5</span><span class="o">/</span><span class="mh">0xd0</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">1050.468782</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81034588</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="o">+</span><span class="mh">0x158</span><span class="o">/</span><span class="mh">0x220</span>
</span><span class="p">[</span> <span class="mf">1050.538463</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81030f5e</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_alloc</span><span class="o">+</span><span class="mh">0x22e</span><span class="o">/</span><span class="mh">0x2f0</span>
<span class="p">[</span> <span class="mf">1050.602945</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103015a</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">common_do_fill_page</span><span class="o">+</span><span class="mh">0x2a</span><span class="o">/</span><span class="mh">0x430</span>
<span class="p">[</span> <span class="mf">1050.673668</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102fb20</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">pcache_meta_to_kva</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">1050.744389</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81030702</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x1a2</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span> <span class="mf">1050.816152</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810103d2</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_page_fault</span><span class="o">+</span><span class="mh">0xa2</span><span class="o">/</span><span class="mh">0x1a0</span>
<span class="p">[</span> <span class="mf">1050.880634</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100db9f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">page_fault</span><span class="o">+</span><span class="mh">0x1f</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">1050.940955</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103bb82</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">copy_user_enhanced_fast_string</span><span class="o">+</span><span class="mh">0x2</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span> <span class="mf">1051.023118</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81038423</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">normal_p2m_read</span><span class="o">+</span><span class="mh">0x233</span><span class="o">/</span><span class="mh">0x330</span>
<span class="p">[</span> <span class="mf">1051.092800</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810363ce</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_read</span><span class="o">+</span><span class="mh">0x9e</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span> <span class="mf">1051.152081</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810268d0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">strace_enter_default</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">1051.224884</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e935</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">1051.288326</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d82c</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
</code></pre></div></p>
<p>Interesting, added several debug messages. The bug is I forgot to put_pcache when a rmap was zapped. One rmap counts one refcount (effectively one process), thus when a rmap was zapped, we should decrease the refcount. I found I&rsquo;ve already done so for <code>pcache_remove_rmap</code>, and <code>pcache_move_pte</code>. But damn, forgot this one. I remember this code was written before fork+pcache. So.. I don&rsquo;t have a big picture at that time. <strong>Multithreaded system plus background reclaim really a very rigours design usage of refcount and lock</strong>.
<div class="highlight"><pre><span></span><code>[ 1418.038411] CPU5 PID32 sys_read+0x0/0xa0
[ 1418.085227] pcache_evict_line(): pset: ffff88207f9ffec0, for uva: 0x7ffff7ffb000
[ 1418.173617] pset:ffff88207f9ffec0 set_idx: 32763 nr_lru:8
[ 1418.238105] pcache:ffff8801801ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880107ffb000
[ 1418.351476] pcache:ffff8801805ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880117ffb000
[ 1418.464847] pcache:ffff8801809ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880127ffb000
[ 1418.578220] pcache:ffff880180dffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880137ffb000
[ 1418.691591] pcache:ffff8801811ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880147ffb000
[ 1418.804963] pcache:ffff8801815ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880157ffb000
[ 1418.918334] pcache:ffff8801819ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880167ffb000
[ 1419.031706] pcache:ffff880181dffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880177ffb000
[ 1419.145077] After dump pset
[ 1419.176280] pcache:ffff8801801ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880107ffb000
[ 1419.289652] pcache dumped because: evict_find_line_lru
[ 1419.351018] pcache:ffff8801805ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880117ffb000
[ 1419.464389] pcache dumped because: evict_find_line_lru
[ 1419.525757] pcache:ffff8801809ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880127ffb000
[ 1419.639127] pcache dumped because: evict_find_line_lru
[ 1419.700494] pcache:ffff880180dffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880137ffb000
[ 1419.813865] pcache dumped because: evict_find_line_lru
[ 1419.875231] pcache:ffff8801811ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880147ffb000
[ 1419.988604] pcache dumped because: evict_find_line_lru
[ 1420.049969] pcache:ffff8801815ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880157ffb000
[ 1420.163341] pcache dumped because: evict_find_line_lru
[ 1420.224708] pcache:ffff8801819ffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880167ffb000
[ 1420.338079] pcache dumped because: evict_find_line_lru
[ 1420.399445] pcache:ffff880181dffec0 mapcount:0 refcount:1 flags:(allocated|usable) kva: ffff880177ffb000
[ 1420.512817] pcache dumped because: evict_find_line_lru
[ 1420.574183] evict_find_line_lru(): pcm: ffff88207f9ffea8
[ 1420.637631] ------------[ cut here ]------------
[ 1420.692756] BUG: failure at ./include/processor/pcache.h:340/pcache_meta_to_kva()!
[ 1420.783245] Kernel Panic - not syncing: BUG!
[ 1420.834210] CPU: 5 PID: 32 Comm: python 4.0.0-lego-ys+ #349
[ 1420.900777] Stack:
</code></pre></div></p>
<h3 id="python-hello-world-run-to-end">python hello world run to end<a class="headerlink" href="#python-hello-world-run-to-end" title="Permanent link">&para;</a></h3>
<p>Glad to say, python hello world finished, even with some missed syscalls. Especially the stdin stuff, so the string is actually not printed out. Log is wuklab13:~/ys/0310-4
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">3149.540308</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_ioctl</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span> <span class="mf">3149.588144</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_ioctl</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span> <span class="mf">3149.635982</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_write</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span> <span class="mf">3149.683818</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">3149.726456</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff6d9aeb0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3149.926247</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff6d9aeb0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">3150.033464</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_newfstat</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span> <span class="mf">3150.084420</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_ioctl</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span> <span class="mf">3150.132256</span><span class="p">]</span> <span class="n">strace__mmap</span> <span class="n">cpu5</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">len</span><span class="o">=</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">prot</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span><span class="o">=</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">flags</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span><span class="o">=</span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="mi">18446744073709551615</span><span class="p">(</span> <span class="p">),</span> <span class="n">off</span><span class="o">=</span><span class="mh">0x0</span>
<span class="p">[</span> <span class="mf">3150.301772</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_read</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span> <span class="mf">3150.348562</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="hll"><span class="p">[</span> <span class="mf">3150.403679</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">24</span> <span class="n">stdio_file_read</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x50</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3150.509751</span><span class="p">]</span> <span class="n">Process</span> <span class="n">wants</span> <span class="n">STDIN</span><span class="o">!</span>
</span><span class="p">[</span> <span class="mf">3150.546149</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">python</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">352</span>
<span class="p">[</span> <span class="mf">3150.612705</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3150.636624</span><span class="p">]</span> <span class="n">ffff88107e18fe90</span> <span class="n">ffffffff81012b15</span> <span class="n">ffffffff811464e0</span> <span class="mf">00007ff</span><span class="n">ff7ffb000</span>
<span class="p">[</span> <span class="mf">3150.723977</span><span class="p">]</span> <span class="mo">0000000000000400</span> <span class="mf">00007ff</span><span class="n">ff70e5640</span> <span class="n">ffff88107e18fef0</span> <span class="n">ffffffff81012bd2</span>
<span class="p">[</span> <span class="mf">3150.811331</span><span class="p">]</span> <span class="n">ffffffff81079d6b</span> <span class="n">ffff881000000018</span> <span class="n">ffff88107e18ff00</span> <span class="n">ffff88107e18fec0</span>
<span class="p">[</span> <span class="mf">3150.898687</span><span class="p">]</span> <span class="mo">0000000000000020</span> <span class="n">ffffffff810346b0</span> <span class="mo">0000000000000022</span> <span class="n">ffffffff811464f0</span>
<span class="p">[</span> <span class="mf">3150.986040</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">ff7fdf740</span> <span class="mo">0000000000000000</span> <span class="n">ffff88107e18ff00</span> <span class="n">ffffffff81035ac0</span>
<span class="p">[</span> <span class="mf">3151.073394</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3151.102514</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3151.125392</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012b21</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0x91</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">3151.194028</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012bd2</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_fmt</span><span class="o">+</span><span class="mh">0x42</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span> <span class="mf">3151.261623</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810346b0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sweep_pset_lru</span><span class="o">+</span><span class="mh">0x220</span><span class="o">/</span><span class="mh">0x220</span>
<span class="p">[</span> <span class="mf">3151.330259</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81035ac0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">stdio_file_read</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span> <span class="mf">3151.395775</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810346e3</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_read</span><span class="o">+</span><span class="mh">0x33</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span> <span class="mf">3151.454010</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e875</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">3151.517446</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d76c</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
<span class="p">[</span> <span class="mf">3151.593362</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3151.616240</span><span class="p">]</span> <span class="o">---</span><span class="p">[</span> <span class="n">end</span> <span class="n">trace</span> <span class="mo">0000000000000000</span> <span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">3151.671360</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_write</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span> <span class="mf">3151.719194</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>


<span class="p">]</span><span class="o">---</span>
<span class="p">[</span> <span class="mf">3151.759756</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_close</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x140</span>
<span class="p">[</span> <span class="mf">3151.808628</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">py_hello</span><span class="p">.</span><span class="n">py</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">3151.871028</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a79380</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3152.070817</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a79380</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">3152.178033</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_rt_sigaction</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0xb0</span>
<span class="p">[</span> <span class="mf">3152.234151</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a77f60</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3152.432941</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a77f60</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">3152.540242</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff73ee794</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3152.739952</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff73ee794</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">3152.847171</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff715b278</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3153.046958</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff715b278</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">3153.154179</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff6de74f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span>
<span class="p">[</span> <span class="mf">3153.353965</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff6de74f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x150</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="hll"><span class="p">[</span> <span class="mf">3153.461180</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_exit_group</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
</span></code></pre></div></p>
<h3 id="trying-phoenix-pthread-again">Trying phoenix pthread again<a class="headerlink" href="#trying-phoenix-pthread-again" title="Permanent link">&para;</a></h3>
<p>4GB pcache, 1GB dataset.</p>
<p>1<sup>th</sup> run with CONFIG_STRACE on, 1GB dataset finished, result is correct.</p>
<p>2<sup>th</sup> run without CONFIG_STRACE, 1GB dataset stuck. Two weird things:</p>
<ul>
<li>open/close dev/cpu/online file too many times than a normal linux run</li>
<li>IB stucked
So next I&rsquo;m going to try add a lock to ibapi, see if it is ib internal deadlock issue.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">0310</span><span class="o">-</span><span class="mi">7</span>
<span class="p">[</span>  <span class="mf">702.895936</span><span class="p">]</span> <span class="nl">Processor</span><span class="p">:</span> <span class="n">Processor</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>
<span class="p">[</span>  <span class="mf">722.400159</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">HOME</span><span class="o">=/</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.453307</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">envp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">TERM</span><span class="o">=</span><span class="n">linux</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.512589</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.628036</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_1GB</span><span class="p">.</span><span class="n">txt</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.759101</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">Wordcount</span><span class="p">:</span> <span class="n">Running</span><span class="p">...</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.819406</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>


<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">722.860139</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">722.940653</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.011483</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.084287</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.157090</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.229894</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.302698</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.375502</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.448306</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.521111</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.593914</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.666718</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.739522</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.812326</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">723.885130</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">766.701260</span><span class="p">]</span> <span class="n">ibapi_send_reply</span><span class="p">()</span> <span class="n">polling</span> <span class="n">timeout</span> <span class="p">(</span><span class="mi">30010</span> <span class="n">ms</span><span class="p">),</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">net_send_reply_timeout</span><span class="o">+</span><span class="mh">0x11b</span><span class="o">/</span><span class="mh">0x1ee</span>
<span class="p">[</span>  <span class="mf">766.809538</span><span class="p">]</span>  <span class="n">net_send_reply_timeout</span><span class="p">()</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">__pcache_do_fill_page</span><span class="o">+</span><span class="mh">0x82</span><span class="o">/</span><span class="mh">0x140</span>
<span class="p">[</span>  <span class="mf">766.895863</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">65</span><span class="p">]</span><span class="o">:</span> <span class="n">segfault</span> <span class="n">at</span> <span class="mh">0x7fffb5eba000</span> <span class="n">ip</span> <span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span> <span class="n">sp</span> <span class="mf">00007ff</span><span class="n">fb5e9ad80</span> <span class="n">error</span> <span class="mi">6</span>
<span class="p">[</span>  <span class="mf">767.012348</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">15</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">65</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">359</span>
<span class="p">[</span>  <span class="mf">767.089312</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0033</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="mo">00000000004024</span><span class="mi">9</span><span class="n">d</span><span class="o">&gt;</span><span class="p">]</span> <span class="mh">0x40249d</span>
<span class="p">[</span>  <span class="mf">767.170436</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">002</span><span class="nl">b</span><span class="p">:</span><span class="mf">00007ff</span><span class="n">fb5e9ad80</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010216</span>
<span class="p">[</span>  <span class="mf">767.233879</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fb5eba000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="mo">00000000000013</span><span class="mi">88</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mf">000000000000004f</span>
<span class="p">[</span>  <span class="mf">767.319164</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fe4ea92a4</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fe626fac9</span> <span class="nl">RDI</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fe4ea92a4</span>
<span class="p">[</span>  <span class="mf">767.404449</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="mf">00000000007540e0</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mf">0000000000014f</span><span class="n">a0</span>
<span class="p">[</span>  <span class="mf">767.489733</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mf">0000000000427f</span><span class="n">b0</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000202</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">0000000000012</span><span class="n">b12</span>
<span class="p">[</span>  <span class="mf">767.575018</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">f496ab890</span> <span class="nl">R14</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">f48704fb0</span> <span class="nl">R15</span><span class="p">:</span> <span class="mo">00000000000013</span><span class="mi">88</span>
<span class="p">[</span>  <span class="mf">767.660303</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mf">00007ff</span><span class="n">fb5e9b700</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88207fce0000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">767.757028</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span>  <span class="mf">767.825671</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fb5eba000</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mf">000000207f</span><span class="n">e3a000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span>  <span class="mf">767.910958</span><span class="p">]</span> <span class="n">get_signal</span><span class="p">()</span><span class="o">:</span> <span class="nl">dequeue_signr</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nl">handler</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">767.987928</span><span class="p">]</span> <span class="n">get_signal</span><span class="p">()</span><span class="o">:</span> <span class="nl">dequeue_signr</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nl">handler</span><span class="p">:</span>          <span class="p">(</span><span class="n">null</span><span class="p">)</span>
</code></pre></div>

<p>3<sup>th</sup> run, without STRACE, with locked ibapi, it finished, result is correct. Runtime: <code>18.692936 sec</code>.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">555.423623</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">288100</span>
<span class="p">[</span>  <span class="mf">555.458042</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">555.492360</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">555.530838</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">555.571396</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">555.630673</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">288081</span>
<span class="p">[</span>  <span class="mf">555.683710</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">12</span>
<span class="p">[</span>  <span class="mf">555.732588</span><span class="p">]</span> <span class="nl">nr_pcache_eviction</span><span class="p">:</span> <span class="mi">494</span>
<span class="p">[</span>  <span class="mf">555.774187</span><span class="p">]</span> <span class="nl">nr_victim_eviction</span><span class="p">:</span> <span class="mi">474</span>
</code></pre></div></p>
<p>4<sup>th</sup> run, same setting with the 3<sup>th</sup> run, same result. But the nr_pgfault differs, I guess it is due to runtime things. Runtime: <code>19.12861 sec</code>.
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">469.891700</span><span class="p">]</span> <span class="nl">nr_pgfault</span><span class="p">:</span> <span class="mi">288119</span>
<span class="p">[</span>  <span class="mf">469.926123</span><span class="p">]</span> <span class="nl">nr_pgfault_wp</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">469.960444</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_cow</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">469.998924</span><span class="p">]</span> <span class="nl">nr_pgfault_wp_reuse</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">470.039484</span><span class="p">]</span> <span class="nl">nr_pgfault_due_to_concurrent_eviction</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">470.098764</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_memory</span><span class="p">:</span> <span class="mi">288093</span>
<span class="p">[</span>  <span class="mf">470.151805</span><span class="p">]</span> <span class="nl">nr_pcache_fill_from_victim</span><span class="p">:</span> <span class="mi">12</span>
<span class="p">[</span>  <span class="mf">470.200684</span><span class="p">]</span> <span class="nl">nr_pcache_eviction</span><span class="p">:</span> <span class="mi">513</span>
<span class="p">[</span>  <span class="mf">470.242285</span><span class="p">]</span> <span class="nl">nr_victim_eviction</span><span class="p">:</span> <span class="mi">493</span>
</code></pre></div></p>
<p>5<sup>th</sup> run, same with 4<sup>th</sup>, succeed, Runtime: <code>18.653879 sec</code>.
<div class="highlight"><pre><span></span><code>[  313.202348] nr_pgfault: 288070
[  313.236772] nr_pgfault_wp: 0
[  313.271093] nr_pgfault_wp_cow: 0
[  313.309575] nr_pgfault_wp_reuse: 0
[  313.350139] nr_pgfault_due_to_concurrent_eviction: 0
[  313.409421] nr_pcache_fill_from_memory: 288052
[  313.462465] nr_pcache_fill_from_victim: 6
[  313.510307] nr_pcache_eviction: 446
[  313.551909] nr_victim_eviction: 432
</code></pre></div></p>
<p>6<sup>th</sup>, setting is the same, but with 4GB dataset, crashed:
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">512.028141</span><span class="p">]</span> <span class="nl">Processor</span><span class="p">:</span> <span class="n">Processor</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">running</span><span class="p">.</span>
<span class="p">[</span>  <span class="mf">529.375605</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">Wordcount</span><span class="p">:</span> <span class="n">Running</span><span class="p">...</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">529.435906</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>


<span class="p">]</span><span class="o">---</span>
<span class="p">[</span>  <span class="mf">529.476660</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">529.555983</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span>  <span class="mf">529.609128</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">rmap</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">735</span><span class="o">/</span><span class="n">pcache_zap_pte</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span>  <span class="mf">529.699613</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span>  <span class="mf">529.750576</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">361</span>
<span class="p">[</span>  <span class="mf">529.826500</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">529.850422</span><span class="p">]</span> <span class="n">ffff88107e1a3dd8</span> <span class="n">ffffffff810259b4</span> <span class="mo">000000000000000</span><span class="mi">8</span> <span class="n">ffff88107e1a3de8</span>
<span class="p">[</span>  <span class="mf">529.937787</span><span class="p">]</span> <span class="n">ffff88107e1a3da0</span> <span class="mo">0000000021475542</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">530.025152</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">530.112517</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">530.199882</span><span class="p">]</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">530.287247</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">530.316370</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">530.339251</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810259c0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">panic</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0xeb</span>
<span class="p">[</span>  <span class="mf">530.394374</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8106190a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">client_internal_poll_sendcq</span><span class="o">+</span><span class="mh">0x2a</span><span class="o">/</span><span class="mh">0x80</span>
<span class="p">[</span>  <span class="mf">530.474458</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101bfcc</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span>  <span class="mf">530.538943</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019725</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x55</span><span class="o">/</span><span class="mh">0x60</span>
<span class="p">[</span>  <span class="mf">530.605506</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81016df5</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">530.678311</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103768a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">put_dec</span><span class="o">+</span><span class="mh">0x1a</span><span class="o">/</span><span class="mh">0x80</span>
<span class="p">[</span>  <span class="mf">530.737595</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810066f4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span>  <span class="mf">530.810398</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e4aa</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">530.888403</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012ccd</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">printk</span><span class="o">+</span><span class="mh">0x11d</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="p">[</span>  <span class="mf">530.948726</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81030429</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_zap_pte</span><span class="o">+</span><span class="mh">0xf9</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span>  <span class="mf">531.014250</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f090</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__pcache_move_pte_fastpath</span><span class="o">+</span><span class="mh">0x50</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">531.093295</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c8dc</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">unmap_page_range</span><span class="o">+</span><span class="mh">0x32c</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span>  <span class="mf">531.161940</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c97e</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">release_pgtable</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span>  <span class="mf">531.227463</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102bfb3</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_munmap</span><span class="o">+</span><span class="mh">0xc3</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span>  <span class="mf">531.288827</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e86d</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x3d</span><span class="o">/</span><span class="mh">0xc0</span>
<span class="p">[</span>  <span class="mf">531.352270</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d76c</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
</code></pre></div></p>
<p>7<sup>th</sup> run, add debug info, does not seem that useful:
<div class="highlight"><pre><span></span><code><span class="p">]</span><span class="o">---</span>
<span class="p">[</span><span class="mf">15755.579501</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span><span class="mf">15755.672760</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88107e1a3dd8</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8207e80b</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">dirty</span><span class="o">|</span><span class="n">large</span><span class="o">|</span><span class="n">global</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
<span class="p">[</span><span class="mf">15755.807015</span><span class="p">]</span> <span class="n">pte</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">pte</span>
<span class="p">[</span><span class="mf">15755.856932</span><span class="p">]</span> <span class="nl">address</span><span class="p">:</span> <span class="mh">0x7ffefc638000</span>
<span class="p">[</span><span class="mf">15755.899569</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span><span class="mf">15755.954684</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">rmap</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">747</span><span class="o">/</span><span class="n">pcache_zap_pte</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span><span class="mf">15756.045159</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span><span class="mf">15756.096114</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pt</span>
</code></pre></div></p>
<p>Tried several times, even with mmap/munmap debug option on, it crashed at the same point. Key is address <code>0x7ffefc638000</code>, and the mmap() related to it.</p>
<p>Close to find the bug. Latest log in 0310-18.</p>
<hr />
<h2 id="0309-fri">03/09 Fri<a class="headerlink" href="#0309-fri" title="Permanent link">&para;</a></h2>
<h3 id="find-bug-in-kmalloc">Find bug in kmalloc<a class="headerlink" href="#find-bug-in-kmalloc" title="Permanent link">&para;</a></h3>
<p>Tried to print pud in every syscall and catch the criminal:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">030</span><span class="mi">9</span><span class="o">-</span><span class="mi">1</span>
<span class="hll"><span class="p">[</span>  <span class="mf">320.088684</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_close</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x1f0</span>
</span><span class="p">[</span>  <span class="mf">320.137567</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fc6f000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fc6f000</span>
<span class="p">[</span>  <span class="mf">320.269657</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3c37</span>
<span class="p">[</span>  <span class="mf">320.349742</span><span class="p">]</span>     <span class="mi">3</span>
<span class="p">[</span>  <span class="mf">320.372624</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libpython2</span><span class="mf">.7</span><span class="p">.</span><span class="n">so</span><span class="mf">.1.0</span><span class="p">]</span>
<span class="hll"><span class="p">[</span>  <span class="mf">320.441268</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="nl">ret</span><span class="p">:</span> <span class="mh">0x0</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="p">[</span>  <span class="mf">320.510954</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fc6f000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fc6f000</span>

<span class="p">[</span>  <span class="mf">320.643043</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a101f0</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">320.709607</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a101f0</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcaeff8</span>
<span class="p">[</span>  <span class="mf">320.798014</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a101f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">320.995755</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a101f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>

<span class="p">[</span>  <span class="mf">321.101944</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a21749</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">321.168509</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a21749</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcaeff8</span>
<span class="p">[</span>  <span class="mf">321.256914</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a21749</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">321.454651</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a21749</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>

<span class="p">[</span>  <span class="mf">321.560845</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7ff2fda</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">321.627409</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7ff2fda</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcaeff8</span>
<span class="p">[</span>  <span class="mf">321.715815</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7ff2fda</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">321.913553</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7ff2fda</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>

<span class="hll"><span class="p">[</span>  <span class="mf">322.019745</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_open</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
</span><span class="p">[</span>  <span class="mf">322.066548</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff9001801ff000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff9001801ff000</span>
<span class="p">[</span>  <span class="mf">322.198638</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3b27</span>
<span class="p">[</span>  <span class="mf">322.277683</span><span class="p">]</span>     <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libpthread</span><span class="p">.</span><span class="n">so</span><span class="mf">.0</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="n">e150</span>
<span class="hll"><span class="p">[</span>  <span class="mf">322.357780</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="nl">ret</span><span class="p">:</span> <span class="mh">0x3</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class="p">[</span>  <span class="mf">322.426414</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff9001801ff000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff9001801ff000</span>
</code></pre></div></p>
<p>After printing more in pcache_handle_fault, I found who corrupted pgtable:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="mo">030</span><span class="mi">9</span><span class="o">-</span><span class="mi">5</span>
<span class="p">[</span>  <span class="mf">661.308584</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_close</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x1f0</span>
<span class="p">[</span>  <span class="mf">661.357466</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">661.489557</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3c37</span>
<span class="p">[</span>  <span class="mf">661.569642</span><span class="p">]</span>     <span class="mi">3</span>    
<span class="p">[</span>  <span class="mf">661.592525</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libpython2</span><span class="mf">.7</span><span class="p">.</span><span class="n">so</span><span class="mf">.1.0</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">661.661170</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="nl">ret</span><span class="p">:</span> <span class="mh">0x0</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">661.730854</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">661.862944</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">662.001275</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a101f0</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">662.067840</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a101f0</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcafff8</span>
<span class="p">[</span>  <span class="mf">662.156247</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a101f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">662.353985</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a101f0</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">662.460176</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>

<span class="p">[</span>  <span class="mf">662.600586</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">662.738916</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a21749</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">662.805481</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7a21749</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcafff8</span>
<span class="p">[</span>  <span class="mf">662.893888</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a21749</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">663.091636</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a21749</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">663.197831</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>

<span class="hll"><span class="p">[</span>  <span class="mf">663.338242</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
</span><span class="p">[</span>  <span class="mf">663.476572</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7ff2fda</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">663.543135</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7ff2fda</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcafff8</span>
<span class="p">[</span>  <span class="mf">663.631543</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7ff2fda</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">663.829279</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7ff2fda</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="hll"><span class="p">[</span>  <span class="mf">663.935472</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff9001801ff000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff9001801ff000</span>
</span>
<span class="p">[</span>  <span class="mf">664.075884</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_open</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span>  <span class="mf">664.122686</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff9001801ff000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff9001801ff000</span>
<span class="p">[</span>  <span class="mf">664.254776</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3b27</span>
<span class="p">[</span>  <span class="mf">664.333821</span><span class="p">]</span>     <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libpthread</span><span class="p">.</span><span class="n">so</span><span class="mf">.0</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="n">e150</span>
<span class="p">[</span>  <span class="mf">664.413918</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="nl">ret</span><span class="p">:</span> <span class="mh">0x3</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">664.482552</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="p">()</span><span class="o">:</span> <span class="n">leave</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff9001801ff000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff9001801ff000</span>
</code></pre></div></p>
<p>Then, try catching bug with address <code>0x7ffff7ff2fda</code> fault. Printing still being the most effective way to debug. :-)</p>
<p>Dig further, I found pgtable corrupted after <code>pcache_add_rmap()</code>, namely after <code>alloc_pcache_rmap()</code>:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">5024.482570</span><span class="p">]</span> <span class="n">pcache_add_rmap</span><span class="p">()</span> <span class="mi">343</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span> <span class="mf">5024.613601</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
<span class="p">[</span> <span class="mf">5024.686396</span><span class="p">]</span> <span class="n">pcache_add_rmap</span><span class="p">()</span> <span class="mi">358</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>
</code></pre></div></p>
<p>Well, <code>rmap: ffff88207fccefd0</code> &amp; <code>ffff90207fcce000</code>, clearly
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">843.916517</span><span class="p">]</span> <span class="n">pcache_add_rmap</span><span class="p">()</span> <span class="mi">372</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">844.047557</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">60</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">844.179638</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
<span class="hll"><span class="p">[</span>  <span class="mf">844.252438</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">71</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">844.384517</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">844.457317</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">85</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>
</span><span class="p">[</span>  <span class="mf">844.589398</span><span class="p">]</span> <span class="n">pcache_add_rmap</span><span class="p">()</span> <span class="mi">387</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>

<span class="mi">46</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pcache_rmap</span> <span class="o">*</span><span class="n">alloc_pcache_rmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="mi">47</span> <span class="p">{</span>
<span class="mi">48</span>         <span class="k">struct</span> <span class="n">pcache_rmap</span> <span class="o">*</span><span class="n">rmap</span><span class="p">;</span>
<span class="mi">49</span>
<span class="mi">50</span>         <span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgd</span><span class="p">;</span>
<span class="mi">51</span>         <span class="n">pud_t</span> <span class="o">*</span><span class="n">pud</span><span class="p">;</span>
<span class="mi">52</span>         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
<span class="mi">53</span>         <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
<span class="mi">54</span>
<span class="mi">55</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">pall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">56</span>                 <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x601008</span><span class="p">;</span>
<span class="mi">57</span>                 <span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">58</span>                 <span class="n">pud</span> <span class="o">=</span> <span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">59</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s() %d pgd %p, pgd.cont_va %lx, pud_index=%#lx pud: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="mi">60</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">),</span> <span class="n">pud_index</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pud</span><span class="p">);</span>
<span class="mi">61</span>         <span class="p">}</span>
<span class="mi">62</span>
<span class="mi">63</span>         <span class="n">rmap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rmap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="mi">64</span>
<span class="mi">65</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">pall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">66</span>                 <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x601008</span><span class="p">;</span>
<span class="mi">67</span>                 <span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">68</span>                 <span class="n">pud</span> <span class="o">=</span> <span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">69</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s(): size: %zu, rmap: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rmap</span><span class="p">),</span> <span class="n">rmap</span><span class="p">);</span>
<span class="mi">70</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s() %d pgd %p, pgd.cont_va %lx, pud_index=%#lx pud: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="hll"><span class="mi">71</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">),</span> <span class="n">pud_index</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pud</span><span class="p">);</span>
</span><span class="mi">72</span>         <span class="p">}</span>
<span class="mi">73</span>
<span class="mi">74</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">rmap</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">75</span>                 <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
<span class="mi">76</span>                 <span class="n">rmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">77</span>         <span class="p">}</span>
<span class="mi">78</span>
<span class="mi">79</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">pall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">80</span>                 <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x601008</span><span class="p">;</span>
<span class="mi">81</span>                 <span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">82</span>                 <span class="n">pud</span> <span class="o">=</span> <span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">83</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s(): size: %zu, rmap: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rmap</span><span class="p">),</span> <span class="n">rmap</span><span class="p">);</span>
<span class="mi">84</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s() %d pgd %p, pgd.cont_va %lx, pud_index=%#lx pud: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="hll"><span class="mi">85</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">),</span> <span class="n">pud_index</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pud</span><span class="p">);</span>
</span><span class="mi">86</span>         <span class="p">}</span>
<span class="mi">87</span>
<span class="mi">88</span>         <span class="k">return</span> <span class="n">rmap</span><span class="p">;</span>
<span class="mi">89</span> <span class="p">}</span>
</code></pre></div></p>
<p>Narrow it down to <code>INIT_LIST_HEAD</code>:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1334.548682</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
<span class="p">[</span> <span class="mf">1334.621487</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">71</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="hll"><span class="p">[</span> <span class="mf">1334.753576</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">76</span> <span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">next</span> <span class="n">ffff88207fcceff8</span> <span class="o">&amp;</span><span class="n">flags</span> <span class="n">ffff88207fccefd8</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">1334.922067</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">86</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>
</span><span class="p">[</span> <span class="mf">1335.126962</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">98</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>

<span class="mi">74</span>         <span class="k">if</span> <span class="p">(</span><span class="n">rmap</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">75</span>         <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s() %d &amp;rmap-&gt;next %p &amp;flags %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="mi">76</span>                 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="mi">77</span>
<span class="hll"><span class="mi">78</span>                 <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span><span class="mi">79</span>
<span class="mi">80</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">pall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">81</span>                 <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x601008</span><span class="p">;</span>
<span class="mi">82</span>                 <span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">83</span>                 <span class="n">pud</span> <span class="o">=</span> <span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">84</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s(): size: %zu, rmap: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rmap</span><span class="p">),</span> <span class="n">rmap</span><span class="p">);</span>
<span class="mi">85</span>                 <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s() %d pgd %p, pgd.cont_va %lx, pud_index=%#lx pud: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="mi">86</span>                         <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">pgd_page_vaddr</span><span class="p">(</span><span class="o">*</span><span class="n">pgd</span><span class="p">),</span> <span class="n">pud_index</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pud</span><span class="p">);</span>
<span class="mi">87</span>         <span class="p">}</span>
<span class="mi">88</span>
<span class="mi">89</span>                 <span class="n">rmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">90</span>         <span class="p">}</span>
</code></pre></div></p>
<p>Seriously, if this is running on user-level on VM, I would be able to find the bug maybe in 30min. But I spent several hours to find it out with physical machine. Damn you physical machine.</p>
<p>Hmm, this func is used A LOT. How can it fail at this point? Possible reasons:</p>
<ul>
<li>kmalloced area happen to intersect with pgtable?</li>
<li>one physical page is mapped twice? one to pgtable, one by this rmap.</li>
<li>tty/serial code has bug? Really ancient code.</li>
</ul>
<p>After add a few printk, IB seems stuck. And this happens just with few more lines of code! Why? code size matters?
<div class="highlight"><pre><span></span><code><span class="p">[</span>  <span class="mf">722.381469</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="p">()</span><span class="o">:</span> <span class="n">enter</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span>  <span class="mf">722.519778</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7feffcc</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span>
<span class="p">[</span>  <span class="mf">722.586334</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x7ffff7feffcc</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf7f8</span> <span class="n">pud</span> <span class="n">ffff88207fcafff8</span>
<span class="p">[</span>  <span class="mf">722.674727</span><span class="p">]</span> <span class="n">Before</span> <span class="n">fill</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x7ffff7feffcc</span> <span class="nl">set_idx</span><span class="p">:</span><span class="mh">0x7fef</span>
<span class="p">[</span>  <span class="mf">722.743362</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff8801801ffbc0</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">1</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">allocated</span><span class="o">|</span><span class="n">usable</span><span class="p">)</span> <span class="n">set_idx</span><span class="o">=</span><span class="mh">0x7fef</span> <span class="nl">kva</span><span class="p">:</span> <span class="n">ffff880107fef000</span>
<span class="p">[</span>  <span class="mf">722.872312</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7feffcc</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">722.967985</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">before</span> <span class="n">net</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="n">last</span> <span class="n">line</span>
</code></pre></div></p>
<p>Well, the following finding finally find the bug line. And it kind of explains the above bug. Probably kmalloc&rsquo;ed area has issues, so IB is touching wrong data. The following bug is related to kmalloc, the rmap is 56 bytes, and it should be within 1 single page, but it is not:
<div class="highlight"><pre><span></span><code><span class="p">[</span> <span class="mf">1862.307427</span><span class="p">]</span> <span class="n">pcache_add_rmap</span><span class="p">()</span> <span class="mi">413</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span> <span class="mf">1862.438477</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">86</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="hll"><span class="p">[</span> <span class="mf">1862.570568</span><span class="p">]</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="nl">units</span><span class="p">:</span> <span class="mi">50</span> <span class="nl">SLOB_UNITS</span><span class="p">:</span> <span class="mi">32</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">1862.617372</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
</span><span class="p">[</span> <span class="mf">1862.690178</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">97</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
<span class="p">[</span> <span class="mf">1862.822268</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">104</span> <span class="o">&amp;</span><span class="n">rmap</span><span class="o">-&gt;</span><span class="n">next</span> <span class="n">ffff88207fcceff8</span> <span class="o">&amp;</span><span class="n">flags</span> <span class="n">ffff88207fccefd8</span>
<span class="p">[</span> <span class="mf">1862.918995</span><span class="p">]</span> <span class="n">__INIT_LIST_HEAD</span><span class="p">()</span><span class="o">:</span> <span class="n">next</span> <span class="n">ffff88207fcceff8</span> <span class="n">prev</span> <span class="n">ffff88207fccf000</span>
<span class="hll"><span class="p">[</span> <span class="mf">1863.002202</span><span class="p">]</span> <span class="n">__INIT_LIST_HEAD</span><span class="p">()</span> <span class="mi">63</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fcae000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fcae000</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">1863.133253</span><span class="p">]</span> <span class="n">__INIT_LIST_HEAD</span><span class="p">()</span><span class="o">:</span> <span class="n">next</span> <span class="n">ffff88207fcceff8</span> <span class="n">prev</span> <span class="n">ffff88207fccf000</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">1863.216459</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span><span class="o">:</span> <span class="nl">size</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="nl">rmap</span><span class="p">:</span> <span class="n">ffff88207fccefd0</span>
</span><span class="p">[</span> <span class="mf">1863.289265</span><span class="p">]</span> <span class="n">alloc_pcache_rmap</span><span class="p">()</span> <span class="mi">114</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90207fcce000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90207fcce000</span>
</code></pre></div></p>
<p>Analysis: The @prev field in line 7 has address <code>ffff88207fccf000</code>, which happen to the pgd page (<code>pgd ffff88207fccf000</code>). Thus when we do <code>list-&gt;prev = list</code>, it writes to the first 8 bytes of pgd page, corrupts the original pgd entry. That is why we see a corrupted pgd entry (<code>ffff90207fcce000</code>).</p>
<p>This roots from kmalloc, which should not allocate such an object that cross two pages.</p>
<hr />
<h2 id="0308-thur">03/08 Thur<a class="headerlink" href="#0308-thur" title="Permanent link">&para;</a></h2>
<p>Took several days off. This morning finished the porting of <code>wait4</code> and <code>waitid</code>, which actually has a lot code change. The concept and mechanism is fairly simple, but the legacy UNIX tradition make the implementation quite complex.</p>
<p>Now, look back to finish debugging the pcache issue. It must be fixed this week.</p>
<h3 id="python">python<a class="headerlink" href="#python" title="Permanent link">&para;</a></h3>
<p>Tried <code>python hello_world.py</code>, the program runs for a while and crashes at a deterministic point:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="n">and</span> <span class="n">wuklab15</span><span class="p">,</span> <span class="o">~/</span><span class="n">ttyS1</span>
<span class="p">[</span><span class="mf">419097.929969</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a4b008</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
<span class="p">[</span><span class="mf">419098.039145</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">I</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a4c010</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span>
<span class="hll"><span class="p">[</span><span class="mf">419098.306537</span><span class="p">]</span> <span class="n">__pcache_do_fill_page</span><span class="p">()</span><span class="o">:</span> <span class="n">O</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">address</span><span class="p">:</span><span class="mh">0x7ffff7a4c010</span> <span class="nl">flags</span><span class="p">:</span><span class="mh">0x50</span> <span class="nl">ret</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="n">OKAY</span><span class="p">)</span>
</span><span class="p">[</span><span class="mf">419098.413756</span><span class="p">]</span> <span class="n">CPU5</span> <span class="n">PID32</span> <span class="n">sys_mprotect</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span><span class="mf">419098.465753</span><span class="p">]</span> <span class="n">SYSC_mprotect</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3d27</span>
<span class="p">[</span><span class="mf">419098.549990</span><span class="p">]</span>     <span class="nl">start</span><span class="p">:</span><span class="mh">0x7ffff7d8c000</span><span class="p">,</span><span class="nl">len</span><span class="p">:</span><span class="mh">0x2000</span><span class="p">,</span><span class="nl">prot</span><span class="p">:</span><span class="mh">0x1</span>
<span class="hll"><span class="p">[</span><span class="mf">419098.614469</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="n">paging</span> <span class="n">request</span> <span class="n">at</span> <span class="n">ffff9001801ff000</span>
</span><span class="p">[</span><span class="mf">419098.698703</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f7a9</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span><span class="mf">419098.774621</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">419098.799579</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span><span class="mf">419098.848457</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">python</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">312</span>
<span class="p">[</span><span class="mf">419098.916054</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f7a9</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f7a9</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x6c0</span>
<span class="p">[</span><span class="mf">419099.021089</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88107e857ed8</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">000102</span><span class="mi">86</span>
<span class="p">[</span><span class="mf">419099.085567</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="n">ffff9001801ff000</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff9001801ff000</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mf">00003ff</span><span class="n">ffffff000</span>
<span class="p">[</span><span class="mf">419099.171884</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mf">00000801801ff</span><span class="mo">000</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mo">000000000060100</span><span class="mi">8</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffff88107e83d648</span>
<span class="p">[</span><span class="mf">419099.258199</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88107e857f18</span> <span class="nl">R08</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff7fe3000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff7fe3000</span>
<span class="p">[</span><span class="mf">419099.344516</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000206</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">000000000060100</span><span class="mi">8</span>
<span class="p">[</span><span class="mf">419099.430832</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88107e83d648</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">0000000000000050</span> <span class="nl">R15</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff7ffe150</span>
<span class="p">[</span><span class="mf">419099.517149</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mf">00007ff</span><span class="n">ff7fdf740</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88207fc40000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span><span class="mf">419099.614905</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span><span class="mf">419099.684582</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="n">ffff9001801ff000</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mf">000000207f</span><span class="n">ccf000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span><span class="mf">419099.770899</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span><span class="mf">419099.795858</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">ff7d8c000</span> <span class="mo">0000000000002000</span> <span class="mo">0000000000000001</span> <span class="mo">0000000000000004</span>
<span class="p">[</span><span class="mf">419099.884254</span><span class="p">]</span> <span class="mo">000000000060100</span><span class="mi">8</span> <span class="n">ffff88107e857f58</span> <span class="mo">0000000000000000</span> <span class="mf">00007ff</span><span class="n">ff7ffe150</span>
<span class="p">[</span><span class="mf">419099.972650</span><span class="p">]</span> <span class="n">ffff88107e857f48</span> <span class="n">ffffffff81010082</span> <span class="mo">0000000000000000</span> <span class="mo">0000000000000001</span>
<span class="p">[</span><span class="mf">419100.061047</span><span class="p">]</span> <span class="mo">0003</span><span class="mi">92</span><span class="n">c29c720ba2</span> <span class="mo">0000000000000000</span> <span class="mf">00007ff</span><span class="n">fffffdc40</span> <span class="n">ffffffff8100d91f</span>
<span class="p">[</span><span class="mf">419100.149442</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">ff7ffe150</span> <span class="mo">0000000000000000</span> <span class="mo">0003</span><span class="mi">92</span><span class="n">c29c720ba2</span> <span class="mo">0000000000000001</span>
<span class="p">[</span><span class="mf">419100.237839</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span><span class="mf">419100.267998</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span><span class="mf">419100.291917</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81010082</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_page_fault</span><span class="o">+</span><span class="mh">0xa2</span><span class="o">/</span><span class="mh">0x1a0</span>
<span class="p">[</span><span class="mf">419100.357434</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d91f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">page_fault</span><span class="o">+</span><span class="mh">0x1f</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span><span class="mf">419100.418792</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>


<span class="nl">M</span><span class="p">:</span>
<span class="p">...</span>
<span class="p">[</span><span class="mf">419142.163396</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7a4c010</span>
<span class="hll"><span class="p">[</span><span class="mf">419142.268460</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7a4c010</span>
</span><span class="p">(</span><span class="n">Last</span> <span class="n">Message</span><span class="p">)</span>
</code></pre></div></p>
<p>Dig deeper:
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">pcache_handle_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">        <span class="p">..</span>
</span><span class="hll">        <span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</span>        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    addr: %#lx, pgd: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">pgd</span><span class="p">);</span>
        <span class="n">pud</span> <span class="o">=</span> <span class="n">pud_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;    addr: %#lx, pgd: %p pud %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">pgd</span><span class="p">,</span> <span class="n">pud</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pud</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">VM_FAULT_OOM</span><span class="p">;</span>
        <span class="n">pmd</span> <span class="o">=</span> <span class="n">pmd_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">pud</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmd</span><span class="p">)</span>
<span class="p">..</span>
<span class="p">}</span>

<span class="p">[</span><span class="mf">21130.503314</span><span class="p">]</span> <span class="n">strace__mprotect</span> <span class="n">cpu5</span> <span class="n">start</span><span class="o">=</span><span class="mh">0x7ffff7d8c000</span><span class="p">,</span> <span class="n">len</span><span class="o">=</span><span class="mh">0x2000</span><span class="p">,</span> <span class="n">prot</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">=</span><span class="n">PROT_READ</span>
<span class="p">[</span><span class="mf">21130.598994</span><span class="p">]</span> <span class="n">SYSC_mprotect</span><span class="p">()</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">tsk</span><span class="p">(</span><span class="mi">32</span><span class="o">/</span><span class="mi">32</span><span class="o">/</span><span class="n">python</span><span class="p">)</span> <span class="n">user</span><span class="o">-</span><span class="nl">ip</span><span class="p">:</span><span class="mh">0x7ffff7df3d27</span>
<span class="p">[</span><span class="mf">21130.682193</span><span class="p">]</span>     <span class="nl">start</span><span class="p">:</span><span class="mh">0x7ffff7d8c000</span><span class="p">,</span><span class="nl">len</span><span class="p">:</span><span class="mh">0x2000</span><span class="p">,</span><span class="nl">prot</span><span class="p">:</span><span class="mh">0x1</span>
<span class="p">[</span><span class="mf">21130.745635</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x601008</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span>
<span class="p">[</span><span class="mf">21130.805954</span><span class="p">]</span>     <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x601008</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span> <span class="n">pud</span> <span class="n">ffff9001801ff000</span>
<span class="p">[</span><span class="mf">21130.888116</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="n">paging</span> <span class="n">request</span> <span class="n">at</span> <span class="n">ffff9001801ff000</span>
<span class="p">[</span><span class="mf">21130.971314</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102fa11</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x91</span><span class="o">/</span><span class="mh">0x6f0</span>
</code></pre></div></p>
<p>Print pgd and pud info, these three messages are related and the last one leads to panic:
<div class="highlight"><pre><span></span><code><span class="n">wuklab13</span> <span class="o">~/</span><span class="n">ys</span><span class="o">/</span><span class="mo">030</span><span class="mi">8</span><span class="o">-</span><span class="mi">6</span>
<span class="p">[</span>  <span class="mf">479.375498</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x400040</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span>
<span class="p">[</span>  <span class="mf">479.435819</span><span class="p">]</span> <span class="n">pud_alloc_one</span><span class="p">()</span><span class="o">:</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x400040</span><span class="p">,</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fc6f000</span>
<span class="hll"><span class="p">[</span>  <span class="mf">479.511739</span><span class="p">]</span> <span class="n">pud_alloc</span><span class="p">()</span><span class="o">:</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x400040</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fc6f000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fc6f000</span>
</span><span class="p">[</span>  <span class="mf">479.649021</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x400040</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span> <span class="n">pud</span> <span class="n">ffff88207fc6f000</span>

<span class="p">[</span>  <span class="mf">480.016381</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x600dd8</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span>
<span class="hll"><span class="p">[</span>  <span class="mf">480.076701</span><span class="p">]</span> <span class="n">pud_alloc</span><span class="p">()</span><span class="o">:</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x600dd8</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff88207fc6f000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff88207fc6f000</span>
</span><span class="p">[</span>  <span class="mf">480.213982</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x600dd8</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span> <span class="n">pud</span> <span class="n">ffff88207fc6f000</span>

<span class="p">[</span>  <span class="mf">680.072819</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x601008</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span>
<span class="hll"><span class="p">[</span>  <span class="mf">680.133138</span><span class="p">]</span> <span class="n">pud_alloc</span><span class="p">()</span><span class="o">:</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x601008</span> <span class="n">pgd</span> <span class="n">ffff88207fccf000</span><span class="p">,</span> <span class="n">pgd</span><span class="p">.</span><span class="n">cont_va</span> <span class="n">ffff90107e834000</span><span class="p">,</span> <span class="n">pud_index</span><span class="o">=</span><span class="mh">0x0</span> <span class="nl">pud</span><span class="p">:</span> <span class="n">ffff90107e834000</span>
</span><span class="p">[</span>  <span class="mf">680.270422</span><span class="p">]</span> <span class="nl">addr</span><span class="p">:</span> <span class="mh">0x601008</span><span class="p">,</span> <span class="nl">pgd</span><span class="p">:</span> <span class="n">ffff88207fccf000</span> <span class="n">pud</span> <span class="n">ffff90107e834000</span>

<span class="p">[</span>  <span class="mf">680.352583</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="n">paging</span> <span class="n">request</span> <span class="n">at</span> <span class="n">ffff90107e834000</span>
<span class="p">[</span>  <span class="mf">680.435783</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102fc43</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0xb3</span><span class="o">/</span><span class="mh">0x770</span>
<span class="p">[</span>  <span class="mf">680.510664</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
</code></pre></div></p>
<p>I need to check what happens between 480s to 680s. Something in between corrupted pgtable. I doubt it can be:</p>
<ul>
<li>copy_to_user related syscalls</li>
<li>pcache establish mapping, mempcy</li>
<li>all other memcpy strcpy etc stuff</li>
</ul>
<hr />
<h2 id="0302-fri">03/02 Fri<a class="headerlink" href="#0302-fri" title="Permanent link">&para;</a></h2>
<p>TODO:</p>
<ul>
<li><del class="critic">-add vsyscall-</del></li>
<li><del class="critic">-pcache_exit_process: free rmap, free cacheline, etc. When rmap is NULL, we clearly should free this pcache.-</del></li>
<li>pcache_exit_thread? I don&rsquo;t think we need this. All pcache related activities should relate to mm, or thread group leader, not one particular thread.</li>
<li>check python bug</li>
<li>use omnigraffle to draw the whole workflow of pcache.</li>
</ul>
<p>Phoenix, word_count-seq, 4G dataset, 4GB pcache:
<div class="highlight"><pre><span></span><code>[  273.268853] Processor: Processor manager is running.
[  573.272479] page:ffffea0071bb9660 count:0 mapcount:-128
[  573.332903] flags: 0x200000000000300(slab|slob_free)
[  573.392182] page dumped because: VM_BUG_ON_PAGE(page_ref_count(page) == 0)
[  573.474340] ------------[ cut here ]------------
[  573.529459] BUG: failure at ./include/lego/mm.h:251/put_page_testzero()!
[  573.609537] Kernel Panic - not syncing: BUG!
[  573.660496] CPU: 4 PID: 13 Comm: kvictim_flushd 4.0.0-lego+ #18
[  573.731212] Stack:
[  573.755132] ffff88207e4bfe10 ffffffff81023644 0000000000000008 ffff88207e4bfe20
[  573.842490] ffff88207e4bfdd8 0000000021475542 0000000000000000 0000000000000000
[  573.929848] 0000000000000000 0000000000000000 0000000000000000 0000000000000000
[  574.017205] 0000000000000000 0000000000000000 0000000000000000 0000000000000000
[  574.104563] 0000000000000000 0000000000000000 0000000000000000 0000000000000000
[  574.191921] Call Trace:
[  574.221039] &lt;TSK&gt;
[  574.243919] [&lt;ffffffff81023650&gt;] panic+0xc2/0xeb
[  574.299038] [&lt;ffffffff8105a35a&gt;] ? client_internal_poll_sendcq+0x2a/0x80
[  574.379115] [&lt;ffffffff8105a4fd&gt;] ? client_send_message_with_rdma_write_with_imm_request+0x14d/0x360
[  574.487273] [&lt;ffffffff8101ac3c&gt;] ? task_tick_rt+0x2c/0xd0
[  574.551751] [&lt;ffffffff81018395&gt;] ? scheduler_tick+0x55/0x60
[  574.618308] [&lt;ffffffff81015a45&gt;] ? tick_handle_periodic+0x45/0x70
[  574.691107] [&lt;ffffffff810064c4&gt;] ? apic_timer_interrupt+0x54/0x90
[  574.763905] [&lt;ffffffff8100dbaa&gt;] ? smp__apic_timer_interrupt+0x6a/0x70
[  574.841903] [&lt;ffffffff8101198d&gt;] ? printk+0x11d/0x1b0
[  574.902222] [&lt;ffffffff81025c00&gt;] __free_pages+0x2e0/0x3c0
[  574.966699] [&lt;ffffffff81028472&gt;] kfree+0x62/0x480
[  575.022858] [&lt;ffffffff8102e6be&gt;] victim_flush_func+0x15e/0x1e0
[  575.092536] [&lt;ffffffff8102e560&gt;] ? victim_try_fill_pcache+0x390/0x390
[  575.169494] [&lt;ffffffff8101e446&gt;] kthread+0xf6/0x120
[  575.227733] [&lt;ffffffff8101e350&gt;] ? __kthread_parkme+0x70/0x70
[  575.296371] [&lt;ffffffff8100de32&gt;] ret_from_fork+0x22/0x30
[  575.359810] &lt;EOT&gt;
</code></pre></div></p>
<hr />
<h2 id="0301-thur">03/01 Thur<a class="headerlink" href="#0301-thur" title="Permanent link">&para;</a></h2>
<p>Weird.
<div class="highlight"><pre><span></span><code>[43181.388400] p2m_fork(cpu5): I cur:24-word_count-seq new:25
[43181.435341] p2m_fork(cpu5): O succeed cur:24-word_count-seq new:25
[43181.436013] __pcache_do_fill_page(): I pid:24 tgid:24 address:0x4158d0 flags:0x150
[43181.439246] __pcache_do_fill_page(): O pid:24 tgid:24 address:0x4158d0 flags:0x150 ret:0(OKAY) csum:0x9e8f028e

[43181.510534] __pcache_do_fill_page(): I pid:25 tgid:25 address:0x415000 flags:0x150
[43181.517729] __pcache_do_fill_page(): O pid:25 tgid:25 address:0x415000 flags:0x150 ret:0(OKAY) csum:0xffff88029e8f028e
</code></pre></div></p>
<p>After all, it is TLB issue. I forgot to flush tlb after making the original pte read-only during fork. So the parent will be also to continue RW some pages, which should be process-private.</p>
<p>Lego&rsquo;s current TLB flush is very native, we do tlbflush after each pte changes. This will have worse performance compared to linux&rsquo;s batch flush.</p>
<p>Today&rsquo;s case is flush tlb after making pte read-only. And this really has to be performed one by one</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: March 31, 2018
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="http://lastweek.io/lego/log/log-03-2018/",this.page.identifier="/lego/log/log-03-2018/"};!function(){var e=document,i=e.createElement("script");i.src="//lastweek-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ["instant", "tabs"],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>