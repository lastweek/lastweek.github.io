
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/log/log-08-2018/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.4">
    
    
      
        <title>Aug 2018 - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.db9e7362.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime+Bold:300,400,400i,700%7CCourier+Prime+Bold&display=fallback">
        <style>:root{--md-text-font-family:"Courier Prime Bold";--md-code-font-family:"Courier Prime Bold"}</style>
      
    
    
    
    
      
  



  
  



  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aug-2018" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-header__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Yizhou Shan's Home Page
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Aug 2018
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lastweek/lastweek.github.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M105.2 24.9c-3.1-8.9-15.7-8.9-18.9 0L29.8 199.7h132c-.1 0-56.6-174.8-56.6-174.8zM.9 287.7c-2.6 8 .3 16.9 7.1 22l247.9 184-226.2-294zm160.8-88 94.3 294 94.3-294zm349.4 88-28.8-88-226.3 294 247.9-184c6.9-5.1 9.7-14 7.2-22zM425.7 24.9c-3.1-8.9-15.7-8.9-18.9 0l-56.6 174.8h132z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../notes/ssd/" class="md-tabs__link">
        Notes
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../notes/source_code/summary/" class="md-tabs__link">
        Code
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../fpga/bitstream/" class="md-tabs__link">
        FPGA
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../misc/" class="md-tabs__link">
        LegoOS
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lastweek/lastweek.github.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M105.2 24.9c-3.1-8.9-15.7-8.9-18.9 0L29.8 199.7h132c-.1 0-56.6-174.8-56.6-174.8zM.9 287.7c-2.6 8 .3 16.9 7.1 22l247.9 184-226.2-294zm160.8-88 94.3 294 94.3-294zm349.4 88-28.8-88-226.3 294 247.9-184c6.9-5.1 9.7-14 7.2-22zM425.7 24.9c-3.1-8.9-15.7-8.9-18.9 0l-56.6 174.8h132z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Notes" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/ssd/" class="md-nav__link">
        SSD 101
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/CXL/" class="md-nav__link">
        What is CXL?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/MLIR/" class="md-nav__link">
        What is MLIR?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/virt/" class="md-nav__link">
        Modern Virtualization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cache_coherence/" class="md-nav__link">
        Practical Cache Coherence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/resource-disaggregation-spectrum/" class="md-nav__link">
        Resource Disaggregation Design Spectrums
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dist-xact/" class="md-nav__link">
        Distributed Transactions and Databases
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dynamic_linking/" class="md-nav__link">
        Dynamic Linking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dcn/" class="md-nav__link">
        Data Center Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/packet-sched/" class="md-nav__link">
        Switch Buffering and Packet Scheduling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/sysml/" class="md-nav__link">
        SysML
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/arch/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cryptography/" class="md-nav__link">
        Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cryptocurrency/" class="md-nav__link">
        Cryptocurrency
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/hardware_pl/" class="md-nav__link">
        Hardware Design Languages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/paper_perf_shadows/" class="md-nav__link">
        Performance-Shadows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/essential/" class="md-nav__link">
        Essential
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/cheatsheet/" class="md-nav__link">
        Cheatsheet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/20200404-on-read-once/" class="md-nav__link">
        On Read Once and Compiler Optimization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/summary/" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/" class="md-nav__link">
        Linux Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-function-trace/" class="md-nav__link">
        Linux Dump Function Graph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/fork/" class="md-nav__link">
        Linux fork/switch_to
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-rcu/" class="md-nav__link">
        Linux RCU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-completion/" class="md-nav__link">
        Linux Completion/swait
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-workqueue/" class="md-nav__link">
        Linux workqueue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-linker-script/" class="md-nav__link">
        Linux Linker Script
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-boot/" class="md-nav__link">
        Linux Boot Sequence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/trace/" class="md-nav__link">
        Linux Trace and Profile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rmap/" class="md-nav__link">
        Linux Reverse Mapping
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/userfaultfd/" class="md-nav__link">
        Linux Userfaultfd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cgroup-swap/" class="md-nav__link">
        Linux Cgroup and Swap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/xperf/" class="md-nav__link">
        Linux x86 Ring Switch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-x86-fpu/" class="md-nav__link">
        Linux FPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-iouring/" class="md-nav__link">
        Linux io_uring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-resource/" class="md-nav__link">
        Linux Resource
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/proc/" class="md-nav__link">
        Linux Special Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/kvm-basic/" class="md-nav__link">
        Linux KVM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/rust.md" class="md-nav__link">
        Linux Rust
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Go" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Go
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/go/golang/" class="md-nav__link">
        Learn Go
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/go/gvisor/" class="md-nav__link">
        gVisor
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Rust
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Rust" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rust/rust/" class="md-nav__link">
        Learn Rust
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rust/firecracker.md" class="md-nav__link">
        Firecracker
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/rdma/" class="md-nav__link">
        DPDK and RDMA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/program_advice/" class="md-nav__link">
        Guideline & Advice
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/firmware-softwares/" class="md-nav__link">
        Firmware & Bootloader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/os/" class="md-nav__link">
        Operating System
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/compilers/" class="md-nav__link">
        Compilers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/unix-tools/" class="md-nav__link">
        Unix Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/virt/" class="md-nav__link">
        Virtualization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/20200501-on-graphic-softwares/" class="md-nav__link">
        Graphics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/gpu/" class="md-nav__link">
        GPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/fpga/" class="md-nav__link">
        FPGA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/risc-v/" class="md-nav__link">
        RISC-V
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/dotconfigs/" class="md-nav__link">
        Dot-Configs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          FPGA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="FPGA" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          FPGA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/bitstream/" class="md-nav__link">
        Bitstream Explained
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/paper_fpga/" class="md-nav__link">
        Papers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/language/" class="md-nav__link">
        Languages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/vivado/" class="md-nav__link">
        Vivado Notes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/setup_hold/" class="md-nav__link">
        Setup and Hold Time
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/pr/" class="md-nav__link">
        Partial Reconfiguration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          LegoOS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="LegoOS" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          LegoOS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Log
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Log" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Log
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        MISC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../test-note/" class="md-nav__link">
        Test Script
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Kernel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kernel" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Kernel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/boot/" class="md-nav__link">
        GRUB2 and Boot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/kconfig/" class="md-nav__link">
        Kconfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/debug/" class="md-nav__link">
        Debug
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/grub/" class="md-nav__link">
        GRUB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile/" class="md-nav__link">
        Profile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_strace/" class="md-nav__link">
        Profile strace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_heatmap/" class="md-nav__link">
        Profile heatmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_points/" class="md-nav__link">
        Profile points
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/trampoline/" class="md-nav__link">
        Trampoline
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/pagefault_disable/" class="md-nav__link">
        Disable pgfault
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/stop_machine/" class="md-nav__link">
        Stop machine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/loader/" class="md-nav__link">
        Program Loader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vDSO/" class="md-nav__link">
        vDSO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vfs/" class="md-nav__link">
        Virtual File System
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vm/" class="md-nav__link">
        Process Virtual Memory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/fpu/" class="md-nav__link">
        x86 FPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/irq/" class="md-nav__link">
        IRQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/net_thpool/" class="md-nav__link">
        Network Thpool
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Syscall
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Syscall" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Syscall
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/facts/" class="md-nav__link">
        Facts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_strace/" class="md-nav__link">
        strace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/compat/" class="md-nav__link">
        compat
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/msync/" class="md-nav__link">
        msync()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/mremap/" class="md-nav__link">
        mremap()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/fork/" class="md-nav__link">
        fork()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/getrusage/" class="md-nav__link">
        getrusage()
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../syscall/wait_and_exit/" class="md-nav__link">
        wait4 and exit()
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_4">
          Pcache
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pcache" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Pcache
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/config/" class="md-nav__link">
        Config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/sweep/" class="md-nav__link">
        Sweep
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/tlb/" class="md-nav__link">
        TLB Coherence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/pgtable-lock/" class="md-nav__link">
        PageTable Lock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/victim/" class="md-nav__link">
        Victim Cache
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/virtual_cache/" class="md-nav__link">
        Virtual Cache
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/rmap/" class="md-nav__link">
        Reverse Mapping
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/evict_and_ref/" class="md-nav__link">
        Evict and Refcount
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/smp_design/" class="md-nav__link">
        SMP Design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/replication/" class="md-nav__link">
        Replication
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_5">
          Driver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Driver" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Driver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../driver/pci/" class="md-nav__link">
        PCI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../driver/ib/" class="md-nav__link">
        Infiniband
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_6" type="checkbox" id="__nav_5_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_6">
          Paper
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_6">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/nmp/" class="md-nav__link">
        NMP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/processor_oom/" class="md-nav__link">
        Processor OOM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/genz/" class="md-nav__link">
        Gen-Z
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/replication/" class="md-nav__link">
        Replication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/related/" class="md-nav__link">
        Related
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aug-31" class="md-nav__link">
    Aug 31
  </a>
  
    <nav class="md-nav" aria-label="Aug 31">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#one-major-todo" class="md-nav__link">
    One major TODO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ugh" class="md-nav__link">
    Ugh
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try-max_send_wr-and-number-of-qps" class="md-nav__link">
    Try max_send_wr and number of QPs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after-victim-bug-fix" class="md-nav__link">
    After Victim bug fix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aug-30" class="md-nav__link">
    Aug 30
  </a>
  
    <nav class="md-nav" aria-label="Aug 30">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identified-victim-bug" class="md-nav__link">
    Identified victim bug.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#after-adding-pi_lock" class="md-nav__link">
    After adding pi_lock
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/lastweek/lastweek.github.io/edit/master/docs/lego/log/log-08-2018.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="aug-2018">Aug 2018<a class="headerlink" href="#aug-2018" title="Permanent link">&para;</a></h1>
<h2 id="aug-31">Aug 31<a class="headerlink" href="#aug-31" title="Permanent link">&para;</a></h2>
<h3 id="one-major-todo">One major TODO<a class="headerlink" href="#one-major-todo" title="Permanent link">&para;</a></h3>
<p>Check <code>do_handle_p2m_pcache_miss()</code>. We MUST remove that mempcy, maybe by using another flag in thpool. This is just no acceptable.</p>
<h3 id="ugh">Ugh<a class="headerlink" href="#ugh" title="Permanent link">&para;</a></h3>
<p>Fuck. Without debug_mm, there is still memory corruption.</p>
<h3 id="try-max_send_wr-and-number-of-qps">Try max_send_wr and number of QPs<a class="headerlink" href="#try-max_send_wr-and-number-of-qps" title="Permanent link">&para;</a></h3>
<p>without lock_ib, with debug_mm.
Change max_send_wr at all P M S.</p>
<ul>
<li>QP=4, max_send_wr = 1: always fail</li>
<li>QP=4, max_send_wr = 256: always fail</li>
<li>QP=24, max_send_wr = 1: succeed (0831-w14-18 0831-w14-20)</li>
<li>QP=24, max_send_wr = 256: succeed (0831-w14-16 0831-w14-17)</li>
</ul>
<p>Pay attention to the <code>0831-w14-15</code>： something wrong with our timekeeping code? QP=24, max_send_wr = 1 case.</p>
<h3 id="after-victim-bug-fix">After Victim bug fix<a class="headerlink" href="#after-victim-bug-fix" title="Permanent link">&para;</a></h3>
<p>MNIST 4 threads</p>
<ul>
<li>With lock_ib, debug_mm etc: 3 successful runs</li>
<li>Only with debug_mm: Well fit failed. Lost CQE.</li>
</ul>
<p>Now the debug scope is limited. Let me try the micro test suite, to stress ibapi_send_reply itself.</p>
<p>Potential: read/write buffer.</p>
<h2 id="aug-30">Aug 30<a class="headerlink" href="#aug-30" title="Permanent link">&para;</a></h2>
<p>Be humble.</p>
<h3 id="identified-victim-bug">Identified victim bug.<a class="headerlink" href="#identified-victim-bug" title="Permanent link">&para;</a></h3>
<p>Finally. I thought it through, and with the help of this <code>0830-w14-12</code>.
The bug is in <code>victim_try_fill_pcache()</code>, when there are multiple hits to the same victim. Since we released the <code>usable_victim_lock</code> after a hit. There might a be race case where: 1) CPU0 reached <code>dec_and_test_filling</code>, and passed to free the line. 2) CPU1 just got to the <code>victim_check_hit</code>, and increment the fill counter to 1 again. When CPU1 finished filling, and do <code>dec_and_test_filling</code>, it will do the free again!!! What a double free.</p>
<p>Tomorrow, let me do the fix. Thought: adding more sync in victim_check_hit part. Basically we want to ensure only one CPU can do the final free.</p>
<h3 id="after-adding-pi_lock">After adding pi_lock<a class="headerlink" href="#after-adding-pi_lock" title="Permanent link">&para;</a></h3>
<p>Okay. the pi_lock is added. Although it is mostly used by futex-pi and rt-mutex, we lego does not have these two guys. Therefore, it is only used by sched/core.c, exit.c, and kthread.c. 99% is in core.c</p>
<p>The purpose of having this back is to have the <code>spin_lock_irqsave(&amp;p-&gt;pi_lock)</code> back. Most scheduling code is not recursive, we have to disable interrupt. Of course we can use <code>spin_lock_irqsave(&amp;rq-&gt;lock)</code> instead of <code>spin_lock(&amp;rq-&gt;lock)</code>. But this is too dangerous at this stage. Porting based on Linux now is the fastest and safest way.</p>
<p><strong>The importance of disabling interrupt in some kernel path!!</strong></p>
<p>Good. Now I&rsquo;m seeing now debuggable victim issue.</p>
<p>Classical deadlock catched. Now, only two victims.</p>
<p>```c
[ 2819.068997] CPU14 PID29 Abort victim alloc (20010ms) nr_usable_victims: 2. From pset_idx:532 nr_lru:63 fault_uva: 0x7fff98614000
[ 2819.094409] CPU14 PID29   &ndash;   Start Dump Victim Cache [0] total: 2
[ 2819.114188] CPU14 PID29  victim[0]:ffffffff810c2880 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.133289] CPU14 PID29     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffcc000000
[ 2819.141723] CPU14 PID29     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.149770] CPU14 PID29  victim[1]:ffffffff810c2900 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.168870] CPU14 PID29     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffb0000000
[ 2819.177306] CPU14 PID29     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.185352] CPU14 PID29   &ndash;   End Dump Victim Cache [0]</p>
<p>[ 2819.081708] CPU16 PID30 Abort victim alloc (20010ms) nr_usable_victims: 2. From pset_idx:0 nr_lru:63 fault_uva: 0x7fffcc000024
[ 2819.209008] CPU16 PID30   &ndash;   Start Dump Victim Cache [1] total: 2
[ 2819.223358] CPU16 PID30  victim[0]:ffffffff810c2880 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.252443] CPU16 PID30     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffcc000000
[ 2819.260879] CPU16 PID30     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.268926] CPU16 PID30  victim[1]:ffffffff810c2900 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.288026] CPU16 PID30     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffb0000000
[ 2819.296461] CPU16 PID30     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.304508] CPU16 PID30   &ndash;   End Dump Victim Cache [1]</p>
<p>[ 2819.101391] CPU18 PID31 Abort victim alloc (20010ms) nr_usable_victims: 2. From pset_idx:15 nr_lru:63 fault_uva: 0x7fff98c0f000
[ 2819.328165] CPU18 PID31   &ndash;   Start Dump Victim Cache [2] total: 2
[ 2819.335146] CPU18 PID31  victim[0]:ffffffff810c2880 refcount:1 nr_fill:0 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.354246] CPU18 PID31     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffcc000000
[ 2819.362680] CPU18 PID31     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.370728] CPU18 PID31  victim[1]:ffffffff810c2900 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2819.389828] CPU18 PID31     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffb0000000
[ 2819.398262] CPU18 PID31     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2819.406310] CPU18 PID31   &ndash;   End Dump Victim Cache [2]</p>
<h1 id="_1"><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h1 id="this-guy-grabbed-the-fill-counter-right-before-the-first-timout">This guy grabbed the fill counter right before the first timout<a class="headerlink" href="#this-guy-grabbed-the-fill-counter-right-before-the-first-timout" title="Permanent link">&para;</a></h1>
<h1 id="thats-why-the-above-three-timeout-happen-and-this-one-is-20s-later">That&rsquo;s why the above three timeout happen. And this one is 20s later<a class="headerlink" href="#thats-why-the-above-three-timeout-happen-and-this-one-is-20s-later" title="Permanent link">&para;</a></h1>
<h1 id="which-equals-to-the-timeout-second">which equals to the timeout second.<a class="headerlink" href="#which-equals-to-the-timeout-second" title="Permanent link">&para;</a></h1>
<h1 id="_2"><a class="headerlink" href="#_2" title="Permanent link">&para;</a></h1>
<p>[ 2839.327457] CPU12 PID28 Abort victim alloc (20010ms) nr_usable_victims: 2. From pset_idx:0 nr_lru:63 fault_uva: 0x7fffb0000f00
[ 2839.339964] CPU12 PID28   &ndash;   Start Dump Victim Cache [3] total: 2
[ 2839.346945] CPU12 PID28  victim[0]:ffffffff810c2880 refcount:1 nr_fill:0 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2839.366046] CPU12 PID28     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffcc000000
[ 2839.374480] CPU12 PID28     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2839.382527] CPU12 PID28  victim[1]:ffffffff810c2900 refcount:2 nr_fill:1 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5a000
[ 2839.401628] CPU12 PID28     hit[0] owner:21 m_nid:1 rep_nid:1 addr: 0x7fffb0000000
[ 2839.410062] CPU12 PID28     rmap to pset:ffff88207ff5a000 set_idx: 0 nr_lru:63
[ 2839.418109] CPU12 PID28   &ndash;   End Dump Victim Cache [3]
```</p>
<h3 id="rq-lock-deadlock">rq-&gt;lock deadlock<a class="headerlink" href="#rq-lock-deadlock" title="Permanent link">&para;</a></h3>
<p>Alright. We had rq-&gt;lock deadlock issue. Basically, we missed the part of disabling interrupt. A timer interrupt will try to acquire the lock again. Then, bang we have a deadlock. Digging into the code, you will be able to find the cause easily. The root cause we removed all the pi_lock stuff, which actually have a lot irqsave usages&hellip; Oh man, maybe it&rsquo;s time to add it back.</p>
<p><code>[ 3367.835389] ------------------- cut here -------------------
[ 3367.841504] Possible deadlock happend locker_cpu: 0
[ 3367.846934] Current call stack:
[ 3367.850425] CPU: 0 PID: 1 Comm: kernel_init 4.0.0-lego+ #437
[ 3367.856726] Stack:
[ 3367.858957] ffff88107ff0fa58 ffffffff8101f4b6 ffff88107fc05e00 00000004a817c800
[ 3367.867101] ffff88107ff0fa80 ffffffff8101f52e ffff88107fc05e00 ffff88107ffb4000
[ 3367.875246] 0000000000000000 ffff88107ff0faa0 ffffffff8101b1ae ffff88107fc04980
[ 3367.883390] 0000000000000000 ffff88107ff0fab8 ffffffff810174f5 0000000000000286
[ 3367.891535] ffff88107ff0fae0 ffffffff81006774 ffff88107ffb9000 ffff88107fc05e00
[ 3367.899680] Call Trace:
[ 3367.902396] &lt;TSK&gt;
[ 3367.904528] [&lt;ffffffff8101f4c2&gt;] report_deadlock+0x62/0x80
[ 3367.910637] [&lt;ffffffff8101f52e&gt;] debug_spin_lock+0x4e/0x60
[ 3367.916745] [&lt;ffffffff8101b1ae&gt;] scheduler_tick+0x2e/0x60
[ 3367.922756] [&lt;ffffffff810174f5&gt;] tick_handle_periodic+0x45/0x70
[ 3367.929350] [&lt;ffffffff81006774&gt;] apic_timer_interrupt+0x54/0x90
[ 3367.935943] [&lt;ffffffff8100e8aa&gt;] smp__apic_timer_interrupt+0x6a/0x70
[ 3367.943021] [&lt;ffffffff8101db99&gt;] ? enqueue_task_rt+0x149/0x250
[ 3367.949518] [&lt;ffffffff8105908a&gt;] ? __mlx4_write_mtt+0xea/0x140
[ 3367.956014] [&lt;ffffffff8101ad34&gt;] activate_task+0x44/0x50
[ 3367.961929] [&lt;ffffffff8101b667&gt;] ttwu_do_activate+0x27/0x50
[ 3367.968134] [&lt;ffffffff8101b89c&gt;] try_to_wake_up+0xdc/0x1f0
[ 3367.974243] [&lt;ffffffff8106cc20&gt;] ? ib_mad_send_done_handler.isra.22+0x4d0/0x4d0
[ 3367.982388] [&lt;ffffffff8101ba80&gt;] wake_up_process+0x10/0x20
[ 3367.988497] [&lt;ffffffff81023116&gt;] __kthread_create_on_node+0x146/0x230
[ 3367.995671] [&lt;ffffffff8102329f&gt;] kthread_create_on_node+0x2f/0x40
[ 3368.002459] [&lt;ffffffff81066873&gt;] ? ib_create_cq+0x23/0x60
[ 3368.008470] [&lt;ffffffff810695e1&gt;] ib_mad_init_device+0x1f1/0x7b0
[ 3368.015064] [&lt;ffffffff81067246&gt;] ib_register_device+0x5d6/0x690
[ 3368.021657] [&lt;ffffffff8105e9d3&gt;] mlx4_ib_add+0x653/0x780
[ 3368.027571] [&lt;ffffffff8105147d&gt;] mlx4_add_device+0x8d/0x130
[ 3368.033777] [&lt;ffffffff8105158c&gt;] mlx4_register_interface+0x6c/0xa0
[ 3368.040661] [&lt;ffffffff811dc660&gt;] mlx4_ib_init+0x10/0x20
[ 3368.046478] [&lt;ffffffff811dc619&gt;] mlx4_init+0x19/0x50
[ 3368.052005] [&lt;ffffffff811dc68d&gt;] ib_core_init+0x1d/0x30
[ 3368.057823] [&lt;ffffffff811db7f9&gt;] device_init+0x9/0x10
[ 3368.063447] [&lt;ffffffff8100030b&gt;] kernel_init+0x4b/0xc0
[ 3368.069168] [&lt;ffffffff8101b0ea&gt;] ? schedule_tail+0xa/0x40
[ 3368.075178] [&lt;ffffffff810002c0&gt;] ? 0xffffffff810002c0
[ 3368.080803] [&lt;ffffffff8100eb32&gt;] ret_from_fork+0x22/0x30
[ 3368.086718] &lt;EOT&gt;</code></p>
<p>0830-w14-1: I really don&rsquo;t know how this happen. The refcounter and fill counter should be enough to serialize..
```
[37722.177024] CPU20 PID31  victim:ffffffff810c2880 index:0 refcount:0 nr_fill:0 max_fill:4 locked:0 flags:(0x12e)(allocated|usable|hasdata|waitflush|fillfree) pcm:          (null) pset:ffff88207ff5b980
[37722.196623] CPU20 PID31     hit[0] owner:22 m_nid:1 rep_nid:1 addr: 0x2c33000
[37722.204572] CPU20 PID31  victim:ffffffff810c2880 index:0 refcount:0 nr_fill:0 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5b980
[37722.224154] CPU20 PID31     rmap to pset:ffff88207ff5b980 set_idx: 51 nr_lru:63
[37722.232299] CPU20 PID31     victim dumped because: PCACHE_BUG_ON_VICTIM(!VictimAllocated(v) || !VictimUsable(v) || !VictimFlushed(v) || VictimWriteback(v) || VictimLocked(v))
[37722.254790] WARNING: CPU: 20 PID: 31 at managers/processor/pcache/victim.c:196 __put_victim_nolist+0xb8/0x140
 ffffffff8103e170[37722.453632] [<ffffffff8103c9c8>] __put_victim_nolist+0xb8/0x140
 0000000000000000[37722.461873] [<ffffffff8103db18>] victim_try_fill_pcache+0x2f8/0x440</p>
<p>[37722.265842] CPU10 PID20  victim:ffffffff810c2880 index:0 refcount:0 nr_fill:0 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5b980
[37722.291438] CPU10 PID20     hit[0] owner:22 m_nid:1 rep_nid:1 addr: 0x2c33000
[37722.301616] CPU10 PID20  victim:ffffffff810c2880 index:0 refcount:0 nr_fill:0 max_fill:4 locked:0 flags:(0x14e)(allocated|usable|hasdata|flushed|fillfree) pcm:          (null) pset:ffff88207ff5b980
[37722.324206] CPU10 PID20     rmap to pset:ffff88207ff5b980 set_idx: 51 nr_lru:63
[37722.332349] CPU10 PID20     victim dumped because: PCACHE_BUG_ON_VICTIM(victim_ref_count(v) == 0)
[37722.350673] WARNING: CPU: 10 PID: 20 at ./include/processor/pcache_victim.h:127 __victim_flush_func+0x232/0x250
[37722.363568] CPU: 10 PID: 20 Comm: kvictim_flushd 4.0.0-lego+ #435
[37722.534003] [<ffffffff8103e152>] __victim_flush_func+0x232/0x250
[37722.547577] [<ffffffff8103e1d9>] victim_flush_async+0x69/0xb0
[37722.553975] [<ffffffff81022ec1>] kthread+0x111/0x130
[37722.565900] [<ffffffff8100eb32>] ret_from_fork+0x22/0x30
```</p>
<h2 id="aug-29">Aug 29<a class="headerlink" href="#aug-29" title="Permanent link">&para;</a></h2>
<p>The only thing left about core_IB is: ib_sa_query, which will be invoked when there is a mlx4 interrupts.</p>
<p>Not sure if this is important.</p>
<p>Anyway. Testing TF 4 threads MNIST again.</p>
<p>When I enable SEQ_IBAPI：</p>
<ul>
<li>0829-w14-11 (0829-w09-11) succeed</li>
<li>0829-w14-12: P side seems have deadlock. Let me enable DEBUG_SPINLOCK.</li>
<li>0829-w14-13: SEQ_IBAPI, DEBUG_SPINLOCK, this is a very useful log:
```c
[  531.495545] STDOUT: &mdash;[
INFO:tensorflow:loss = 0.5256375, step = 101 (25.166 sec)</li>
</ul>
<p>]&mdash;
[  531.624474] BUG: unable to handle kernel NULL pointer dereference at 0000000000000064
[  531.633016] IP: [<ffffffff8103b60e>] __put_victim_nolist+0xe/0xa0
[  531.639803] PGD 0
[  531.642032] Oops: 0002 [#1] SMP PROCESSOR
[  531.646493] CPU: 10 PID: 20 Comm: kvictim_flushd 4.0.0-lego+ #426
[  531.653279] RIP: 0010:[<ffffffff8103b60e>]  [<ffffffff8103b60e>] __put_victim_nolist+0xe/0xa0
[  531.662781] RSP: 0000:ffff880fe392fde0  EFLAGS: 00010006
[  531.668696] RAX: 0000000000000000 RBX: ffffffff810c2b00 RCX: ffffffff810c2b70
[  531.676646] RDX: ffffffff810c2b70 RSI: 0000007aea3f42fa RDI: ffffffff810c2b00
[  531.684597] RBP: ffff880fe392fdf0 R08: 000000000000001f R09: 0000000000000002
[  531.692548] R10: 0000000080000000 R11: 00000000000664c3 R12: ffff88207ff57000
[  531.700498] R13: ffffffff810c2b60 R14: ffff880a72555000 R15: ffffffff810c2b48
[  531.708449] FS:  0000000000000000(0000) GS:ffff88107fca0000(0000) knlGS:0000000000000000
[  531.717466] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[  531.723865] CR2: 0000000000000064 CR3: 00000000011b9000 CR4: 00000000000406a0
[  531.731816] Stack:
[  531.734046] ffffffff810c2b00 ffff88207ff57000 ffff880fe392fe08 ffffffff8103bbea
[  531.742190] ffffffff810c2b00 ffff880fe392fe48 ffffffff8103c729 000000008103d7c2
[  531.750335] ffff880a72555060 ffff88107ff0fdc8 0000000000000000 ffffffff8103c780
[  531.758479] 0000000000000000 ffff880fe392fe60 ffffffff8103c7e6 ffff880fe391c000
[  531.766623] ffff880fe392ff48 ffffffff81022e81 0000000000000000 0000000000000000
[  531.774768] Call Trace:
[  531.777483] <TSK>
[  531.779617] [<ffffffff8103bbea>] __put_victim+0x4a/0x50
[  531.785433] [<ffffffff8103c729>] __victim_flush_func+0xb9/0x110
[  531.792027] [<ffffffff8103c780>] ? __victim_flush_func+0x110/0x110
[  531.798911] [<ffffffff8103c7e6>] victim_flush_async+0x66/0x90
[  531.805310] [<ffffffff81022e81>] kthread+0x111/0x130
[  531.810836] [<ffffffff81022d70>] ? __kthread_parkme+0x70/0x70
[  531.817236] [<ffffffff8100eb32>] ret_from_fork+0x22/0x30
[  531.823151] <EOT>
```</p>
<ul>
<li>0829-w14-14: this looks like a double free, or concurrent eviction. But if you look into the evict code, we will check the Flushed flag. It means another eviction routine should have skipped this line, and will not pick this line to do eviction. Some other possibilities?</li>
<li>
<p>check until 0829-w14-18
<code>c
[ 1671.661424] ------------[ cut here ]------------
[ 1671.666378] BUG: failure at managers/processor/pcache/victim.c:610/victim_finish_insert()!
[ 1671.675591] Kernel Panic - not syncing: BUG!
[ 1671.680339] CPU: 20 PID: 31 Comm: python 4.0.0-lego+ #426
[ 1671.686351] Stack:
[ 1671.688581] ffff880fbe76fda0 ffffffff810289b7 ffffffff00000008 ffff880fbe76fdb0
[ 1671.696725] ffff880fbe76fd68 ffffff0021475542 ffff88107fd45e00 ffff880fbe753000
[ 1671.704870] 0000000000000000 0000000000000001 ffff880fbe76f9b0 ffffffff8101b1b7
[ 1671.713015] ffff88107fd44980 ffff880fbe76f9d8 ffffffff8101405f 0000000000000000
[ 1671.721160] 0000000000000001 ffff880ff992a000 0000000000000001 ffff880fbe76f9f0
[ 1671.729304] Call Trace:
[ 1671.732019] &lt;TSK&gt;
[ 1671.734153] [&lt;ffffffff810289c3&gt;] panic+0xc2/0x10a
[ 1671.739388] [&lt;ffffffff8101b1b7&gt;] ? scheduler_tick+0x57/0x60
[ 1671.745593] [&lt;ffffffff8101405f&gt;] ? generic_smp_call_function_single_interrupt+0x8f/0x160
[ 1671.754611] [&lt;ffffffff8100339e&gt;] ? call_function_interrupt+0x2e/0x40
[ 1671.761688] [&lt;ffffffff8100e9fa&gt;] ? smp__call_function_interrupt+0x6a/0x70
[ 1671.769251] [&lt;ffffffff8101f4bb&gt;] ? debug_spin_lock+0x1b/0x50
[ 1671.775555] [&lt;ffffffff81075efc&gt;] ? fit_internal_poll_sendcq+0x6c/0x140
[ 1671.782826] [&lt;ffffffff81042039&gt;] ? find_next_bit+0x19/0x20
[ 1671.788934] [&lt;ffffffff8101f4bb&gt;] ? debug_spin_lock+0x1b/0x50
[ 1671.795236] [&lt;ffffffff8101dcac&gt;] ? task_tick_rt+0x2c/0xd0
[ 1671.801248] [&lt;ffffffff8101b1b7&gt;] ? scheduler_tick+0x57/0x60
[ 1671.807453] [&lt;ffffffff810174d5&gt;] ? tick_handle_periodic+0x45/0x70
[ 1671.814240] [&lt;ffffffff81006774&gt;] ? apic_timer_interrupt+0x54/0x90
[ 1671.821029] [&lt;ffffffff8100e8aa&gt;] ? smp__apic_timer_interrupt+0x6a/0x70
[ 1671.828300] [&lt;ffffffff81012bc8&gt;] ? printk+0x118/0x1b0
[ 1671.833924] [&lt;ffffffff8103c161&gt;] victim_finish_insert+0x171/0x180
[ 1671.840711] [&lt;ffffffff8103b2a2&gt;] pcache_evict_line+0xf2/0x2e0
[ 1671.847110] [&lt;ffffffff81038d7c&gt;] pcache_alloc+0x1ac/0x380
[ 1671.853122] [&lt;ffffffff8103a10c&gt;] ? pcache_add_rmap+0x7c/0x260
[ 1671.859521] [&lt;ffffffff810382bb&gt;] common_do_fill_page+0x2b/0x1e0
[ 1671.866114] [&lt;ffffffff81038631&gt;] pcache_handle_fault+0x1c1/0x620
[ 1671.872804] [&lt;ffffffff81037fc0&gt;] ? pcache_meta_to_kva+0x30/0x30
[ 1671.879398] [&lt;ffffffff8101006f&gt;] do_page_fault+0xaf/0x1c0
[ 1671.885410] [&lt;ffffffff8100dedf&gt;] page_fault+0x1f/0x30</code></p>
</li>
<li>
<p>0829-w14-16: we got this by having debug_spinlock, and seq_ibapi. This is interesting and serious. I think our general C code is fine.. Should I go check the assembly part? This is the rq-&gt;lock? come on&hellip;
```c
[  683.748135] ------------------- cut here -------------------
[  683.754252] Possible deadlock happend
[  683.758323] Current call stack:
[  683.761815] CPU: 4 PID: 39 Comm: python 4.0.0-lego+ #428
[  683.767728] Stack:
[  683.769959] ffff880fc1c1fc38 ffffffff8101f48c ffff88107fc45e00 ffff880fc1c1fc60
[  683.778103] ffffffff8101f4e4 ffff88107fc45e00 ffff880fc23fb000 0000000000000000
[  683.786247] ffff880fc1c1fc80 ffffffff8101b18e ffff88107fc44980 0000000000000004
[  683.794391] ffff880fc1c1fc98 ffffffff810174d5 ffffffff8101dddb ffff880fc1c1fcc0
[  683.802537] ffffffff81006774 ffff88107fc45e00 00000004a817c800 0000009a8a78c5e7
[  683.810680] Call Trace:
[  683.813396] <TSK>
[  683.815528] [<ffffffff8101f498>] report_deadlock+0x58/0x60
[  683.821637] [<ffffffff8101f4e4>] debug_spin_lock+0x44/0x50
[  683.827745] [<ffffffff8101b18e>] scheduler_tick+0x2e/0x60
[  683.833758] [<ffffffff810174d5>] tick_handle_periodic+0x45/0x70
[  683.840351] [<ffffffff8101dddb>] ? dequeue_task_rt+0x1b/0x180
[  683.846750] [<ffffffff81006774>] apic_timer_interrupt+0x54/0x90
[  683.853343] [<ffffffff8100e8aa>] smp__apic_timer_interrupt+0x6a/0x70
[  683.860421] [<ffffffff8101f4d1>] ? debug_spin_lock+0x31/0x50
[  683.866723] [<ffffffff8101b86e>] try_to_wake_up+0xce/0x1f0
[  683.872832] [<ffffffff8101b9e4>] wake_up_q+0x54/0xc0
[  683.878358] [<ffffffff81028487>] do_futex+0x407/0x620
[  683.883982] [<ffffffff8103a941>] ? pcache_add_rmap+0xb1/0x600
[  683.890381] [<ffffffff8102870c>] sys_futex+0x6c/0x130
[  683.896005] [<ffffffff8100ec66>] do_syscall_64+0x36/0xc0
[  683.901919] [<ffffffff8100db6c>] entry_SYSCALL64_slow_path+0x25/0x25</p>
</li>
</ul>
<p>```</p>
<h2 id="aug-27">Aug 27<a class="headerlink" href="#aug-27" title="Permanent link">&para;</a></h2>
<p>There a lot lost CQE cases. This one is about P-&gt;M-&gt;S. And M lost the CQE for the WQE sent to S.
<code>c
0827-w9-5
[  963.304865] watchdog: worker[0] CPU10 stucked
[  963.309712] watchdog:  common_header [op=0x20000000 src_nid:0]
[  963.316210] CPU: 10 PID: 20 Comm: thpool-worker0 4.0.0-lego+ #43
[  963.322899] RIP: 0010:[&lt;ffffffff8106ad51&gt;]  [&lt;ffffffff8106ad51&gt;] fit_send_reply_with_rdma_write_with_imm+0x2a1/0x3a0
[  963.334632] RSP: 0000:ffff88103ef3fc20  EFLAGS: 00000287
[  963.340547] RAX: 00000000ffffb6d4 RBX: 000000000000000b RCX: 0000000000001770
[  963.348498] RDX: 00000000ffffa70d RSI: fffffffffffff039 RDI: 0000000000000000
[  963.356450] RBP: ffff88103ef3fcc0 R08: 000000000000001f R09: 0000000000000002
[  963.364400] R10: 0000000080000000 R11: 000077ff80000000 R12: 0000000000000000
[  963.372352] R13: ffff88103ef26738 R14: 00000000000b3d54 R15: ffff88103ef25008
[  963.380303] FS:  0000000000000000(0000) GS:ffff88107fca0000(0000) knlGS:0000000000000000
[  963.389320] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[  963.395720] CR2: 0000000000000000 CR3: 000000000116a000 CR4: 00000000000406a0
[  963.403671] Stack:
[  963.405901] 00007fff000b3d54 ffffffff800b3d54 ffff881000000004 ffff88103ef3fc78
[  963.414045] 0000000900000000 ffff881000000000 0000100800000001 ffff88103d216000
[  963.422191] ffff88103eebae48 800b3d540000011c ffffff9b00000246 ffffea0000000001
[  963.430337] 000000103d216000 0000000000010c00 000000000000011c 0000000000001008
[  963.438481] 000000000000011c 0000000000001008 ffff88103eebae48 ffff88103ef3fd70
[  963.446626] Call Trace:
[  963.449342] &lt;TSK&gt;
[  963.451475] [&lt;ffffffff81067c80&gt;] ibapi_send_reply_imm+0x50/0xd0
[  963.458068] [&lt;ffffffff8102e953&gt;] ? __storage_read+0xc3/0x120
[  963.464371] [&lt;ffffffff8102e953&gt;] __storage_read+0xc3/0x120
[  963.470480] [&lt;ffffffff8102e9bf&gt;] storage_read+0xf/0x50
[  963.476201] [&lt;ffffffff8102eab7&gt;] storage_vma_fault+0xb7/0x130
[  963.482600] [&lt;ffffffff8103262f&gt;] handle_lego_mm_fault+0x13f/0x4a0
[  963.489389] [&lt;ffffffff8102ecf4&gt;] common_handle_p2m_miss.isra.1+0x54/0xc0
[  963.496855] [&lt;ffffffff8102edc7&gt;] handle_p2m_pcache_miss+0x67/0x2d0
[  963.503739] [&lt;ffffffff8102bf96&gt;] thpool_worker_func+0x296/0x3a0
[  963.510332] [&lt;ffffffff8102bd00&gt;] ? handle_bad_request+0x40/0x40
[  963.516926] [&lt;ffffffff81020ca6&gt;] kthread+0xf6/0x120
[  963.522357] [&lt;ffffffff81020bb0&gt;] ? __kthread_parkme+0x70/0x70
[  963.528756] [&lt;ffffffff8100e632&gt;] ret_from_fork+0x22/0x30</code></p>
<p>hmm, another on lost CQE happen at P.
Today is weird, why we happen to have so many lost CQE today?</p>
<p>Think about why CQE is not generated?</p>
<p>```c
0827-w14-6
[ 1185.835707]</p>
<hr />
<p>***** Fail to to get the CQE from send_cq after 20 seconds!
***** This means the packet was lost and something went wrong
***** with your NIC&hellip;
***** connection_id: 7 dest node: 1</p>
<hr />
<p>[ 1185.856465] IB Stats:
[ 1185.858985]     nr_ib_send_reply:            3452
[ 1185.864221]     nr_bytes_tx:               506507
[ 1185.869456]     nr_bytes_rx:              8981004
[ 1185.874692] ------------[ cut here ]------------
[ 1185.879829] WARNING: CPU: 14 PID: 22 at net/lego/fit_internal.c:1108 fit_internal_poll_sendcq+0xe5/0x140
[ 1185.890399] CPU: 14 PID: 22 Comm: python 4.0.0-lego+ #356
[ 1185.896410] Stack:
[ 1185.898640] ffff88103c49fb30 ffffffff810126f5 ffff88103cb22000 00000004a817c800
[ 1185.906784] 0000010f7139214f 0000000000000007 ffff88103c49fb40 ffffffff810127cf
[ 1185.914927] ffff88103c49fbf0 ffffffff810724b5 000000023cb2c280 ffff88103cb2c1f8
[ 1185.923072] 0000000000000286 ffff88103c49fc18 ffff88103cb06000 ffff88103cb2c150
[ 1185.931217] 000000000000024b ffff88108101c7dc ffff88107fce5d80 ffff88103c46f000
[ 1185.939360] Call Trace:
[ 1185.942075] <TSK>
[ 1185.944209] [<ffffffff81012701>] __warn.constprop.1+0x91/0xd0
[ 1185.950607] [<ffffffff810127cf>] warn_slowpath_null+0xf/0x20
[ 1185.956909] [<ffffffff810724b5>] fit_internal_poll_sendcq+0xe5/0x140
[ 1185.963987] [<ffffffff81019dd5>] ? scheduler_tick+0x55/0x60
[ 1185.970192] [<ffffffff81072662>] fit_send_message_with_rdma_write_with_imm_request+0x152/0x350
[ 1185.979791] [<ffffffff810741ff>] fit_send_reply_with_rdma_write_with_imm+0x25f/0x3a0
[ 1185.988420] [<ffffffff810368c2>] ? __pcache_do_fill_page+0xc2/0x1d0
[ 1185.995401] [<ffffffff810701e9>] ibapi_send_reply_timeout+0x79/0x120
[ 1186.002479] [<ffffffff810368c2>] ? __pcache_do_fill_page+0xc2/0x1d0
[ 1186.009459] [<ffffffff810368c2>] __pcache_do_fill_page+0xc2/0x1d0
[ 1186.016245] [<ffffffff81036ac4>] common_do_fill_page+0xf4/0x1f0
[ 1186.022839] [<ffffffff81036d80>] pcache_handle_fault+0x1c0/0x610
[ 1186.029528] [<ffffffff81036800>] ? __pcache_do_zerofill_page+0x100/0x100
[ 1186.036995] [<ffffffff8100fdff>] do_page_fault+0xaf/0x1c0
[ 1186.043005] [<ffffffff8100dc1f>] page_fault+0x1f/0x30</p>
<p>```</p>
<h2 id="aug-26">Aug 26<a class="headerlink" href="#aug-26" title="Permanent link">&para;</a></h2>
<p>Oh well. I saw the same damn lost packet issue again. The issue can be desribed as: P use lite rpc to send a request to M. M processed the handled, and called rpc reply to sent back to P. M need to poll send_cq to poll completion. But M fail to get the CQE for the should-be-sent-out WQE.</p>
<p>This is tested with M&rsquo;s <code>CONFIG_FIT_NOWAIT</code> optimization, which is basically an optimization that M will not poll cq every time a reply was sent out, instead, do batch polling.</p>
<p>The following stack dump was reported by M side watchdog. It is not necessary mlx4_poll_cq&rsquo;s issue, since there is a while (1) loop at fit code. Oh well.
```c
Log name: 0826-w9-1</p>
<p>[187736.669027] watchdog: worker[0] CPU10 stucked
[187736.673972] watchdog:  common_header [op=0x30000000 src_nid:0]
[187736.680566] CPU: 10 PID: 20 Comm: thpool-worker0 4.0.0-lego+ #26
[187736.687351] RIP: 0010:[<ffffffff810522c3>]  [<ffffffff810522c3>] mlx4_ib_poll_cq+0x1d3/0x850
[187736.696854] RSP: 0000:ffff88103ef3f750  EFLAGS: 00000286
[187736.702865] RAX: 00000000fffffff5 RBX: 0000000000000000 RCX: ffff88103ed6b050
[187736.710913] RDX: 0000000080630000 RSI: 0000000000000001 RDI: ffff88103edb0bf0
[187736.718961] RBP: ffff88103ef3f7b8 R08: 0000000000000020 R09: 0000000000000002
[187736.727007] R10: 0000000ffc53fddc R11: 0000000040bf1040 R12: ffff88103ef3f7c8
[187736.735055] R13: 0000000000000000 R14: 0000000000000000 R15: ffff88103edb0bf0
[187736.743104] FS:  0000000000000000(0000) GS:ffff88107fca0000(0000) knlGS:0000000000000000
[187736.752218] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[187736.758714] CR2: 0000000000000000 CR3: 000000000116a000 CR4: 00000000000406a0
[187736.766762] Stack:
[187736.769089] 0000000ffc53fddc 0000000000000002 0000000000000020 ffff88103edb0c98
[187736.777331] 0000000000000286 0000000080630000 ffff88103ef3f7d0 0000638000000018
[187736.785572] ffff88103edb0bf0 0000000000000001 ffff88103ef25008 0000000000000003
[187736.793813] 000000000000000c ffff88103ef3fd30 ffffffff8106920c ffff88103ef3fd54
[187736.802054] 0000000100000000 0000000100000000 ffff88103edb07b0 ffff88103e81b008
[187736.810296] Call Trace:
[187736.813108] <TSK>
[187736.815338] [<ffffffff8106920c>] fit_internal_poll_sendcq+0x6c/0xe0
[187736.822416] [<ffffffff8106ab2f>] ? fit_send_reply_with_rdma_write_with_imm+0x25f/0x3a0
[187736.831336] [<ffffffff81033ff0>] ? _lego_copy_to_user+0x110/0x250
[187736.838220] [<ffffffff81028d65>] ? __free_pages+0x25/0x30
[187736.844329] [<ffffffff8102e981>] ? __storage_read+0xf1/0x120
[187736.850728] [<ffffffff81019865>] ? scheduler_tick+0x55/0x60
[187736.857031] [<ffffffff810693d2>] ? fit_send_message_with_rdma_write_with_imm_request+0x152/0x350
[187736.866920] [<ffffffff810693d2>] ? fit_send_message_with_rdma_write_with_imm_request+0x152/0x350
[187736.876810] [<ffffffff8103043f>] ? __vma_adjust+0x38f/0x550
[187736.883113] [<ffffffff81030944>] ? vma_merge+0x1a4/0x280
[187736.889123] [<ffffffff81030f20>] ? arch_get_unmapped_area_topdown+0xe0/0x220
[187736.897075] [<ffffffff810693d2>] fit_send_message_with_rdma_write_with_imm_request+0x152/0x350
[187736.906771] [<ffffffff81069ab5>] fit_ack_reply_callback+0x185/0x1e0
[187736.913848] [<ffffffff8102f129>] ? handle_p2m_flush_one+0x69/0x160
[187736.920830] [<ffffffff8102bde0>] thpool_worker_func+0xe0/0x3a0
[187736.927424] [<ffffffff8102bd00>] ? handle_bad_request+0x40/0x40
[187736.934113] [<ffffffff81020ca6>] kthread+0xf6/0x120
[187736.939639] [<ffffffff81020bb0>] ? __kthread_parkme+0x70/0x70
[187736.946137] [<ffffffff8100e632>] ret_from_fork+0x22/0x30
```</p>
<h2 id="aug-22">Aug 22<a class="headerlink" href="#aug-22" title="Permanent link">&para;</a></h2>
<p>Damn it!!! After so much effort verifying we had a solid IB stack, we still has memory corruption and deadlock issues. Fuck!</p>
<p>One thing at a time, simple stuff first. Okay, tomorrow first add DEBUG_SPINLOCK to detect possible deadlocks. This, could help to identify some buggy code. After this, I will spend some time looking into the LITE, it&rsquo;s fucking HEAVY. I do found a lot issues during summer.</p>
<p>Personally, I&rsquo;m not feeling good this days. I treat someone with love and respect, but there is not too much in return. Yeahyeahyeah, I know how this works. It&rsquo;s just sad that sometimes you just have a BAD timing. I&rsquo;ve went through too much things in 2018, good and bad. I care sooo much about the people I love, family and others. I feel this is good, of course. Anyway, it is supposed to be a Lego dump, that no one probably interested in.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 1, 2018</span>
      
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var script,disqus_config=function(){this.page.url="http://lastweek.io/lego/log/log-08-2018/",this.page.identifier="lego/log/log-08-2018/"};"undefined"==typeof DISQUS?((script=document.createElement("script")).async=!0,script.src="https://lastweek-io.disqus.com/embed.js",script.setAttribute("data-timestamp",Date.now()),document.body.appendChild(script)):DISQUS.reset({reload:!0,config:disqus_config})</script>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["instant", "tabs", "navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>