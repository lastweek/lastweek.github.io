


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/syscall/fork/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.2.2">
    
    
      
        <title>fork() - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a2408e81.min.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="" data-md-color-accent="deep-purple">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fork" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Yizhou Shan's Home Page
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              fork()
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/source_code/summary/" class="md-tabs__link">
          Code
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/cache_coherence/" class="md-tabs__link">
          Note
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../notes/paper_fpga/" class="md-tabs__link">
          FPGA
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../blog/20200404-on-read-once/" class="md-tabs__link">
          Random
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../kernel/boot/" class="md-tabs__link">
          LegoOS
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Code
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Code" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/summary/" title="All" class="md-nav__link">
      All
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/20200501-on-graphic-softwares/" title="Graphics" class="md-nav__link">
      Graphics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/20200506-on-firmware-softwares/" title="Firmware" class="md-nav__link">
      Firmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/rdma/" title="RDMA/DPDK" class="md-nav__link">
      RDMA/DPDK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/virt/" title="Virtualization" class="md-nav__link">
      Virtualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/gpu/" title="GPU" class="md-nav__link">
      GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/fpga/" title="FPGA" class="md-nav__link">
      FPGA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Guideline & Advice" class="md-nav__link">
      Guideline & Advice
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Note
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Note" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Note
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="x86-Ring-Switch-Overhead" class="md-nav__link">
      x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGA
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="FPGA" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/language/" title="Language" class="md-nav__link">
      Language
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous Partial Reconfiguration" class="md-nav__link">
      Morphous Partial Reconfiguration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Notes" class="md-nav__link">
      Vivado Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Random
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Random" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Random
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      LegoOS
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="LegoOS" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      Kernel
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Kernel" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2" checked>
    
    <label class="md-nav__link" for="nav-6-2">
      Syscall
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Syscall" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        fork()
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="fork()" class="md-nav__link md-nav__link--active">
      fork()
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-manager" class="md-nav__link">
    Memory Manager
  </a>
  
    <nav class="md-nav" aria-label="Memory Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#duplicate-vm-free-pool" class="md-nav__link">
    Duplicate VM Free Pool
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-manager" class="md-nav__link">
    Processor Manager
  </a>
  
    <nav class="md-nav" aria-label="Processor Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-points" class="md-nav__link">
    Entry Points
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do_fork" class="md-nav__link">
    do_fork()
  </a>
  
    <nav class="md-nav" aria-label="do_fork()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy_process" class="md-nav__link">
    copy_process()
  </a>
  
    <nav class="md-nav" aria-label="copy_process()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sanity-checking" class="md-nav__link">
    Sanity Checking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup_task_struct" class="md-nav__link">
    dup_task_struct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_mm" class="md-nav__link">
    copy_mm()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-pcache-data" class="md-nav__link">
    Duplicate pcache data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_sched_fork" class="md-nav__link">
    setup_sched_fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocate-new-pid" class="md-nav__link">
    Allocate new pid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settidcleartid" class="md-nav__link">
    SETTID/CLEARTID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_thread_tls" class="md-nav__link">
    copy_thread_tls()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2m_fork" class="md-nav__link">
    p2m_fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wake_up_new_task" class="md-nav__link">
    wake_up_new_task()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3">
    
    <label class="md-nav__link" for="nav-6-3">
      Pcache
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Pcache" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-4" type="checkbox" id="nav-6-4">
    
    <label class="md-nav__link" for="nav-6-4">
      Driver
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Driver" data-md-level="2">
      <label class="md-nav__title" for="nav-6-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-5" type="checkbox" id="nav-6-5">
    
    <label class="md-nav__link" for="nav-6-5">
      Paper
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Paper" data-md-level="2">
      <label class="md-nav__title" for="nav-6-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-manager" class="md-nav__link">
    Memory Manager
  </a>
  
    <nav class="md-nav" aria-label="Memory Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#duplicate-vm-free-pool" class="md-nav__link">
    Duplicate VM Free Pool
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-manager" class="md-nav__link">
    Processor Manager
  </a>
  
    <nav class="md-nav" aria-label="Processor Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-points" class="md-nav__link">
    Entry Points
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do_fork" class="md-nav__link">
    do_fork()
  </a>
  
    <nav class="md-nav" aria-label="do_fork()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy_process" class="md-nav__link">
    copy_process()
  </a>
  
    <nav class="md-nav" aria-label="copy_process()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sanity-checking" class="md-nav__link">
    Sanity Checking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup_task_struct" class="md-nav__link">
    dup_task_struct()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_mm" class="md-nav__link">
    copy_mm()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-pcache-data" class="md-nav__link">
    Duplicate pcache data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_sched_fork" class="md-nav__link">
    setup_sched_fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocate-new-pid" class="md-nav__link">
    Allocate new pid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settidcleartid" class="md-nav__link">
    SETTID/CLEARTID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_thread_tls" class="md-nav__link">
    copy_thread_tls()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2m_fork" class="md-nav__link">
    p2m_fork()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wake_up_new_task" class="md-nav__link">
    wake_up_new_task()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="fork">fork()<a class="headerlink" href="#fork" title="Permanent link">&para;</a></h1>
<h2 id="memory-manager">Memory Manager<a class="headerlink" href="#memory-manager" title="Permanent link">&para;</a></h2>
<p>We need to duplicate the address space in the memory manager side. Follow the traditional <code>fork()</code> semantic, both the existing and newly created address space will be write-protected.</p>
<p>Since we have the flexibility to implement any VM organization, we should be careful while duplicating the address space. Currently, we are using page-based VM, thus the duplicating is basically creating a new <code>pgd</code> and copy existing pgtables, and further downgrade permission to read-only. This is now performed by <code>lego_copy_page_range()</code>.</p>
<p>The final write-protect is performed by <code>lego_copy_one_pte()</code>:
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lego_copy_one_pte</span><span class="p">(..)</span>
<span class="p">{</span>
    <span class="p">..</span>
    <span class="cm">/*</span>
<span class="cm">     * If it&#39;s a COW mapping, write protect it both</span>
<span class="cm">     * in the parent and the child</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_cow_mapping</span><span class="p">(</span><span class="n">vm_flags</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ptep_set_wrprotect</span><span class="p">(</span><span class="n">src_pte</span><span class="p">);</span>   
        <span class="n">pte</span> <span class="o">=</span> <span class="n">pte_wrprotect</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>      
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="duplicate-vm-free-pool">Duplicate VM Free Pool<a class="headerlink" href="#duplicate-vm-free-pool" title="Permanent link">&para;</a></h3>
<p><mark class="critic">TODO</mark> Yutong</p>
<h2 id="processor-manager">Processor Manager<a class="headerlink" href="#processor-manager" title="Permanent link">&para;</a></h2>
<p>Boring implementation details in the processor manager side.</p>
<h3 id="entry-points">Entry Points<a class="headerlink" href="#entry-points" title="Permanent link">&para;</a></h3>
<ul>
<li><code>fork()</code></li>
<li><code>vfork()</code></li>
<li><code>clone()</code></li>
<li><code>kernel_thread()</code></li>
</ul>
<p>All of them land on <code>do_fork()</code>, which is Lego&rsquo;s main fork function.</p>
<h3 id="do_fork">do_fork()<a class="headerlink" href="#do_fork" title="Permanent link">&para;</a></h3>
<p>There are mainly three parts within <code>do_fork()</code>: <code>1)</code> <code>copy_process()</code>, which duplicates a new task based on <code>current</code>, including allocate new kernel stack, new task_struct, increase mm reference counter, etc. <code>2)</code> If we are creating a new process, then tell global monitor or memory manager to let them update bookkeeping and create corresponding data structures. <code>3)</code> <code>wake_up_new_task()</code>, which gives away the newly created task to local scheduler.</p>
<h4 id="copy_process">copy_process()<a class="headerlink" href="#copy_process" title="Permanent link">&para;</a></h4>
<p>The routine is kind of boring. It do a lot dirty work to copy information from calling thread to new thread. The most important data structures of course are <code>task_struct</code>, <code>mm_sturct</code>, <code>sighand</code>, and so on. This section only talks about few of them, and leave others to readers who are interested.</p>
<h5 id="sanity-checking">Sanity Checking<a class="headerlink" href="#sanity-checking" title="Permanent link">&para;</a></h5>
<p>Mainly check if <code>clone_flags</code> are passed properly. For example, if user is creating a new thread, that implies certain data structures are shared, cause new thread belongs to the same process with the calling thread. If <code>CLONE_THREAD</code> is passed, then <code>CLONE_SIGHAND</code>, <code>CLONE_VM</code>, and so on must be set as well.
<div class="highlight"><pre><span></span><code>    <span class="cm">/*</span>
<span class="cm">     * Thread groups must share signals as well, and detached threads</span>
<span class="cm">     * can only be started up within the thread group.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_THREAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_SIGHAND</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Shared signal handlers imply shared VM. By way of the above,</span>
<span class="cm">     * thread groups also imply shared VM. Blocking this case allows</span>
<span class="cm">     * for various simplifications in other code.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_SIGHAND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_VM</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
</code></pre></div></p>
<h5 id="dup_task_struct">dup_task_struct()<a class="headerlink" href="#dup_task_struct" title="Permanent link">&para;</a></h5>
<p>Two main things: 1) duplicate a new <code>task_struct</code>, 2) duplicate a new kernel stack. x86 is just a weird architecture, the size of <code>task_struct</code> depends on the size of fpu. So the allocation and duplication need to callback to x86-specific code to duplicate the task_struct and fpu info.
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">arch_dup_task_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">arch_task_struct_size</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">fpu__copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
The stack duplication is fairly simple, just copy everything from the old stack to new stack. Of course, it needs to setup the <code>thread_info</code> to points to this new thread, so the <code>current</code> macro will work.
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_thread_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">org</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* Duplicate whole stack! */</span>
        <span class="o">*</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">org</span><span class="p">);</span>

        <span class="cm">/* Make the `current&#39; macro work */</span>
        <span class="n">task_thread_info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="copy_mm">copy_mm()<a class="headerlink" href="#copy_mm" title="Permanent link">&para;</a></h5>
<p>This is where threads within a process will share the virtual address space happens. If we are creating a new process, then this function will create a new <code>mm_struct</code>, and also a new <code>pgd</code>:
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * pgd_alloc() will duplicate the identity kernel mapping</span>
<span class="cm"> * but leaves other entries empty:</span>
<span class="cm"> */</span>
<span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span> <span class="o">=</span> <span class="n">pgd_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="duplicate-pcache-data">Duplicate pcache data<a class="headerlink" href="#duplicate-pcache-data" title="Permanent link">&para;</a></h5>
<p><mark class="critic">TODO</mark></p>
<details class="danger" open="open"><summary>TODO: hook with pcache</summary><p>We need to duplicate the pcache vm_range array, once Yutong finished the code.</p>
</details>
<h5 id="setup_sched_fork">setup_sched_fork()<a class="headerlink" href="#setup_sched_fork" title="Permanent link">&para;</a></h5>
<p>Callback to scheduler to setup this new task. It may reset all scheduler related information. Here we also have a chance to change this task&rsquo;s scheduler class:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">setup_sched_fork</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clone_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>

        <span class="n">__sched_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

        <span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_NEW</span><span class="p">;</span>
        <span class="p">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_reset_on_fork</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">task_has_rt_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">p</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">=</span> <span class="n">SCHED_NORMAL</span><span class="p">;</span>
                        <span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span> <span class="o">=</span> <span class="n">NICE_TO_PRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                        <span class="n">p</span><span class="o">-&gt;</span><span class="n">rt_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PRIO_TO_NICE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span> <span class="o">=</span> <span class="n">NICE_TO_PRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

                <span class="n">p</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">normal_prio</span> <span class="o">=</span> <span class="n">__normal_prio</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
                <span class="n">set_load_weight</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
                <span class="p">...</span>
        <span class="p">}</span>    

        <span class="k">if</span> <span class="p">(</span><span class="n">rt_prio</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">))</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_sched_class</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fair_sched_class</span><span class="p">;</span>
                <span class="n">set_load_weight</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="p">}</span>    

        <span class="n">__set_task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">task_fork</span><span class="p">)</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">task_fork</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

        <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<h5 id="allocate-new-pid">Allocate new pid<a class="headerlink" href="#allocate-new-pid" title="Permanent link">&para;</a></h5>
<p>In both Lego and Linux, we don&rsquo;t allocate new pid for a new thread, if that thread is an <code>idle thread</code>. So callers of <code>do_fork</code> needs to pass something to let <code>do_fork</code> know. In Linux, they use <code>struct pid, init_struct_pid</code> to check. In Lego, we introduce an new clone_flag <code>CLONE_IDLE_THREAD</code>. If that flag is set, <code>do_fork()</code> will try to allocate a new pid for the new thread. Otherwise, it will be 0:
<div class="highlight"><pre><span></span><code><span class="cm">/* clone idle thread, whose pid is 0 */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_IDLE_THREAD</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">alloc_pid</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_cleanup_thread</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>So, only the <code>init_idle()</code> function can pass this <code>CLONE_IDLE_THREAD</code> down. All other usages are wrong and should be reported.</p>
<p>In order to avoid conflict with Linux clone_flag, we define it as:
<div class="highlight"><pre><span></span><code><span class="cp">#define CLONE_IDLE_THREAD       0x100000000</span>
</code></pre></div></p>
<h5 id="settidcleartid">SETTID/CLEARTID<a class="headerlink" href="#settidcleartid" title="Permanent link">&para;</a></h5>
<p>These are some futex related stuff. I will cover these stuff in futex document:
<div class="highlight"><pre><span></span><code><span class="n">p</span><span class="o">-&gt;</span><span class="n">set_child_tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_CHILD_SETTID</span><span class="p">)</span> <span class="o">?</span> <span class="nl">child_tidptr</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cm">/*  </span>
<span class="cm"> * Clear TID on mm_release()?</span>
<span class="cm"> */</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">clear_child_tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_CHILD_CLEARTID</span><span class="p">)</span> <span class="o">?</span> <span class="nl">child_tidptr</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FUTEX</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">robust_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
</code></pre></div></p>
<h5 id="copy_thread_tls">copy_thread_tls()<a class="headerlink" href="#copy_thread_tls" title="Permanent link">&para;</a></h5>
<p>This is the most interesting function. Cover later.</p>
<h4 id="p2m_fork">p2m_fork()<a class="headerlink" href="#p2m_fork" title="Permanent link">&para;</a></h4>
<p>In order to track user activities, we need to know when user are going to create new process. Fork is the best time and the only time we kernel know. So, Lego adds this special hook to tell remote global monitor or memory manager that there is a new process going to be created. Upon receiving this message, remote monitor will update its bookkeeping for this specific user/vNode.</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* Tell remote memory component */</span>
<span class="cp">#ifdef CONFIG_COMP_PROCESSOR</span>
<span class="k">if</span> <span class="p">(</span><span class="n">clone_flags</span> <span class="o">&amp;</span> <span class="n">CLONE_GLOBAL_THREAD</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">p2m_fork</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">clone_flags</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>   
<span class="cp">#endif</span>
</code></pre></div>

<p>The <code>CLONE_GLOBAL_THREAD</code> should only be set, if the following cases happen:</p>
<ul>
<li>fork()</li>
<li>vfork()</li>
<li>clone(), without <code>CLONE_THREAD</code> being set</li>
</ul>
<p>In order to avoid conflict with Linux clone_flag, we define it as:
<div class="highlight"><pre><span></span><code><span class="cp">#define CLONE_GLOBAL_THREAD     0x200000000</span>
</code></pre></div></p>
<h4 id="wake_up_new_task">wake_up_new_task()<a class="headerlink" href="#wake_up_new_task" title="Permanent link">&para;</a></h4>
<p>The last step of <code>do_fork</code> is waking up the new thread or process, which is performed by <code>wake_up_new_task()</code> function. The first question this function will ask is: <code>which cpu to land?</code> The answer comes from <code>select_task_rq()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">select_task_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sd_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wake_flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nr_cpus_allowed</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">cpu</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">select_task_rq</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">sd_flags</span><span class="p">,</span> <span class="n">wake_flags</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">cpu</span> <span class="o">=</span> <span class="n">cpumask_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cpus_allowed</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p>Clearly, this is determined by <code>cpus_allowed</code>, which is the same with its parent at this point. That being said, if the parent is only able to run on one specific CPU, then all its children will end up running on the same CPU when they wake up (they could change their affinity later). This is also the default on Linux: <code>A child created via fork(2) inherits its parent's CPU affinity mask. The affinity mask is preserved across an execve(2).</code></p>
<p>After landing CPU is selected, following operation is simple: just enqueue this task into landing CPU&rsquo;s runqueue, and we are done:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">wake_up_new_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
<span class="cm">/* Select a CPU for new thread to run */</span>
<span class="cp">#ifdef CONFIG_SMP</span>
        <span class="cm">/*   </span>
<span class="cm">         * Fork balancing, do it here and not earlier because:</span>
<span class="cm">         *  - cpus_allowed can change in the fork path</span>
<span class="cm">         *  - any previously selected cpu might disappear through hotplug</span>
<span class="cm">         */</span>
        <span class="n">set_task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">select_task_rq</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">SD_BALANCE_FORK</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>

        <span class="n">rq</span> <span class="o">=</span> <span class="n">__task_rq_lock</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="n">activate_task</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">on_rq</span> <span class="o">=</span> <span class="n">TASK_ON_RQ_QUEUED</span><span class="p">;</span>
        <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p>&ndash;<br />
Yizhou Shan<br />
Created: Feb 11, 2018<br />
Last Updated: Feb 27, 2018</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: February 28, 2018
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="http://lastweek.io/lego/syscall/fork/",this.page.identifier="/lego/syscall/fork/"};!function(){var e=document,i=e.createElement("script");i.src="//lastweek-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../mremap/" title="mremap()" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                mremap()
              </div>
            </div>
          </a>
        
        
          <a href="../getrusage/" title="getrusage()" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                getrusage()
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ["instant", "tabs"],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>