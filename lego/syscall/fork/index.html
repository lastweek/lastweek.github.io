
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/syscall/fork/">
      
      
        <link rel="prev" href="../mremap/">
      
      
        <link rel="next" href="../getrusage/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>fork() - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime+Bold:300,300i,400,400i,700,700i%7CCourier+Prime+Bold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Courier Prime Bold";--md-code-font:"Courier Prime Bold"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fork" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-header__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Yizhou Shan's Home Page
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              fork()
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/lastweek/lastweek.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../notes/ssd/" class="md-tabs__link">
          
  
  
  Notes

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../notes/source_code/summary/" class="md-tabs__link">
          
  
  
  Code

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../fpga/bitstream/" class="md-tabs__link">
          
  
  
  FPGA

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../log/misc/" class="md-tabs__link">
          
  
  
  LegoOS

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lastweek/lastweek.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Notes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/ssd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SSD 101
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/CXL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is CXL?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/MLIR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is MLIR?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/virt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Modern Virtualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cache_coherence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Practical Cache Coherence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/resource-disaggregation-spectrum/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Resource Disaggregation Design Spectrums
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dist-xact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Transactions and Databases
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dynamic_linking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Linking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/dcn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Center Networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/packet-sched/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Switch Buffering and Packet Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/sysml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SysML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/arch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cryptography/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cryptography
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cryptocurrency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cryptocurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/hardware_pl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hardware Design Languages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/paper_perf_shadows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance-Shadows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/essential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Essential
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/cheatsheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cheatsheet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/20200404-on-read-once/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    On Read Once and Compiler Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-function-trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Dump Function Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux fork/switch_to
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-rcu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux RCU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-completion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Completion/swait
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-workqueue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux workqueue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-linker-script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Linker Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-boot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Boot Sequence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Trace and Profile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Reverse Mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/userfaultfd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Userfaultfd
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/cgroup-swap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Cgroup and Swap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/xperf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux x86 Ring Switch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-x86-fpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux FPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-iouring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux io_uring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/linux-resource/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Resource
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/proc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Special Files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/kvm-basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux KVM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/linux/rust.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Rust
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Go
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Go
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/go/golang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learn Go
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/go/gvisor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gVisor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rust
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rust
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rust/rust/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learn Rust
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/rust/firecracker.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firecracker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/rdma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPDK and RDMA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/program_advice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guideline & Advice
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/firmware-softwares/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firmware & Bootloader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operating System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/compilers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compilers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/unix-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unix Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/virt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/20200501-on-graphic-softwares/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graphics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/fpga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FPGA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/risc-v/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RISC-V
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/dotconfigs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dot-Configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/source_code/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    FPGA
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    FPGA
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/bitstream/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bitstream Explained
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notes/paper_fpga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Papers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/language/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Languages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/vivado/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vivado Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/setup_hold/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup and Hold Time
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/pr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Partial Reconfiguration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    LegoOS
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    LegoOS
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Log
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Log
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../log/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MISC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../log/test-note/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/boot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GRUB2 and Boot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/kconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kconfig
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debug
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/grub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GRUB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_strace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile strace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_heatmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile heatmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_points/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile points
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/trampoline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trampoline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/pagefault_disable/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Disable pgfault
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/stop_machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stop machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Program Loader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vDSO/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vDSO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual File System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Virtual Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/fpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    x86 FPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/irq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IRQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/net_thpool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Thpool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" checked>
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Syscall
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Syscall
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../facts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Facts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kernel/profile_strace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile strace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    compat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../msync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    msync()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mremap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    mremap()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    fork()
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    fork()
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Manager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#duplicate-vm-free-pool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Duplicate VM Free Pool
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Processor Manager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Processor Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Entry Points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        do_fork()
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="do_fork()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy_process" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_process()
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="copy_process()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sanity-checking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sanity Checking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup_task_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        dup_task_struct()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_mm" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_mm()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-pcache-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Duplicate pcache data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_sched_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_sched_fork()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocate-new-pid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocate new pid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settidcleartid" class="md-nav__link">
    <span class="md-ellipsis">
      
        SETTID/CLEARTID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_thread_tls" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_thread_tls()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2m_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        p2m_fork()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wake_up_new_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        wake_up_new_task()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getrusage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    getrusage()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wait_and_exit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    wait4 and exit()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pcache
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pcache
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/sweep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sweep
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/tlb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TLB Coherence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/pgtable-lock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PageTable Lock
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/victim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Victim Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/virtual_cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/rmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reverse Mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/evict_and_ref/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evict and Refcount
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/smp_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SMP Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pcache/replication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Replication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Driver
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Driver
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../driver/pci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PCI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../driver/ib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Infiniband
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Paper
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Paper
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/nmp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NMP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/processor_oom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processor OOM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/genz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gen-Z
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/replication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Replication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/related/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Related
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Manager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#duplicate-vm-free-pool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Duplicate VM Free Pool
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processor-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Processor Manager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Processor Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Entry Points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#do_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        do_fork()
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="do_fork()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy_process" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_process()
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="copy_process()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sanity-checking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sanity Checking
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dup_task_struct" class="md-nav__link">
    <span class="md-ellipsis">
      
        dup_task_struct()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_mm" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_mm()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-pcache-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Duplicate pcache data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup_sched_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_sched_fork()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocate-new-pid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Allocate new pid
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settidcleartid" class="md-nav__link">
    <span class="md-ellipsis">
      
        SETTID/CLEARTID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_thread_tls" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_thread_tls()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2m_fork" class="md-nav__link">
    <span class="md-ellipsis">
      
        p2m_fork()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wake_up_new_task" class="md-nav__link">
    <span class="md-ellipsis">
      
        wake_up_new_task()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="fork">fork()<a class="headerlink" href="#fork" title="Permanent link">&para;</a></h1>
<h2 id="memory-manager">Memory Manager<a class="headerlink" href="#memory-manager" title="Permanent link">&para;</a></h2>
<p>We need to duplicate the address space in the memory manager side. Follow the traditional <code>fork()</code> semantic, both the existing and newly created address space will be write-protected.</p>
<p>Since we have the flexibility to implement any VM organization, we should be careful while duplicating the address space. Currently, we are using page-based VM, thus the duplicating is basically creating a new <code>pgd</code> and copy existing pgtables, and further downgrade permission to read-only. This is now performed by <code>lego_copy_page_range()</code>.</p>
<p>The final write-protect is performed by <code>lego_copy_one_pte()</code>:
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">lego_copy_one_pte</span><span class="p">(..)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">..</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * If it&#39;s a COW mapping, write protect it both</span>
<span class="cm">     * in the parent and the child</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_cow_mapping</span><span class="p">(</span><span class="n">vm_flags</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ptep_set_wrprotect</span><span class="p">(</span><span class="n">src_pte</span><span class="p">);</span><span class="w">   </span>
<span class="w">        </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte_wrprotect</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span><span class="w">      </span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="duplicate-vm-free-pool">Duplicate VM Free Pool<a class="headerlink" href="#duplicate-vm-free-pool" title="Permanent link">&para;</a></h3>
<p><mark class="critic">TODO</mark> Yutong</p>
<h2 id="processor-manager">Processor Manager<a class="headerlink" href="#processor-manager" title="Permanent link">&para;</a></h2>
<p>Boring implementation details in the processor manager side.</p>
<h3 id="entry-points">Entry Points<a class="headerlink" href="#entry-points" title="Permanent link">&para;</a></h3>
<ul>
<li><code>fork()</code></li>
<li><code>vfork()</code></li>
<li><code>clone()</code></li>
<li><code>kernel_thread()</code></li>
</ul>
<p>All of them land on <code>do_fork()</code>, which is Lego&rsquo;s main fork function.</p>
<h3 id="do_fork">do_fork()<a class="headerlink" href="#do_fork" title="Permanent link">&para;</a></h3>
<p>There are mainly three parts within <code>do_fork()</code>: <code>1)</code> <code>copy_process()</code>, which duplicates a new task based on <code>current</code>, including allocate new kernel stack, new task_struct, increase mm reference counter, etc. <code>2)</code> If we are creating a new process, then tell global monitor or memory manager to let them update bookkeeping and create corresponding data structures. <code>3)</code> <code>wake_up_new_task()</code>, which gives away the newly created task to local scheduler.</p>
<h4 id="copy_process">copy_process()<a class="headerlink" href="#copy_process" title="Permanent link">&para;</a></h4>
<p>The routine is kind of boring. It do a lot dirty work to copy information from calling thread to new thread. The most important data structures of course are <code>task_struct</code>, <code>mm_sturct</code>, <code>sighand</code>, and so on. This section only talks about few of them, and leave others to readers who are interested.</p>
<h5 id="sanity-checking">Sanity Checking<a class="headerlink" href="#sanity-checking" title="Permanent link">&para;</a></h5>
<p>Mainly check if <code>clone_flags</code> are passed properly. For example, if user is creating a new thread, that implies certain data structures are shared, cause new thread belongs to the same process with the calling thread. If <code>CLONE_THREAD</code> is passed, then <code>CLONE_SIGHAND</code>, <code>CLONE_VM</code>, and so on must be set as well.
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Thread groups must share signals as well, and detached threads</span>
<span class="cm">     * can only be started up within the thread group.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_THREAD</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_SIGHAND</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Shared signal handlers imply shared VM. By way of the above,</span>
<span class="cm">     * thread groups also imply shared VM. Blocking this case allows</span>
<span class="cm">     * for various simplifications in other code.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_SIGHAND</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_VM</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
</code></pre></div></p>
<h5 id="dup_task_struct">dup_task_struct()<a class="headerlink" href="#dup_task_struct" title="Permanent link">&para;</a></h5>
<p>Two main things: 1) duplicate a new <code>task_struct</code>, 2) duplicate a new kernel stack. x86 is just a weird architecture, the size of <code>task_struct</code> depends on the size of fpu. So the allocation and duplication need to callback to x86-specific code to duplicate the task_struct and fpu info.
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">arch_dup_task_struct</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">arch_task_struct_size</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fpu__copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
The stack duplication is fairly simple, just copy everything from the old stack to new stack. Of course, it needs to setup the <code>thread_info</code> to points to this new thread, so the <code>current</code> macro will work.
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_thread_stack</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">org</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="cm">/* Duplicate whole stack! */</span>
<span class="w">        </span><span class="o">*</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">org</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Make the `current&#39; macro work */</span>
<span class="w">        </span><span class="n">task_thread_info</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="copy_mm">copy_mm()<a class="headerlink" href="#copy_mm" title="Permanent link">&para;</a></h5>
<p>This is where threads within a process will share the virtual address space happens. If we are creating a new process, then this function will create a new <code>mm_struct</code>, and also a new <code>pgd</code>:
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * pgd_alloc() will duplicate the identity kernel mapping</span>
<span class="cm"> * but leaves other entries empty:</span>
<span class="cm"> */</span>
<span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgd_alloc</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kfree</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="duplicate-pcache-data">Duplicate pcache data<a class="headerlink" href="#duplicate-pcache-data" title="Permanent link">&para;</a></h5>
<p><mark class="critic">TODO</mark></p>
<details class="danger" open="open">
<summary>TODO: hook with pcache</summary>
<p>We need to duplicate the pcache vm_range array, once Yutong finished the code.</p>
</details>
<h5 id="setup_sched_fork">setup_sched_fork()<a class="headerlink" href="#setup_sched_fork" title="Permanent link">&para;</a></h5>
<p>Callback to scheduler to setup this new task. It may reset all scheduler related information. Here we also have a chance to change this task&rsquo;s scheduler class:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">setup_sched_fork</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cpu</span><span class="p">();</span>

<span class="w">        </span><span class="n">__sched_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TASK_NEW</span><span class="p">;</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_reset_on_fork</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task_has_rt_policy</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCHED_NORMAL</span><span class="p">;</span>
<span class="w">                        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NICE_TO_PRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">                        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rt_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PRIO_TO_NICE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">static_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NICE_TO_PRIO</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">                </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">normal_prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__normal_prio</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">                </span><span class="n">set_load_weight</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">                </span><span class="p">...</span>
<span class="w">        </span><span class="p">}</span><span class="w">    </span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rt_prio</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">))</span>
<span class="w">                </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rt_sched_class</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fair_sched_class</span><span class="p">;</span>
<span class="w">                </span><span class="n">set_load_weight</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w">    </span>

<span class="w">        </span><span class="n">__set_task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">task_fork</span><span class="p">)</span>
<span class="w">                </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">task_fork</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">        </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="allocate-new-pid">Allocate new pid<a class="headerlink" href="#allocate-new-pid" title="Permanent link">&para;</a></h5>
<p>In both Lego and Linux, we don&rsquo;t allocate new pid for a new thread, if that thread is an <code>idle thread</code>. So callers of <code>do_fork</code> needs to pass something to let <code>do_fork</code> know. In Linux, they use <code>struct pid, init_struct_pid</code> to check. In Lego, we introduce an new clone_flag <code>CLONE_IDLE_THREAD</code>. If that flag is set, <code>do_fork()</code> will try to allocate a new pid for the new thread. Otherwise, it will be 0:
<div class="highlight"><pre><span></span><code><span class="cm">/* clone idle thread, whose pid is 0 */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_IDLE_THREAD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_pid</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span>
<span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">out_cleanup_thread</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<p>So, only the <code>init_idle()</code> function can pass this <code>CLONE_IDLE_THREAD</code> down. All other usages are wrong and should be reported.</p>
<p>In order to avoid conflict with Linux clone_flag, we define it as:
<div class="highlight"><pre><span></span><code><span class="cp">#define CLONE_IDLE_THREAD       0x100000000</span>
</code></pre></div></p>
<h5 id="settidcleartid">SETTID/CLEARTID<a class="headerlink" href="#settidcleartid" title="Permanent link">&para;</a></h5>
<p>These are some futex related stuff. I will cover these stuff in futex document:
<div class="highlight"><pre><span></span><code><span class="n">p</span><span class="o">-&gt;</span><span class="n">set_child_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_CHILD_SETTID</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">child_tidptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="cm">/*  </span>
<span class="cm"> * Clear TID on mm_release()?</span>
<span class="cm"> */</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">clear_child_tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_CHILD_CLEARTID</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">child_tidptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FUTEX</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">robust_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
</code></pre></div></p>
<h5 id="copy_thread_tls">copy_thread_tls()<a class="headerlink" href="#copy_thread_tls" title="Permanent link">&para;</a></h5>
<p>This is the most interesting function. Cover later.</p>
<h4 id="p2m_fork">p2m_fork()<a class="headerlink" href="#p2m_fork" title="Permanent link">&para;</a></h4>
<p>In order to track user activities, we need to know when user are going to create new process. Fork is the best time and the only time we kernel know. So, Lego adds this special hook to tell remote global monitor or memory manager that there is a new process going to be created. Upon receiving this message, remote monitor will update its bookkeeping for this specific user/vNode.</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* Tell remote memory component */</span>
<span class="cp">#ifdef CONFIG_COMP_PROCESSOR</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CLONE_GLOBAL_THREAD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="n">p2m_fork</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">);</span>
<span class="w">        </span><span class="p">...</span>
<span class="p">}</span><span class="w">   </span>
<span class="cp">#endif</span>
</code></pre></div>
<p>The <code>CLONE_GLOBAL_THREAD</code> should only be set, if the following cases happen:</p>
<ul>
<li>fork()</li>
<li>vfork()</li>
<li>clone(), without <code>CLONE_THREAD</code> being set</li>
</ul>
<p>In order to avoid conflict with Linux clone_flag, we define it as:
<div class="highlight"><pre><span></span><code><span class="cp">#define CLONE_GLOBAL_THREAD     0x200000000</span>
</code></pre></div></p>
<h4 id="wake_up_new_task">wake_up_new_task()<a class="headerlink" href="#wake_up_new_task" title="Permanent link">&para;</a></h4>
<p>The last step of <code>do_fork</code> is waking up the new thread or process, which is performed by <code>wake_up_new_task()</code> function. The first question this function will ask is: <code>which cpu to land?</code> The answer comes from <code>select_task_rq()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">select_task_rq</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sd_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">wake_flags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nr_cpus_allowed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sched_class</span><span class="o">-&gt;</span><span class="n">select_task_rq</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">sd_flags</span><span class="p">,</span><span class="w"> </span><span class="n">wake_flags</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">                </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpumask_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cpus_allowed</span><span class="p">);</span>
<span class="w">        </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>Clearly, this is determined by <code>cpus_allowed</code>, which is the same with its parent at this point. That being said, if the parent is only able to run on one specific CPU, then all its children will end up running on the same CPU when they wake up (they could change their affinity later). This is also the default on Linux: <code>A child created via fork(2) inherits its parent's CPU affinity mask. The affinity mask is preserved across an execve(2).</code></p>
<p>After landing CPU is selected, following operation is simple: just enqueue this task into landing CPU&rsquo;s runqueue, and we are done:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">wake_up_new_task</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="cm">/* Select a CPU for new thread to run */</span>
<span class="cp">#ifdef CONFIG_SMP</span>
<span class="w">        </span><span class="cm">/*   </span>
<span class="cm">         * Fork balancing, do it here and not earlier because:</span>
<span class="cm">         *  - cpus_allowed can change in the fork path</span>
<span class="cm">         *  - any previously selected cpu might disappear through hotplug</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">set_task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">select_task_rq</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">SD_BALANCE_FORK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="n">rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__task_rq_lock</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">activate_task</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">on_rq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TASK_ON_RQ_QUEUED</span><span class="p">;</span>
<span class="w">        </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Feb 11, 2018<br />
Last Updated: Feb 27, 2018</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="February 28, 2018 04:57:29 UTC">February 28, 2018</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["instant", "tabs", "navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>