
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <link rel="canonical" href="http://lastweek.io/notes/linux/linux-rcu/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.6">
    
    
      
        <title>Linux RCU - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.802231af.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime+Bold:300,400,400i,700%7CCourier+Prime+Bold&display=fallback">
        <style>:root{--md-text-font-family:"Courier Prime Bold";--md-code-font-family:"Courier Prime Bold"}</style>
      
    
    
    
    
      
  



  
  



  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux-rcu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-header__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Yizhou Shan's Home Page
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Linux RCU
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lastweek/lastweek.github.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M105.2 24.9c-3.1-8.9-15.7-8.9-18.9 0L29.8 199.7h132c-.1 0-56.6-174.8-56.6-174.8zM.9 287.7c-2.6 8 .3 16.9 7.1 22l247.9 184-226.2-294zm160.8-88 94.3 294 94.3-294zm349.4 88-28.8-88-226.3 294 247.9-184c6.9-5.1 9.7-14 7.2-22zM425.7 24.9c-3.1-8.9-15.7-8.9-18.9 0l-56.6 174.8h132z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../virt/" class="md-tabs__link">
        Notes
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../source_code/summary/" class="md-tabs__link md-tabs__link--active">
        Code
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../fpga/bitstream/" class="md-tabs__link">
        FPGA
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../lego/log/misc/" class="md-tabs__link">
        LegoOS
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Yizhou Shan&#39;s Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lastweek/lastweek.github.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M105.2 24.9c-3.1-8.9-15.7-8.9-18.9 0L29.8 199.7h132c-.1 0-56.6-174.8-56.6-174.8zM.9 287.7c-2.6 8 .3 16.9 7.1 22l247.9 184-226.2-294zm160.8-88 94.3 294 94.3-294zm349.4 88-28.8-88-226.3 294 247.9-184c6.9-5.1 9.7-14 7.2-22zM425.7 24.9c-3.1-8.9-15.7-8.9-18.9 0l-56.6 174.8h132z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Notes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Notes" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../virt/" class="md-nav__link">
        Modern Virtualization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cache_coherence/" class="md-nav__link">
        Practical Cache Coherence
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamic_linking/" class="md-nav__link">
        Dynamic Linking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dcn/" class="md-nav__link">
        Data Center Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../packet-sched/" class="md-nav__link">
        Switch Buffering and Packet Scheduling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sysml/" class="md-nav__link">
        SysML
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cryptography/" class="md-nav__link">
        Cryptography
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cryptocurrency/" class="md-nav__link">
        Cryptocurrency
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware_pl/" class="md-nav__link">
        Hardware Design Languages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../paper_perf_shadows/" class="md-nav__link">
        Performance-Shadows
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/essential/" class="md-nav__link">
        Essential
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../misc/cheatsheet/" class="md-nav__link">
        Cheatsheet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/20200404-on-read-once/" class="md-nav__link">
        On Read Once and Compiler Optimization
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Code
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/summary/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" checked>
      
      <label class="md-nav__link" for="__nav_3_2">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Linux Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../fork/" class="md-nav__link">
        Linux fork/switch_to
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Linux RCU
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Linux RCU
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-rcu" class="md-nav__link">
    How to use RCU?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-reading" class="md-nav__link">
    Code Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../linux-boot/" class="md-nav__link">
        Linux Boot Sequence
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/" class="md-nav__link">
        Linux Trace and Profile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rmap/" class="md-nav__link">
        Linux Reverse Mapping
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../userfaultfd/" class="md-nav__link">
        Linux Userfaultfd
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../cgroup-swap/" class="md-nav__link">
        Linux Cgroup and Swap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../xperf/" class="md-nav__link">
        Linux x86 Ring Switch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../linux-x86-fpu/" class="md-nav__link">
        Linux FPU
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../linux-iouring/" class="md-nav__link">
        Linux io_uring
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../linux-resource/" class="md-nav__link">
        Linux Resource
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../proc/" class="md-nav__link">
        Linux Special Files
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kvm-basic/" class="md-nav__link">
        Linux KVM
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../program_advice/" class="md-nav__link">
        Guideline & Advice
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/firmware-softwares/" class="md-nav__link">
        Firmware & Bootloader
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/os/" class="md-nav__link">
        Operating System
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/compilers/" class="md-nav__link">
        Compilers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/unix-tools/" class="md-nav__link">
        Unix Tools
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/virt/" class="md-nav__link">
        Virtualization
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/rdma/" class="md-nav__link">
        DPDK and RDMA
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/20200501-on-graphic-softwares/" class="md-nav__link">
        Graphics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/gpu/" class="md-nav__link">
        GPU
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/fpga/" class="md-nav__link">
        FPGA
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/risc-v/" class="md-nav__link">
        RISC-V
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/dotconfigs/" class="md-nav__link">
        Dot-Configs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../source_code/misc/" class="md-nav__link">
        Misc
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        FPGA
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="FPGA" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          FPGA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/bitstream/" class="md-nav__link">
        Bitstream Explained
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../paper_fpga/" class="md-nav__link">
        Papers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/language/" class="md-nav__link">
        Languages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/vivado/" class="md-nav__link">
        Vivado Notes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/setup_hold/" class="md-nav__link">
        Setup and Hold Time
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../fpga/pr/" class="md-nav__link">
        Partial Reconfiguration
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        LegoOS
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="LegoOS" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          LegoOS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        Log
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Log" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Log
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/log/misc/" class="md-nav__link">
        MISC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/log/test-note/" class="md-nav__link">
        Test Script
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      <label class="md-nav__link" for="__nav_5_2">
        Kernel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kernel" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Kernel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/boot/" class="md-nav__link">
        GRUB2 and Boot
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/kconfig/" class="md-nav__link">
        Kconfig
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/debug/" class="md-nav__link">
        Debug
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/grub/" class="md-nav__link">
        GRUB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/profile/" class="md-nav__link">
        Profile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/profile_strace/" class="md-nav__link">
        Profile strace
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/profile_heatmap/" class="md-nav__link">
        Profile heatmap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/profile_points/" class="md-nav__link">
        Profile points
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/trampoline/" class="md-nav__link">
        Trampoline
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/pagefault_disable/" class="md-nav__link">
        Disable pgfault
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/stop_machine/" class="md-nav__link">
        Stop machine
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/loader/" class="md-nav__link">
        Program Loader
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/vDSO/" class="md-nav__link">
        vDSO
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/vfs/" class="md-nav__link">
        Virtual File System
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/vm/" class="md-nav__link">
        Process Virtual Memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/fpu/" class="md-nav__link">
        x86 FPU
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/irq/" class="md-nav__link">
        IRQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/net_thpool/" class="md-nav__link">
        Network Thpool
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        Syscall
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Syscall" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Syscall
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/facts/" class="md-nav__link">
        Facts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/kernel/profile_strace/" class="md-nav__link">
        strace
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/compat/" class="md-nav__link">
        compat
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/msync/" class="md-nav__link">
        msync()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/mremap/" class="md-nav__link">
        mremap()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/fork/" class="md-nav__link">
        fork()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/getrusage/" class="md-nav__link">
        getrusage()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/syscall/wait_and_exit/" class="md-nav__link">
        wait4 and exit()
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      <label class="md-nav__link" for="__nav_5_4">
        Pcache
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Pcache" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Pcache
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/config/" class="md-nav__link">
        Config
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/sweep/" class="md-nav__link">
        Sweep
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/tlb/" class="md-nav__link">
        TLB Coherence
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/pgtable-lock/" class="md-nav__link">
        PageTable Lock
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/victim/" class="md-nav__link">
        Victim Cache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/virtual_cache/" class="md-nav__link">
        Virtual Cache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/rmap/" class="md-nav__link">
        Reverse Mapping
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/evict_and_ref/" class="md-nav__link">
        Evict and Refcount
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/smp_design/" class="md-nav__link">
        SMP Design
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/pcache/replication/" class="md-nav__link">
        Replication
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      <label class="md-nav__link" for="__nav_5_5">
        Driver
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Driver" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Driver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/driver/pci/" class="md-nav__link">
        PCI
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/driver/ib/" class="md-nav__link">
        Infiniband
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_6" type="checkbox" id="__nav_5_6" >
      
      <label class="md-nav__link" for="__nav_5_6">
        Paper
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_6">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/paper/nmp/" class="md-nav__link">
        NMP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/paper/processor_oom/" class="md-nav__link">
        Processor OOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/paper/genz/" class="md-nav__link">
        Gen-Z
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/paper/replication/" class="md-nav__link">
        Replication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../lego/paper/related/" class="md-nav__link">
        Related
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-rcu" class="md-nav__link">
    How to use RCU?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-reading" class="md-nav__link">
    Code Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/lastweek/lastweek.github.io/edit/master/docs/notes/linux/linux-rcu.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="linux-rcu">Linux RCU<a class="headerlink" href="#linux-rcu" title="Permanent link">&para;</a></h1>
<details class="note"><summary>Version History</summary><table>
<thead>
<tr>
<th align="left">Date</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Oct 23, 2021</td>
<td>Initial</td>
</tr>
</tbody>
</table>
</details>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="https://lwn.net/Articles/262464/">What is RCU, Fundamentally?</a><ul>
<li>This is a great article.</li>
<li>You should really understand the example cases in this article. It could give a better understanding on why RCU works and how to modify your code to use it.</li>
</ul>
</li>
<li><a href="https://pdos.csail.mit.edu/6.828/2017/readings/rcu-decade-later.pdf">RCU Usage In the Linux Kernel: One Decade Later</a></li>
<li><a href="http://blog.foool.net/wp-content/uploads/linuxdocs/RCU.pdf">http://blog.foool.net/wp-content/uploads/linuxdocs/RCU.pdf</a></li>
</ol>
<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<p>RCU is just brilliant but also painfully hard to understand in the first place.
I want to walk through how RCU is actually implemented in the kernel and take some notes.</p>
<p>The <code>synchronize_rcu()</code> is the most interesting function.
By definition, it will only return after making sure no other CPUs are still in the reader side critical section.
In a non-preemptive kernel, it can simply wait all other CPUs to have a context switch.
But in a preemptive kernel, it becomes more complicated.</p>
<p>Just a naive thought, one can use some sort of per-cpu variable to track whether
a CPU has a context switch during the  <code>synchronize_rcu()</code> call.</p>
<p>In the latest code (v5.9), this is the impl.
So it appears <code>synchronize_rcu_expedited()</code> will speedup the grace period by
forcefully send IPI to other CPUs to enforce context switch.
The normal wait is the <code>wait_rcu_gp()</code> function. Very complicated function.
It has several callback etc. But I guess it has to has a way to check
other CPUs&rsquo; status, right? To know whether other CPUs have context switched or so on.
Anymore, I didn&rsquo;t expect to understand RCU impl in just few hours.
I should use this a bit more and read a bit more.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">synchronize_rcu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rcu_blocking_is_gp</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// Context allows vacuous grace periods.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rcu_gp_is_expedited</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="n">synchronize_rcu_expedited</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">wait_rcu_gp</span><span class="p">(</span><span class="n">call_rcu</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Ah, I think the RCU usage paper gives a nice high-level summary on Linux&rsquo;s implementaiton:</p>
<ul>
<li>In practice Linux implements <code>synchronize_rcu</code> by waiting for all CPUs in the system to pass through a context switch, instead of scheduling a thread on each CPU. This design optimizes the Linux RCU implementation for low-cost RCU critical sections, but at the cost of delaying synchronize_rcu callers longer than necessary. In principle, a writer waiting for a particular reader need only wait for that reader to complete an RCU critical section. The reader, however, must communicate to the writer that the RCU critical section is complete. The Linux RCU implementation essentially batches reader-to-writer communication by waiting for context switches. When possible, writers can use an asynchronous version of <code>synchronize_rcu</code>, <code>call_rcu</code>, that will asynchronously invokes a specified callback after all CPUs have passed through at least one context switch.</li>
<li>The Linux RCU implementation tries to amortize the cost of detecting context switches over many <code>synchronize_rcu</code> and <code>call_rcu</code> operations. <strong>Detecting context switches requires maintaining state shared between CPUs</strong>. A CPU must update state, which other CPUs read, that indicate it executed a context switch. Updating shared state can be costly, because it causes other CPUs to cache miss. <strong>RCU reduces this cost by reporting per-CPU state roughly once per scheduling clock tick</strong>. If the kernel calls <code>synchronize_rcu</code> and <code>call_rcu</code> many times in that period, RCU will have reduced the average cost of each call to <code>synchronize_rcu</code> and <code>call_rcu</code> at the cost of higher latency. Linux can satisfy more than 1,000 calls to <code>synchronize_rcu</code> and <code>call_rcu</code> in a single batch [22]. For latency sensitive kernel subsystems, RCU provides expedited synchronization functions that execute without waiting for all CPUs to execute multiple context switches.</li>
</ul>
<h2 id="how-to-use-rcu">How to use RCU?<a class="headerlink" href="#how-to-use-rcu" title="Permanent link">&para;</a></h2>
<p>After reading several RCU code snippets, it is not hard to notice that they have a common theme.
Especicially for the List related operations, there is no final atomic modification in the updater thread.
This atomic update serves as a barrier. The reaeders rely on this pointer to grab info pointed by this pointer.
This is very important trick to leverage RCU. If you code is not like, you should add this level of indirection,
package your data behind a pointer and modify the reader to follow the pointer.</p>
<p>Also, the List RCU related operations may seem confusing in the start, because, naturally,
we&rsquo;d think there are so many operations inside list walk, insert and removal, how come they are safe?
The catch is that, usually for readers who are doing list-walk, they only use the <code>next</code> pointer.
So for <code>insert</code> and <code>removal</code>, they only need to gurantee the of <code>next</code>, meaning, they need to make sure that
the list/data is correct (no NULL pointer) for both before and after updaing <code>next</code> pointer.
And this is sufficient for readers!</p>
<p>In all, changing to RCU requires a good understanding on your own logic.
If your data structrue is not packaged, package it behind some pointers.
And make sure the readers integrity can be ensured by relying on this single pointer.</p>
<p>One more thing is Reader Retry. It is obvious that the readers might see stale data.
So it is up to the designers to retry. The designer can rely on the Sequence Lock for this purpose for example.</p>
<p>You can read the RCU usage paper for more suggestions.</p>
<h2 id="code-reading">Code Reading<a class="headerlink" href="#code-reading" title="Permanent link">&para;</a></h2>
<p>This section is my note on the actual codes.
There are two possible implementations: tiny and tree. Tiny is for UP system. Tree is the most standard one. So I will be looking into <code>kernel/rcu/tree.c</code> first</p>
<p>My general approach to new code: 1) look top and bottom of the file.
Top usually defines some importnat global variables.
Bottom usually has the init functions, which could tell us what&rsquo;s going on, what threads are created etc.
Then I scroll up from bottom.</p>
<ul>
<li><code>gp</code> stands for Grace Period</li>
</ul>
<p><strong>Important Data Structrues and Threads</strong></p>
<ul>
<li>One global <code>struct rcu_state</code>. Init by <code>rcu_init_one()</code>. See <code>include/linux/rcu/tree.h</code> for detailed comments.</li>
<li>Per CPU <code>struct rcu_data</code>.</li>
<li><code>struct rcu_node</code></li>
<li>There is thread called <code>rcu_gp_kthread()</code>, comment says this is a kthread that handles grace period. Shouldn&rsquo;t there be one per CPU? Why there is just one though?</li>
</ul>
<p><strong>Initialization</strong></p>
<ul>
<li><code>rcu_init()</code></li>
<li>I saw <code>rcutree_online_cpu()</code> and <code>rcutree_offline_cpu()</code>. The core seems to be the <code>rnp-&gt;ffmask</code>, the <code>ffmask</code>.
  It appears this mask represent the cpu status in RCU subsystem. Pay attention to it later.</li>
<li><code>rcutree_prepare_cpu()</code>: init per-CPU RCU data (<code>rcu_data</code>). I have no idea what those fields in rcu_data are doing. And it is re-loading quite some info from the global <code>rcu_state</code>.</li>
</ul>
<p><strong>Core</strong></p>
<p>It seems <code>rnp-&gt;gp_seq</code> != <code>rdp-&gt;gp_seq</code> means a grace period is started?
Based on various functions, it appears that if they need a grace period, they will invoke the <code>rcu_gp_kthread()</code>!</p>
<p>Inside <code>rcu_gp_kthread()</code> it is just a big loop. It constantly sleeps. Once waken up, it will use <code>rcu_gp_init()</code> to actuallt start a grace period! Quite heavy. The core seems to be <code>rcu_seq_start(&amp;rcu_state.gp_seq);</code>: update the <code>gp_seq</code>, the VERY variable that others use to check grace period. Think this is it. Now I still need to figure out how grace period got integrated into <code>synchronize_rcu</code>.</p>
<p>So inside <code>synchronize_rcu()</code>, the main thing is <code>wait_rcu_gp()</code>, seems waiting for the grace period to finish. Ah we are getting close. The <code>wait_rcu_gp()</code> takes the <code>call_rcu()</code> function as a parameter. The <code>call_rcu()</code> queues an RCU callback for invocation AFTER a grace period (YES! Makes sense. So now, we know who is creating grace period - that above kthread and where we are waiting).</p>
<p>For <code>__wait_rcu_gp()</code>, I don&rsquo;t understand much other than this complicated function callback.
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">crcu_array</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span><span class="o">&amp;</span><span class="n">rs_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">wakeme_after_rcu</span><span class="p">);</span><span class="w"></span>
</code></pre></div></p>
<p>Note, if we are calling from <code>synchronize_rcu</code>, this <code>crcu_array[i]</code> is essentially <code>call_rcu()</code> function. So the above callback essentially becomes:
<div class="highlight"><pre><span></span><code><span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">wakeme_after_rcu</span><span class="p">);</span><span class="w"></span>
</code></pre></div></p>
<p>In <code>__call_rcu</code>, I think the core is the following couple lines. It packages the incoming function callback and enqueue into the rcu segcblist:
<div class="highlight"><pre><span></span><code><span class="n">__call_rcu</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">head</span><span class="o">-&gt;</span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">rcu_segcblist_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cblist</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
</code></pre></div></p>
<p>As I understand it, <code>__call_rcu</code> register a callback function into a seglist framework.
And in the following func, the <code>rsclp-&gt;tails</code> caught my eye. Someone MUST deal with this array.
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">rcu_segcblist_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="nc">rcu_segcblist</span><span class="w"> </span><span class="o">*</span><span class="n">rsclp</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="k">struct</span> <span class="nc">rcu_head</span><span class="w"> </span><span class="o">*</span><span class="n">rhp</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rcu_segcblist_inc_len</span><span class="p">(</span><span class="n">rsclp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rcu_segcblist_inc_seglen</span><span class="p">(</span><span class="n">rsclp</span><span class="p">,</span><span class="w"> </span><span class="n">RCU_NEXT_TAIL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">WRITE_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">rsclp</span><span class="o">-&gt;</span><span class="n">tails</span><span class="p">[</span><span class="n">RCU_NEXT_TAIL</span><span class="p">],</span><span class="w"> </span><span class="n">rhp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">WRITE_ONCE</span><span class="p">(</span><span class="n">rsclp</span><span class="o">-&gt;</span><span class="n">tails</span><span class="p">[</span><span class="n">RCU_NEXT_TAIL</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rhp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>Since someone MUST call these callbacks after grace period.
If we found that place, we will know which code represent the end of grace period.
So I search for <code>func</code> and <code>tails</code>. Bang, we are in <code>rcu_do_batch()</code>, which is called by <code>rcu_core()</code> only, which is called by <code>rcu_cpu_kthread()</code></p>
<p>This <code>rcu_cpu_kthread()</code> is different from the <code>rcu_gp_thread</code> (the one who START grace period). They register this function via the <code>smpboot_regsiter_percpu_thread()</code> framework.
Well, this framework creates a thread repeatly calling the registered callbacks.
I eventually looks at the <code>thread_should_run</code> -&gt; <code>rcu_cpu_has_work</code> -&gt; <code>invoke_rcu_core_kthread()</code> -&gt; <code>invoke_rcu_core()</code>.
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Wake up this CPU&#39;s rcuc kthread to do RCU core processing.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke_rcu_core</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()))</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_softirq</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">raise_softirq</span><span class="p">(</span><span class="n">RCU_SOFTIRQ</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">invoke_rcu_core_kthread</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>I mean, seems quite close, right? It is used to wake up rcuc kthreads to do RCU core processing, which essentially are those callbacks that are supposed to be called after grace period. Then I started searching who called <code>invoke_rcu_core()</code>.</p>
<p>The cloest caller I found is this.
The description is inline with what the RCU usage paper said. They do batch processing
every scheduling-tick. Pay attention to  <code>rcu_pending()</code>.
So <code>rcu_pending()</code> checks if there is any RCU-related work to be done. If so, call <code>invoke_rcu_core()</code> to do all the callbacks. I mean, <code>rcu_pending()</code> should mean a grace period has ended, right?
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * This function is invoked from each scheduling-clock interrupt,</span>
<span class="cm"> * and checks to see if this CPU is in a non-context-switch quiescent</span>
<span class="cm"> * state, for example, user mode or idle loop.  It also schedules RCU</span>
<span class="cm"> * core processing.  If the current grace period has gone on too long,</span>
<span class="cm"> * it will ask the scheduler to manufacture a context switch for the sole</span>
<span class="cm"> * purpose of providing the needed quiescent state.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">rcu_sched_clock_irq</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rcu_pending</span><span class="p">(</span><span class="n">user</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">invoke_rcu_core</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>Go for <code>rcu_pending()</code>.
Though it checks grace period but it appears it does not check whether it ended or not.
Maybe my fundamental understanding about the grace period impl is not correct.
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Check to see if there is any immediate RCU-related work to be done by</span>
<span class="cm"> * the current CPU, returning 1 if so and zero otherwise.  The checks are</span>
<span class="cm"> * in order of increasing expense: checks that can be carried out against</span>
<span class="cm"> * CPU-local state are performed first.  However, we must check for CPU</span>
<span class="cm"> * stalls first, else we might not get a chance.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">rcu_pending</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="n">gp_in_progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rcu_gp_in_progress</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">..</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * Return true if an RCU grace period is in progress.  The READ_ONCE()s</span>
<span class="cm"> * permit this function to be invoked without holding the root rcu_node</span>
<span class="cm"> * structure&#39;s -&gt;lock, but of course results can be subject to change.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">rcu_gp_in_progress</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rcu_seq_state</span><span class="p">(</span><span class="n">rcu_seq_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rcu_state</span><span class="p">.</span><span class="n">gp_seq</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<p>I must have missed a lot important connections, most importantly, 
how they ensure all CPUs have experienced a context switch 
and how exactly grace period is used here, meaning how it enforce things?
I do see a lot of callback registerd and those callbacks usually are very simple,
mostly do the <code>complete()</code> call.</p>
<p>And the whole RCU subsystem has several data structures, <code>rcu_data</code>, <code>rcu_node</code> etc.
And several threads, <code>rcu_gp_kthread()</code>, who advances grace period. <code>rcu_cpu_kthread()</code> 
who actually run the registered callbacks from call_rcu/synchronize_rcu.</p>
<p>Anyway this is conclusion for me, for now (Oct 24, 2021). I might look into the userspace impl later. Nonetheless the core of <code>synchronize_rcu()</code> is fairly simple: make sure a grace period has gone (e.g., all other CPUs have context switched). But a real efficient implementation is quite complicated, esp in Linux kernel.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 24, 2021</span>
      
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="http://lastweek.io/notes/linux/linux-rcu/",this.page.identifier="notes/linux/linux-rcu/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//lastweek-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../fork/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Linux fork/switch_to" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Linux fork/switch_to
            </div>
          </div>
        </a>
      
      
        
        <a href="../linux-boot/" class="md-footer__link md-footer__link--next" aria-label="Next: Linux Boot Sequence" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Linux Boot Sequence
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["instant", "tabs", "navigation.tabs", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.409db549.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.756773cc.min.js"></script>
      
    
  </body>
</html>