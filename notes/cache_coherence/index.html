
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <link rel="canonical" href="http://lastweek.io/notes/cache_coherence/">
      
      
        <link rel="prev" href="../virt/">
      
      
        <link rel="next" href="../resource-disaggregation-spectrum/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Practical Cache Coherence - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime+Bold:300,300i,400,400i,700,700i%7CCourier+Prime+Bold:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Courier Prime Bold";--md-code-font:"Courier Prime Bold"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practical-cache-coherence" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Yizhou Shan&#39;s Home Page" class="md-header__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Yizhou Shan's Home Page
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Practical Cache Coherence
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/lastweek/lastweek.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ssd/" class="md-tabs__link">
          
  
  
  Notes

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../source_code/summary/" class="md-tabs__link">
          
  
  
  Code

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../fpga/bitstream/" class="md-tabs__link">
          
  
  
  FPGA

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../lego/log/misc/" class="md-tabs__link">
          
  
  
  LegoOS

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Yizhou Shan&#39;s Home Page" class="md-nav__button md-logo" aria-label="Yizhou Shan's Home Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Yizhou Shan's Home Page
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lastweek/lastweek.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Notes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ssd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SSD 101
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CXL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is CXL?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MLIR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is MLIR?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../virt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Modern Virtualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Practical Cache Coherence
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Practical Cache Coherence
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary-and-thoughs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary and Thoughs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Thoughs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implication-for-synchronization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implication for Synchronization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implication-for-on-chip-bandwidth-and-numa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implication for On-Chip Bandwidth and NUMA
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#readings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Readings
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-study" class="md-nav__link">
    <span class="md-ellipsis">
      
        Case Study
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Case Study">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#intel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Intel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amd" class="md-nav__link">
    <span class="md-ellipsis">
      
        AMD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arm" class="md-nav__link">
    <span class="md-ellipsis">
      
        ARM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opencapi-and-ccix" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenCAPI and CCIX
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cxl" class="md-nav__link">
    <span class="md-ellipsis">
      
        CXL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openpiton" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenPiton
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fpga" class="md-nav__link">
    <span class="md-ellipsis">
      
        FPGA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formal-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Formal Verification
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resource-disaggregation-spectrum/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Resource Disaggregation Design Spectrums
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dist-xact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Transactions and Databases
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dynamic_linking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dynamic Linking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dcn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Center Networking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packet-sched/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Switch Buffering and Packet Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sysml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SysML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cryptography
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptocurrency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cryptocurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware_pl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hardware Design Languages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../paper_perf_shadows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance-Shadows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/essential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Essential
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/cheatsheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cheatsheet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/20200404-on-read-once/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    On Read Once and Compiler Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-function-trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Dump Function Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux fork/switch_to
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-rcu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux RCU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-completion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Completion/swait
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-workqueue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux workqueue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-linker-script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Linker Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-boot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Boot Sequence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Trace and Profile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Reverse Mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../userfaultfd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Userfaultfd
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cgroup-swap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Cgroup and Swap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xperf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux x86 Ring Switch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-x86-fpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux FPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-iouring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux io_uring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/linux-resource/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Resource
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Special Files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kvm-basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux KVM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linux/rust.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Rust
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Go
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Go
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../go/golang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learn Go
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../go/gvisor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gVisor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Rust
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Rust
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rust/rust/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learn Rust
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rust/firecracker.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firecracker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/rdma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPDK and RDMA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../program_advice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guideline & Advice
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/firmware-softwares/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Firmware & Bootloader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operating System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/compilers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compilers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/unix-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unix Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/virt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/20200501-on-graphic-softwares/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graphics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/fpga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FPGA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/risc-v/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RISC-V
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/dotconfigs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dot-Configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    FPGA
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    FPGA
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fpga/bitstream/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bitstream Explained
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../paper_fpga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Papers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fpga/language/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Languages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fpga/vivado/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vivado Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fpga/setup_hold/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup and Hold Time
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fpga/pr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Partial Reconfiguration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    LegoOS
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    LegoOS
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Log
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Log
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/log/misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MISC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/log/test-note/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kernel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kernel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/boot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GRUB2 and Boot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/kconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kconfig
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debug
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/grub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GRUB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/profile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/profile_strace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile strace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/profile_heatmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile heatmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/profile_points/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile points
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/trampoline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Trampoline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/pagefault_disable/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Disable pgfault
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/stop_machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stop machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Program Loader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/vDSO/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vDSO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/vfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual File System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Virtual Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/fpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    x86 FPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/irq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IRQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/net_thpool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Thpool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Syscall
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Syscall
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/facts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Facts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/kernel/profile_strace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Profile strace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/compat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    compat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/msync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    msync()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/mremap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    mremap()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fork()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/getrusage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    getrusage()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/syscall/wait_and_exit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    wait4 and exit()
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pcache
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pcache
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/sweep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sweep
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/tlb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TLB Coherence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/pgtable-lock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PageTable Lock
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/victim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Victim Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/virtual_cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Virtual Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/rmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reverse Mapping
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/evict_and_ref/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evict and Refcount
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/smp_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SMP Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/pcache/replication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Replication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Driver
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Driver
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/driver/pci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PCI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/driver/ib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Infiniband
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Paper
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Paper
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/paper/nmp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NMP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/paper/processor_oom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processor OOM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/paper/genz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gen-Z
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/paper/replication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Replication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lego/paper/related/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Related
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary-and-thoughs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary and Thoughs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Thoughs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implication-for-synchronization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implication for Synchronization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implication-for-on-chip-bandwidth-and-numa" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implication for On-Chip Bandwidth and NUMA
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#readings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Readings
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-study" class="md-nav__link">
    <span class="md-ellipsis">
      
        Case Study
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Case Study">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#intel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Intel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amd" class="md-nav__link">
    <span class="md-ellipsis">
      
        AMD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arm" class="md-nav__link">
    <span class="md-ellipsis">
      
        ARM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opencapi-and-ccix" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenCAPI and CCIX
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cxl" class="md-nav__link">
    <span class="md-ellipsis">
      
        CXL
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openpiton" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenPiton
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fpga" class="md-nav__link">
    <span class="md-ellipsis">
      
        FPGA
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formal-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Formal Verification
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="practical-cache-coherence">Practical Cache Coherence<a class="headerlink" href="#practical-cache-coherence" title="Permanent link">&para;</a></h1>
<details class="note">
<summary>Version History</summary>
<table>
<thead>
<tr>
<th style="text-align: left;">Date</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Jul 2, 2021</td>
<td>add implication discussion</td>
</tr>
<tr>
<td style="text-align: left;">Feb 24, 2020</td>
<td>Kobe and Gigi. Add Intel CCIP.</td>
</tr>
<tr>
<td style="text-align: left;">Oct 3, 2019</td>
<td>Add FPGA related discussion</td>
</tr>
<tr>
<td style="text-align: left;">Jun 28, 2019</td>
<td>Initial draft</td>
</tr>
</tbody>
</table>
</details>
<p><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@16.0.1/assets/svg/1f376.svg" title=":sake:" /></p>
<ul>
<li><a href="#practical-cache-coherence">Practical Cache Coherence</a></li>
<li><a href="#summary-and-thoughs">Summary and Thoughs</a><ul>
<li><a href="#implication-for-synchronization">Implication for Synchronization</a></li>
<li><a href="#implication-for-on-chip-bandwidth-and-numa">Implication for On-Chip Bandwidth and NUMA</a></li>
</ul>
</li>
<li><a href="#readings">Readings</a></li>
<li><a href="#case-study">Case Study</a><ul>
<li><a href="#intel">Intel</a></li>
<li><a href="#amd">AMD</a></li>
<li><a href="#arm">ARM</a></li>
<li><a href="#opencapi-and-ccix">OpenCAPI and CCIX</a></li>
<li><a href="#CXL">CXL</a></li>
<li><a href="#openpiton">OpenPiton</a></li>
<li><a href="#fpga">FPGA</a></li>
<li><a href="#formal-verification">Formal Verification</a></li>
</ul>
</li>
</ul>
<p>TL;DR.
This is a note on how cache coherence protocols are implemented in real hardware.
This note is NOT just about acadamic new ideas.</p>
<p>I started this when I was having a hard time optimizing <code>lock delegation</code>,
which relies on fine-tuning cache coherence to achieve extremely fast locks.</p>
<h2 id="summary-and-thoughs">Summary and Thoughs<a class="headerlink" href="#summary-and-thoughs" title="Permanent link">&para;</a></h2>
<p>The textbooks tough us the basic concept of MESI. And specific algorithms
like <em>snoop</em> and <em>directory.</em> What usually missing is the implementation
details when it comes to: 1) how to solve conflicts, 2) what if there is no single shared bus.</p>
<p>Modern processors have <em>Network-on-Chip (NoC)</em>.
Within the die, cores, cache slices (large LLC is usually divided into slices),
memory controllers and other components are connected via
an on-chip network (e.g., a ring in old-generation Xeon, or a mesh in Xeon Scalable).
This architecture is no different from connecting a set of distributed servers.
The NoC has its own protocol (I guess ranging from L1 to L3, must be reliable data delivery).
And all on-chip components communicate by sending/receiving packets.
There is no central coordinator.</p>
<p><em>What this means for cache coherence?</em></p>
<p>Cache requests generated by MESI protocols should appear <strong>atomic</strong> to requesting cores.
Given the distributed nature of all resources (via NoC), those cache requests
are implemented like <strong>distributed transactions</strong>!
This brings great complexity to a performant and correct cache coherence implementation.
Hardware is much much faster than a set of distributed nodes. Besides, it cannot
implement arbitrary logic, whatever protocol they design has a tight time budget.</p>
<p>For example, Intel uses the MESIF cache coherence protocol.
In their implementation,
when a core made a <em>read</em> to an invalid line, the corresponding cache
will perform a <em>cache read transaction</em> to get the data from
either other caches or memory. This transaction consists of multiple
steps, such as: send requests, collect responses, and finally send ACKs.</p>
<p>Those transactions will conflict if multiple reads and writes
happen at the same time. <strong>Someone has to resolve it</strong>.
It can be resolved by different cache controllers, or by a single
serialization point like home agent.</p>
<p>Just like you can have many ways to implement transactions
for distributed systems, there are also many ways to do
cache coherence transactions. And there are many.</p>
<p>Atomic Read-Modify-Write (RMW) instructions will make cache coherence
implementations even more complex. Those instructions include
<code>read-and-inc</code>, <code>test-and-set</code>, and <code>lock;</code>-prefixed.
I think, there will some &ldquo;lock the bus&rdquo;, or &ldquo;locked state&rdquo; at the
home agent per cache line. Having atomic RMW instructions
will add more complexity to the overall transaction design.</p>
<p>While reading Intel related cache coherence diagrams/transactions,
you might find many different descriptions. Don&rsquo;t panic. They are
just different implementations proposed by Intel. Different
implementations will have different trade-offs and performance,
you can check <a href="https://frankdenneman.nl/2016/07/11/numa-deep-dive-part-3-cache-coherency/">Frank&rsquo;s post</a>
for more details.</p>
<p>Directory-based cache coherence protocol and implementation will
be the future for multicore machines. Because it incurs much less
coherence traffic than snoop-based ones, thus more scalable.
The trend is confirmed by recent Intel UPI directory-based approach.</p>
<p>Related readings:</p>
<ul>
<li>[1]: <a href="http://www.cis.upenn.edu/acg/papers/cacm12_why_coherence.pdf">Why On-Chip Cache Coherence Is Here to Stay</a></li>
<li>[2]: <a href="https://www.realworldtech.com/qpi-evolved/3/">QPI 1.1 Invovled</a></li>
<li>[3]: <a href="http://research.cs.wisc.edu/multifacet/papers/isca99_multicast_talk_pdf.pdf">Paper: Multicast Snooping: A New Coherence Method Using a Multicast Address Network, ISCA &lsquo;99</a></li>
<li>[4]: <a href="https://www.cis.upenn.edu/~milom/papers/isca03_destination_set_prediction.pdf">Paper: Using Destination-Set Prediction to Improve the Latency/Bandwidth Tradeoff in Shared-Memory Multiprocessors, ISCA&lsquo;03</a></li>
<li>[5]: The trade-off: <img alt="img_1" src="../cache_coherence_img1.png" /></li>
</ul>
<p>Left questions:
- Do cache coherence implementations ensure <strong>fairness</strong> among cores?</p>
<h3 id="implication-for-synchronization">Implication for Synchronization<a class="headerlink" href="#implication-for-synchronization" title="Permanent link">&para;</a></h3>
<p>Synchronization code (e.g., locking code) has deep relation with cache coherence and memory consistency.
A lot optimizations are playing with certain cache coherence protocols.
For example, a locking primitive may want to first read the lock then try to atomically change its
value. By doing so, the first read will not trigger any cache invalidation to other cores, hence
save latency and on-chip bandwidth.</p>
<p>As for memory consistency, it affects how many barriers should be inserted
and whether a release/acquire semantic should be used.</p>
<p>Anyway, if you are implementing synchronization primitive, pay attention to cache coherence.
Read the
<a href="https://software.intel.com/en-us/forums/intel-moderncode-for-parallel-architectures/topic/700477">discussion</a>
posted by Dr. Bandwidth, especially this one on
<a href="http://lastweek.io/pubs/misc/dr-bandwidth-core2core-cache-coherence-explain.pdf">cache coherence flows on a procuder-consumer case</a>.
It is very useful if you are trying to implement high-performance spinlocks and concurrency data structures.</p>
<h3 id="implication-for-on-chip-bandwidth-and-numa">Implication for On-Chip Bandwidth and NUMA<a class="headerlink" href="#implication-for-on-chip-bandwidth-and-numa" title="Permanent link">&para;</a></h3>
<p>Cache coherence consumes a LOT on-chip bandwidth.
Think about all the messages it will send for a single transation.
And this transaction can be easily triggered by normal read/write.
So the cache coherent protocol end up using a lot on-chip bandwidth.</p>
<p>This is problematic for two reasons:
a) the NoC bus/ring is shared. It will affect other traffic hence performance.
b) In a NUMA architecture, the interconnection between CPU dies is responsible for a lot things
like data transfer, cache coherence traffic, and other misc traffic. If cache coherence uses
a lot, there is little room for others.</p>
<p>Many have complained this.</p>
<p>So what&rsquo;s the mitigation?
The first try is to move from Snoop to Directory so to avoid excessive traffic.
Some sort of centralized coordinator could resolve conflicts therefore save tons of traffic.
Intel&rsquo;s cache coherence protocol has involved for this direction as well.
Other measures? I don&rsquo;t know.</p>
<h2 id="readings">Readings<a class="headerlink" href="#readings" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.455.4198&amp;rep=rep1&amp;type=pdf">The Architecture of the Nehalem Processor and Nehalem-EP SMP Platforms</a>, chapter 5.2 Cache-Coherence Protocol for Multi-Processors.</li>
<li><a href="https://software.intel.com/sites/products/collateral/hpc/vtune/performance_analysis_guide.pdf">Intel: Performance Analysis Guide for Intel Core i7 Processor and Intel Xeon 5500 processors</a></li>
<li><a href="http://lastweek.io/pubs/misc/dr-bandwidth-core2core-cache-coherence-explain.pdf">Dr.Bandwidth on Core2Core cache coherence flows when running producer-consumer type of workload.</a>. 100% recommended.</li>
<li><a href="https://frankdenneman.nl/2016/07/11/numa-deep-dive-part-3-cache-coherency/">Blog: NUMA Deep Dive Part 3: Cache Coherency</a><ul>
<li>The BEST blog I&rsquo;ve seen on the topic of <code>Intel snoop models</code>.</li>
<li>Intel is using MESIF cache coherence protocol, but it has multiple cache coherence implementations.
  The first one is <code>Source Snoop</code> (or <code>Early Snoop</code>), which is more like a traditional snoop-based
  cache coherence implementation. Upon miss, the caching agent will broadcast to other agents.
  The second one is <code>Home Snoop</code>, which is more like a directory-based cache coherence implementation.
  Upon miss, the caching agent will contact home agent, and then the home agent will send requests
  to other caching agents who have the requested cache line.
  There are other implementations like Cluster-on-Die.
  Intel UPI gets rid of all this complexity, it is only using directory-based, in the hope to reduce
  cache coherence traffic, which make sense.</li>
<li>Related: <a href="https://software.intel.com/en-us/articles/intel-xeon-processor-e5-2600-v4-product-family-technical-overview">Broadwell EP Snoop Models</a></li>
<li>Related: <a href="https://software.intel.com/en-us/articles/intel-xeon-processor-scalable-family-technical-overview">Skylay UPI</a></li>
</ul>
</li>
<li><a href="https://researchspace.auckland.ac.nz/bitstream/handle/2292/11594/MESIF-2009.pdf?sequence=6">Paper: MESIF: A Two-Hop Cache Coherency Protocol for Point-to-Point Interconnects (2009)__</a><ul>
<li>A MUST read.</li>
<li>This paper has the most extensive description of the MESIF protocol implementation.
  It has many <code>timing diagrams</code> than describe how cache requests actually proceed.
  Those diagrams can help us understand what is needed to finish a cache request.</li>
<li>Their <a href="https://parlab.eecs.berkeley.edu/sites/all/parlab/files/20091029-goodman-ssccp.pdf">slides</a>
  has more timing diagrams.</li>
<li>But do note: the implementation described by this paper is different from
  what <a href="https://www.intel.ca/content/dam/doc/white-paper/quick-path-interconnect-introduction-paper.pdf">Intel QPI</a>
  has in products. The difference is discussed at chapter 4. MESIF and QPI, namely,
  other caching agents will send responses to Home agent rather than to requesting agent.
  QPI relies on Home agent to solve conflict.</li>
<li>Also note: this is just one of the possible implementations to realize MESIF protocol.
  There could be many other ways, e.g., QPI source snooping, QPI home snooping.
  But all of them share the essential and general concepts and ideas.</li>
</ul>
</li>
<li><a href="https://www.elsevier.com/books-and-journals/book-companion/9780128119051">Appendix I: Large-Scale Multiprocessors and Scientific Applications</a>,
  chapter 7 Implementing Cache Coherence.<ul>
<li>This is probably some most insightful discussion about real implementation of cache coherence.
  With the distributed nature and Network-on-Chip, implementing cache coherence in modern
  processors is no different than implementing a distributed transaction protocol.</li>
<li>Cache activities like read miss or write miss have multi-step operations, but they
  need to appear as &ldquo;atomic&rdquo; to users. Put in another way, misses are like transactions,
  they have multiple steps but they must be atomic. They can be retried.</li>
<li>Having directory for cache coherence will make implementation easier. Because
  the place (e.g., L3) where directory resides can serve as the serialization point.
  They can solve write races.</li>
<li><code>Home directory controller</code> and <code>cache controller</code> will exchange messages like a set of distributed machines.
  In fact, with NoC, they are actually distributed system.</li>
</ul>
</li>
<li><a href="https://www.intel.ca/content/dam/doc/white-paper/quick-path-interconnect-introduction-paper.pdf">Intel: An Introduction to the Intel QuickPath Interconnect</a>,
  page 15 MESIF.<ul>
<li><a href="https://www.hotchips.org/wp-content/uploads/hc_archives/hc21/1_sun/HC21.23.1.SystemInterconnectTutorial-Epub/HC21.23.120.Safranek-Intel-QPI.pdf">HotChips slide</a>, has timing diagrams.</li>
<li>It explains the <code>Home Snoop</code> and <code>Source Snoop</code> used by Intel.</li>
<li>Based on their explanation, it seems both <code>Home Snoop</code> and <code>Source Snoop</code> are using a combination of
    snoop and directory. The Processor#4 (pg 17 and 18) maintains the directory.</li>
<li>And this is a perfect demonstration of the details described in <a href="https://www.elsevier.com/books-and-journals/book-companion/9780128119051">Appendix I: Large-Scale Multiprocessors and Scientific Applications</a>.</li>
<li>Related patent: <a href="https://patents.google.com/patent/US20150081977">Extending a cache coherency snoop broadcast protocol with directory information</a></li>
</ul>
</li>
<li><a href="http://research.cs.wisc.edu/multifacet/papers/isca99_multicast_talk_pdf.pdf">Paper: Multicast Snooping: A New Coherence Method Using a Multicast Address Network, ISCA &lsquo;99</a><ul>
<li>A hybrid snoop and directory cache coherence implementation. The insight is snoop
  cause too much bandwidth, directory incurs longer latency.</li>
<li>So this paper proposed <code>Multicast snoop</code>, where it multicasts coherence transactions
  to selected processors, lowering the address bandwidth required for snooping.</li>
</ul>
</li>
<li><a href="http://www.cis.upenn.edu/acg/papers/cacm12_why_coherence.pdf">Paper: Why On-Chip Cache Coherence Is Here to Stay, Communications of ACM&lsquo;02</a><ul>
<li>This paper discusses why cache coherence can scale. A nice read.</li>
<li>R1: Coherences interconnection network traffic per miss scales
      when precisely tracking sharers. (Okay increased directory bits,
  what about those storage cost? See R2).</li>
<li>R2: Hierarchy combined with inclusion enables efficient scaling
      of the storage cost for exact encoding of sharers.</li>
<li>R3: private evictions should send explicit messages to shared cache
      to enable precise tracking. Thus the recall (<em>back invalidation</em>) traffic can be
  reduced when shared cache is evicting (assume inclusion cache).</li>
<li>R4: Latencies of cache request can be amortized.</li>
</ul>
</li>
<li><a href="https://www.amazon.com/Parallel-Computer-Organization-Design-Professor/dp/0521886759">Book: Parallel Computer Organization and Design</a>, Chapter 7.<ul>
<li>Links coherence and consistency together. This chapter uses detailed graphs to show
  how different cache coherence implementations affect consistency.</li>
</ul>
</li>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.225.9278&amp;rep=rep1&amp;type=pdf">Book: A Primer on Memory Consistency and Cache Coherence</a><ul>
<li>Best book for this topic.</li>
</ul>
</li>
<li><a href="https://software.intel.com/en-us/forums/intel-moderncode-for-parallel-architectures/topic/700477">Dr.Bandwidth on explaining core-to-core communication transactions!</a><ul>
<li>Seriously, it&rsquo;s so good!</li>
<li>Although, I just feel there are so many unpublished details about the exact coherence transactions.
  Dr.Bandwidth himself used a lot &ldquo;maybe&rdquo;, and listed possible actions.</li>
</ul>
</li>
<li><a href="http://www.mavam.com/lance/publications/tcc_ISCA04.pdf">Transactional Memory Coherence and Consistency, ISCA&lsquo;04</a></li>
<li><a href="http://www.mavam.com/lance/publications/tcc_ASPLOS04.pdf">Programming with Transactional Coherence and Consistency (TCC)</a><ul>
<li><a href="http://www.mavam.com/lance/publications/tcc_ASPLOS04Talk.pdf">Slide1</a></li>
<li>Awarded the most influential paper at ISCA 2019. I took a read today (Jul 21, 2019).</li>
<li>I feels like it&rsquo;s using the &ldquo;batch&rdquo; optimization for all time. The TCC design,
  kind of combines both cache coherence and memory consistency: how transactions
  commit or orders, determins the coherence and consistency.</li>
<li>It seems the load/store speculative execution used in their context is so similar
  to what Dr.Bandwidth said about Intel&rsquo;s implementation. Basically, the processor
  might read some data from L1/L2 and continue execution, but there is a chance,
  that the data is modifed by others, and the L3 caching agent or home agent
  could decide to revoke it. Once receiving such revoke message,
  the processor must cancel all executions that use the speculatively read data. </li>
<li>It mentions couple Thread-Level Speculation papers, I think they should on this topic.</li>
</ul>
</li>
</ul>
<h2 id="case-study">Case Study<a class="headerlink" href="#case-study" title="Permanent link">&para;</a></h2>
<h3 id="intel">Intel<a class="headerlink" href="#intel" title="Permanent link">&para;</a></h3>
<p><strong>Misc Facts.</strong></p>
<ul>
<li>Intel Caching Agent (Cbox) is per core (or per LLC slice). Intel Home Agent is per memory controller.<ul>
<li>&ldquo;The LLC coherence engine (CBo) manages the interface between the core and the last
level cache (LLC). All core transactions that access the LLC are directed from the core
to a CBo via the ring interconnect. The CBo is responsible for managing data delivery
from the LLC to the requesting core. It is also responsible for maintaining coherence
between the cores within the socket that share the LLC; generating snoops and
collecting snoop responses from the local cores when the MESIF protocol requires it.&rdquo;</li>
<li>&ldquo;Every physical memory address in the system is uniquely associated with a single Cbox
  instance via a proprietary hashing algorithm that is designed to keep the distribution of
  traffic across the CBox instances relatively uniform for a wide range of possible address patterns.&rdquo;</li>
<li>Read more <a href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/xeon-e5-2600-v2-uncore-manual.pdf">here, chapter 2.3</a>.</li>
<li>Starting from Intel UPI, Caching Agent and Home Agent are combined as CHA.</li>
</ul>
</li>
<li>A good <a href="https://www.realworldtech.com/qpi-evolved/3/">discussion</a> about why QPI gradually drop <code>Source Snoop</code> and solely use <code>Home Snoop</code>.<ul>
<li>The motivation is scalability. It turns out the new UPI only supports directory-based protocol.</li>
<li>This makes sense because 1) inter socket bandwidth is precious, 2) snoop will consume a lot bandwidth.</li>
</ul>
</li>
<li>Intel UPI is using directory-based home snoop coherency protocol<ul>
<li><a href="https://software.intel.com/en-us/articles/intel-xeon-processor-scalable-family-technical-overview">Intel Xeon Processor Scalable Family Technical Overview</a></li>
</ul>
</li>
<li>To provide sufficient bandwidth, shared caches are typically interleaved
  by addresses with banks physically distributed across the chip.</li>
</ul>
<p><strong>A Transaction Breakdown.</strong></p>
<p>Intel does not disclose too much details about their cache coherence implementations.
The most valuable information is extracted from uncore PMU manuals, and discussions
from Dr. Bandwidth. According to Dr. Bandwidth, the Intel CPU could dynamically
adapt its coherence strategy during runtime according to workload. There won&rsquo;t
be one fixed cache coherence implementation, there will be many. It depends on
workload which one is used at runtime.</p>
<p>What happens when a core tries to access a cache line?
A detailed cache protocl breakdown derived from Dr.Bandwidth&rsquo;s comment.</p>
<ul>
<li>Physical addresses are uniquely hashed into L3 slices. That means each individual
  physical address belongs to a L3 slice, and also belongs to a home agent.</li>
<li>Upon L2 miss, it will send requests to corresponding L3 slice. If the L3 slice
  is in the local socket, the request can be delievered within the same socket.
  If the L3 slice belongs to another remote socket, the L2 miss request will
  be sent over QPI/UPI. Also note that the L2 controller will not send snoop requests.
  (This is answering the question of &ldquo;why using local memory is faster than remote&rdquo;
   from the cache coherence perspective.)</li>
<li>At L3, when received the request from a L2,<ul>
<li>If it&rsquo;s in source snoop model, it will send <code>snoop messages</code> to other sockets.</li>
<li>If it&rsquo;s in home snoop model, it will send <code>read message</code> to other sockets.
  The another socket will generate snoop and collect responses. (R3QPI or home?)</li>
<li>Quote Dr. Bandwidth: Maintaining consistency is easier if the data is sent
  to the L3 first, and then to the requesting core, but it is also possible to
  send to both at the same time (e.g., &ldquo;Direct2Core&rdquo;). In recent processors,
  these return paths are chosen dynamically based on undocumented states and
  settings of the processor.</li>
<li>I&rsquo;m not sure who will ACK L2 at last. L3 or home agent? Both are possible.</li>
</ul>
</li>
<li>I think both L3 and home agent have directory information. They know where
  to send snoop/read messages. And both of them can serialize coherence transactions!
  It&rsquo;s just undocumented who is doing what.</li>
<li>In generall, we need to bear the fact that we cannot just figure out how Intel
  cache coherence works underlying. We maybe just need to &ldquo;vaguely&rdquo; know the fact that:<ul>
<li>Both directory and snoop will be used in combination.</li>
<li>L3/home agent will serialize conflicting transactions</li>
<li>L3/home agent will send data to requesting core</li>
<li>L3/home agent will send final ACK to requesting L2</li>
<li>A coherence transaction is a multi-step distributed transaction.
  It involes sending requests, serialize conflicts, receiving responses/ACKs.</li>
</ul>
</li>
</ul>
<p>Read the <a href="https://software.intel.com/en-us/forums/intel-moderncode-for-parallel-architectures/topic/700477">discussion</a> posted by Dr. Bandwidth,
especially this one on detailed <a href="http://lastweek.io/pubs/misc/dr-bandwidth-core2core-cache-coherence-explain.pdf">cache coherence flows on a procuder-consumer case</a>, which is essential if you are trying to implement high-performance spinlocks and concurrency data structures.</p>
<h3 id="amd">AMD<a class="headerlink" href="#amd" title="Permanent link">&para;</a></h3>
<ul>
<li>AMD HyperTransport Assit for Cache Coherence<ul>
<li><a href="https://www.hotchips.org/wp-content/uploads/hc_archives/hc14/3_Tue/28_AMD_Hammer_MP_HC_v8.pdf">Slide</a></li>
<li><a href="http://www.hotchips.org/wp-content/uploads/hc_archives/hc21/2_mon/HC21.24.100.ServerSystemsI-Epub/HC21.24.110.Conway-AMD-Magny-Cours.pdf">Slide</a></li>
</ul>
</li>
</ul>
<h3 id="arm">ARM<a class="headerlink" href="#arm" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.arm.com/architectures/system-architectures/amba/documentation?_ga=2.147594999.1797165765.1562530195-129127748.1561485892">AMBA CHI Specifications</a><ul>
<li>This is probabaly the most comprehensive document I&rsquo;ve ever seen about cache coherence.
  Although terms used by ARM differs from the ones used by Intel, still, you can map them.
  Chapter 5 Interconnect Protocol Flows has a lot timing diagrams regarding read/write/atomic
  coherence transactions.</li>
<li>It&rsquo;s a good reference to know, but it would be hard to actually understand the details.</li>
</ul>
</li>
</ul>
<h3 id="opencapi-and-ccix">OpenCAPI and CCIX<a class="headerlink" href="#opencapi-and-ccix" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.wixstatic.com/ugd/0c1418_c6d7ec2210ae47f99f58042df0006c3d.pdf">CCIX White Paper</a></li>
<li><a href="">OpenCAPI</a></li>
</ul>
<h3 id="cxl">CXL<a class="headerlink" href="#cxl" title="Permanent link">&para;</a></h3>
<p>Like OpenCAPI and CCIX, it builds on top of PCIe.
It is intra-server cache coherence protocol.</p>
<p>Not very exciting to me. But it does receive some spotlight recently.</p>
<h3 id="openpiton">OpenPiton<a class="headerlink" href="#openpiton" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://parallel.princeton.edu/openpiton/docs/micro_arch.pdf">OpenPiton Microarchitecture Specification</a><ul>
<li>Directory-based MESI</li>
<li>This spec has detailed coherence message packet format and type. Unfortunately,
  it does not say anything about how they deal with coherence transaction conflicts.
  E.g., some timeline diagrams like Figrue &#8532; in this <a href="https://researchspace.auckland.ac.nz/bitstream/handle/2292/11594/MESIF-2009.pdf?sequence=6">paper</a>.</li>
</ul>
</li>
<li>BYOC: A &ldquo;Bring Your Own Core&rdquo; Framework for Heterogeneous-ISA Research, ASPLOS&lsquo;20</li>
</ul>
<h3 id="fpga">FPGA<a class="headerlink" href="#fpga" title="Permanent link">&para;</a></h3>
<ul>
<li>Analysis and Optimization of I/O Cache Coherency Strategies for SoC-FPGA Device, FPL&lsquo;19</li>
<li>LEAP Shared Memories: Automating the Construction of FPGA Coherent Memories, FCCM&lsquo;14.<ul>
<li>This work is built on their earlier work, which basically add the data caching
  concept to FPGA: using BRAM as L1, on-board DRAM as L2, host or remote DRAM as L3.</li>
<li>In their earlier work, each FPGA application (or bitstream) has a private L1 cache.</li>
<li>In this work, the add MESI coherence to these private L1 caches, as in they can make
  multiple L1 cache cache-coherent.</li>
<li>The techniques and protocols from this paper are similar to the exisiting ones. For example,
  1) they use a global serializing point to serialize transactions, 2) they designed a lot
  messaging types such as INV, RESP and so on.</li>
</ul>
</li>
<li><a href="https://research.vmware.com/publications/project-pberry-fpga-acceleration-for-remote-memory">VMware Research Project PBerry</a><ul>
<li>A very interesting and promising project.</li>
<li>They have this follow up work &ldquo;Rethinking software runtimes for disaggregated memory, ASPLOS&lsquo;21&rdquo;.
  But it is simulation using the HotOS paper idea. The real FPGA has not been built yet.
  They need to know Intel&rsquo;s protocol to build it, which is.. impossible?
  I think it is probably better to use RISC-V.</li>
</ul>
</li>
<li><a href="https://www.intel.com/content/www/us/en/programmable/documentation/bfr1522087299048.html">Intel FPGA PAC</a><ul>
<li>Intel itself is building a FPGA-CPU cache coherent setting. They use the Intel UPI interconnect
  to natually the spectrum. The FPGA shell has some modules to handle this.</li>
</ul>
</li>
<li>
<p><a href="https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/manual/mnl-ias-ccip.pdf">Intel FPGA CCIP</a></p>
<ul>
<li>Maybe the ASPLOS&lsquo;20 Optimus paper is uing CCIP-related research platform?</li>
</ul>
</li>
<li>
<p>Also some pointer chasing related stuff</p>
<ul>
<li><a href="https://users.ece.cmu.edu/~jhoe/distribution/2016/fpga16.pdf">A Study of Pointer-Chasing Performance on Shared-Memory Processor-FPGA Systems, FPGA&lsquo;16</a></li>
</ul>
</li>
</ul>
<h3 id="formal-verification">Formal Verification<a class="headerlink" href="#formal-verification" title="Permanent link">&para;</a></h3>
<p>I remember there are couple works from Princiton doing cache protocol verification.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 5, 2021 20:39:29 UTC">November 5, 2021</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["instant", "tabs", "navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>